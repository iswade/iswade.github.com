
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://iswade.github.io/go/go_libs/">
      
      <link rel="icon" href="../../themes/me.svg">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>Go标准库 - iswade's blog</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
        
          
          
          <meta name="theme-color" content="#ffffff">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../themes/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="preference" data-md-color-primary="white" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#go" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="iswade&#39;s blog" class="md-header__button md-logo" aria-label="iswade's blog" data-md-component="logo">
      
  <img src="../../themes/me.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            iswade's blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Go标准库
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="iswade&#39;s blog" class="md-nav__button md-logo" aria-label="iswade's blog" data-md-component="logo">
      
  <img src="../../themes/me.svg" alt="logo">

    </a>
    iswade's blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        主页
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          数据库
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="数据库" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          数据库
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/adb_nodes/00_index/" class="md-nav__link">
        高级数据库笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../articles/buffer/buffer_details/" class="md-nav__link">
        PostgreSQL缓存
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/crdb/crdb_paper_cn/" class="md-nav__link">
        CockroachDB翻译
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/crdb/crdb_paper/" class="md-nav__link">
        CockroachDB论文
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/taurus_paper_cn/" class="md-nav__link">
        TaurusDB翻译
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/taurus_paper/" class="md-nav__link">
        TaurusDB论文
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../articles/pebble/" class="md-nav__link">
        Pebble KV存储引擎
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/faunadb_transaction/" class="md-nav__link">
        FaunaDB分布式事务协议
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/Aurora_design_cloud_native_database/" class="md-nav__link">
        Aurora云原生关系数据库
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/btree_vs_lsmtree/" class="md-nav__link">
        现代存储系统背后的算法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/db_nodes/00_database_systems_2018/" class="md-nav__link">
        数据库笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/F1_query/" class="md-nav__link">
        F1 Query
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          分布式系统
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="分布式系统" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          分布式系统
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/distsys/" class="md-nav__link">
        分布式系统大纲
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../articles/partition/" class="md-nav__link">
        数据分区
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/strong_consistency_models/" class="md-nav__link">
        强一致性模型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/zookeeper/" class="md-nav__link">
        Zookeeper论文翻译
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/paxos_made_live/" class="md-nav__link">
        Paxos Made Live翻译
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          编程语言
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="编程语言" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          编程语言
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../articles/go_concurrency/" class="md-nav__link">
        Go并发编程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/go_interface/" class="md-nav__link">
        如何使用Go接口
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          软件工程
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="软件工程" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          软件工程
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/pragmatic_programmer/" class="md-nav__link">
        程序员修炼之道
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/bash_turorial/" class="md-nav__link">
        bash教程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/linux_sysadmin/" class="md-nav__link">
        linux系统管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/git/" class="md-nav__link">
        git入门教程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/to_be_manager/" class="md-nav__link">
        How to be a manager
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    输入输出
  </a>
  
    <nav class="md-nav" aria-label="输入输出">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#io" class="md-nav__link">
    io
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ioutil" class="md-nav__link">
    ioutil
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fmt" class="md-nav__link">
    fmt
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bufio" class="md-nav__link">
    bufio
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    文本处理
  </a>
  
    <nav class="md-nav" aria-label="文本处理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#strings" class="md-nav__link">
    strings
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bytes" class="md-nav__link">
    bytes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strconv" class="md-nav__link">
    strconv
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#regexp" class="md-nav__link">
    regexp
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unicode" class="md-nav__link">
    unicode
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#html" class="md-nav__link">
    html
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#htmltemplate" class="md-nav__link">
    html/template
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#texttemplate" class="md-nav__link">
    text/template
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    数据结构
  </a>
  
    <nav class="md-nav" aria-label="数据结构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sort" class="md-nav__link">
    sort
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#list" class="md-nav__link">
    list
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#heap" class="md-nav__link">
    heap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ring" class="md-nav__link">
    ring
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    时间处理
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    系统操作
  </a>
  
    <nav class="md-nav" aria-label="系统操作">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#os" class="md-nav__link">
    os
  </a>
  
    <nav class="md-nav" aria-label="os">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    文件相关
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    环境变量
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    错误信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    进程处理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    管道
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#osexec" class="md-nav__link">
    os/exec
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#path" class="md-nav__link">
    path
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pathfilepath" class="md-nav__link">
    path/filepath
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    随机数
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    数据存储
  </a>
  
    <nav class="md-nav" aria-label="数据存储">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#encodingjson" class="md-nav__link">
    encoding/json
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    不安全类型
  </a>
  
    <nav class="md-nav" aria-label="不安全类型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unsafe" class="md-nav__link">
    unsafe
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    命令行参数
  </a>
  
    <nav class="md-nav" aria-label="命令行参数">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#flag" class="md-nav__link">
    flag
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    测试
  </a>
  
    <nav class="md-nav" aria-label="测试">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    单元测试
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    基准测试
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    子测试
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    示例测试
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    覆盖率测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    错误
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    反射
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    同步
  </a>
  
    <nav class="md-nav" aria-label="同步">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#once" class="md-nav__link">
    Once
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pool" class="md-nav__link">
    Pool
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#waitgroup" class="md-nav__link">
    WaitGroup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#map" class="md-nav__link">
    Map
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cond" class="md-nav__link">
    Cond
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#syncatomic" class="md-nav__link">
    sync/atomic
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    网络
  </a>
  
    <nav class="md-nav" aria-label="网络">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#net" class="md-nav__link">
    net
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nethttp" class="md-nav__link">
    net/http
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#netrpc" class="md-nav__link">
    net/rpc
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    日志
  </a>
  
    <nav class="md-nav" aria-label="日志">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#log" class="md-nav__link">
    log
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    运行时
  </a>
  
    <nav class="md-nav" aria-label="运行时">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    环境变量
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#runtime" class="md-nav__link">
    runtime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#runtimedebug" class="md-nav__link">
    runtime/debug
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#runtimepprof" class="md-nav__link">
    runtime/pprof
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#runtimetrace" class="md-nav__link">
    runtime/trace
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#runtimerace" class="md-nav__link">
    runtime/race
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    其它
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="go">Go标准库</h1>
<h2 id="_1">输入输出</h2>
<h3 id="io">io</h3>
<p>该模块为IO原语于提供了基本的接口。其主要目的是封装这些已经存在的原语（如在os包中的原语），将其变成抽象功能的公共接口，以及一些其他的相关原语。</p>
<p>由于这些被接口包装的I/O原语是由不同的低级操作实现，因此，在另有声明之前不该假定它们的并行执行是安全的。</p>
<p>在 io 包中最重要的是两个接口：Reader 和 Writer 接口。本章所提到的各种 IO 包，都跟这两个接口有关，也就是说，只要满足这两个接口，它就可以使用 IO 包的功能。</p>
<p>主要接口：</p>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">Reader</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">Read</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">type</span> <span class="nx">Writer</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">Write</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">type</span> <span class="nx">Closer</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">Close</span><span class="p">()</span> <span class="kt">error</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="ioutil">ioutil</h3>
<p>ioutil 包实现了 I/O 的一些实用函数。</p>
<p><strong>读取所有内容 ReadAll</strong></p>
<div class="highlight"><pre><span></span><code><span class="nx">r</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">NewReader</span><span class="p">(</span><span class="s">&quot;Go is a general-purpose language designed with systems programming in mind.&quot;</span><span class="p">)</span>

<span class="nx">b</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadAll</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
</code></pre></div>

<p><strong>递归列出目录下的所有内容</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">listAll</span><span class="p">(</span><span class="s">&quot;../../&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">listAll</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">level</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fileLists</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadDir</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">file</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">fileLists</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">l</span> <span class="o">:=</span> <span class="nx">level</span><span class="p">;</span> <span class="nx">l</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">l</span><span class="o">--</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;\t&quot;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">file</span><span class="p">.</span><span class="nx">IsDir</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">Name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span><span class="p">)</span>
            <span class="nx">listAll</span><span class="p">(</span><span class="nx">path</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="nx">file</span><span class="p">.</span><span class="nx">Name</span><span class="p">(),</span> <span class="nx">level</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">Name</span><span class="p">())</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>读写文件</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Remove</span><span class="p">(</span><span class="s">&quot;tmp.log&quot;</span><span class="p">)</span>
    <span class="nx">ioutil</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="s">&quot;tmp.log&quot;</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;log content&quot;</span><span class="p">),</span> <span class="mo">0666</span><span class="p">)</span>
    <span class="nx">content</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span><span class="s">&quot;tmp.log&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">content</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>临时目录和文件</strong></p>
<div class="highlight"><pre><span></span><code><span class="nx">os</span><span class="p">.</span><span class="nx">TempDir</span><span class="p">()</span>                   <span class="c1">// 获取操作系统的临时目录</span>
<span class="nx">ioutil</span><span class="p">.</span><span class="nx">TempDir</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;go-build&quot;</span><span class="p">)</span> <span class="c1">// 在指定目录下，生成临时目录</span>
<span class="nx">ioutil</span><span class="p">.</span><span class="nx">TempFile</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;gofmt&quot;</span><span class="p">)</span>   <span class="c1">// 在指定目录下，生成临时文件</span>
</code></pre></div>

<h3 id="fmt">fmt</h3>
<ul>
<li>提供Print函数族，与C语言中的printf类似</li>
<li>提供Scan函数族，与C语言中的scanf类似</li>
</ul>
<h3 id="bufio">bufio</h3>
<p>bufio 包实现了缓存IO。它包装了 io.Reader 和 io.Writer 接口，创建了另外的Reader和Writer对象，它们也实现了 io.Reader 和 io.Writer 接口，不过它们是有缓存的。该包同时为文本I/O提供了一些便利操作。</p>
<ol>
<li><strong>bufio.Reader</strong>: 带缓冲的读取，很多小的不带缓冲读取会影响性能。</li>
<li>reader.ReadSlice/ReadBytes/ReadString/ReadLine：
   - ReadSlice返回的 []byte 是指向 Reader 中的 buffer，而不是 copy 一份返回，也正因为如此，通常我们会使用 ReadBytes 或 ReadString。
   - ReadLine 尝试返回单独的行，不包括行尾的换行符。如果一行大于缓存，isPrefix 会被设置为 true，同时返回该行的开始部分（等于缓存大小的部分）。该行剩余的部分就会在下次调用的时候返回。</li>
<li>reader.Peek，返回的 <code>[]byte</code> 只是buffer中的引用，下次操作后会无效。多goroutine不安全。</li>
<li><strong>bufio.Scanner</strong>：比Reader更方便的方法，用于读取单词，句子等</li>
<li>bufio.Writer：许多小的写入会影响性能，每个写入最终都是一个系统调用，如果太频繁，就会严重影响性能。</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1">// Scanner对象</span>
<span class="kd">const</span> <span class="nx">input</span> <span class="p">=</span> <span class="s">&quot;This is The Golang Standard Library.\nWelcome you!\n&quot;</span>
<span class="nx">scanner</span> <span class="o">:=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nx">NewScanner</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">NewReader</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span>
<span class="nx">scanner</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">ScanLines</span><span class="p">)</span>
<span class="k">for</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">Scan</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">scanner</span><span class="p">.</span><span class="nx">Text</span><span class="p">())</span>
<span class="p">}</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">Err</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="s">&quot;reading input:&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 分别统计不带缓冲，带缓冲的写入用时</span>
<span class="kd">func</span> <span class="nx">writeManyString</span><span class="p">(</span><span class="nx">tag</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">f</span> <span class="nx">io</span><span class="p">.</span><span class="nx">StringWriter</span><span class="p">,</span> <span class="nx">count</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">count</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">f</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;\n&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">statTime</span><span class="p">(</span><span class="nx">f</span> <span class="kd">func</span><span class="p">())</span> <span class="p">{</span>
    <span class="nx">start</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>
    <span class="nx">f</span><span class="p">()</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Since</span><span class="p">(</span><span class="nx">start</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">f</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="s">&quot;test.log&quot;</span><span class="p">)</span>
    <span class="nx">f1</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">writeManyString</span><span class="p">(</span><span class="s">&quot;syscall file write&quot;</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">statTime</span><span class="p">(</span><span class="nx">f1</span><span class="p">)</span>

    <span class="nx">f</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="s">&quot;test1.log&quot;</span><span class="p">)</span>
    <span class="nx">f2</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">w</span> <span class="o">:=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nx">NewWriter</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
        <span class="nx">writeManyString</span><span class="p">(</span><span class="s">&quot;buffer file write&quot;</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">)</span>
        <span class="nx">w</span><span class="p">.</span><span class="nx">Flush</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="nx">statTime</span><span class="p">(</span><span class="nx">f2</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// Output:</span>
<span class="c1">// 9.8976831s</span>
<span class="c1">// 123.3015ms</span>

<span class="c1">// 从标准输入读取一行</span>
<span class="nx">scanner</span> <span class="o">:=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nx">NewScanner</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">)</span>
<span class="nx">scanner</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">ScanLines</span><span class="p">)</span>
<span class="k">for</span> <span class="p">{</span>
    <span class="nx">scanner</span><span class="p">.</span><span class="nx">Scan</span><span class="p">()</span>
    <span class="nx">r</span> <span class="o">:=</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">Text</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">r</span> <span class="o">==</span> <span class="s">&quot;exit&quot;</span> <span class="p">{</span>
        <span class="k">break</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">for</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">line</span> <span class="kt">string</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Scanln</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">line</span> <span class="o">==</span> <span class="s">&quot;exit&quot;</span> <span class="p">{</span>
        <span class="k">break</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="_2">文本处理</h2>
<h3 id="strings">strings</h3>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">ExampleStrings</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;=== strings.Fields:&quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%q\n&quot;</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Fields</span><span class="p">(</span><span class="s">&quot;  foo bar  baz   &quot;</span><span class="p">))</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;=== strings.Compare:&quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Compare</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Compare</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Compare</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">))</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;=== strings.Contains:&quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Contains</span><span class="p">(</span><span class="s">&quot;seafood&quot;</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Contains</span><span class="p">(</span><span class="s">&quot;seafood&quot;</span><span class="p">,</span> <span class="s">&quot;bar&quot;</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Contains</span><span class="p">(</span><span class="s">&quot;seafood&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Contains</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">))</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;=== strings.ContainsRune:&quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">ContainsRune</span><span class="p">(</span><span class="s">&quot;aardvark&quot;</span><span class="p">,</span> <span class="mi">97</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">ContainsRune</span><span class="p">(</span><span class="s">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">97</span><span class="p">))</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;=== strings.Count:&quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Count</span><span class="p">(</span><span class="s">&quot;cheese&quot;</span><span class="p">,</span> <span class="s">&quot;e&quot;</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Count</span><span class="p">(</span><span class="s">&quot;five&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">))</span> <span class="c1">// before &amp; after each rune</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;=== strings.EqualFold:&quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">EqualFold</span><span class="p">(</span><span class="s">&quot;Go&quot;</span><span class="p">,</span> <span class="s">&quot;go&quot;</span><span class="p">))</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;=== strings.HasPrefix:&quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">HasPrefix</span><span class="p">(</span><span class="s">&quot;Gopher&quot;</span><span class="p">,</span> <span class="s">&quot;Go&quot;</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">HasPrefix</span><span class="p">(</span><span class="s">&quot;Gopher&quot;</span><span class="p">,</span> <span class="s">&quot;C&quot;</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">HasPrefix</span><span class="p">(</span><span class="s">&quot;Gopher&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">))</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;=== strings.HasSuffix:&quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">HasSuffix</span><span class="p">(</span><span class="s">&quot;Amigo&quot;</span><span class="p">,</span> <span class="s">&quot;go&quot;</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">HasSuffix</span><span class="p">(</span><span class="s">&quot;Amigo&quot;</span><span class="p">,</span> <span class="s">&quot;O&quot;</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">HasSuffix</span><span class="p">(</span><span class="s">&quot;Amigo&quot;</span><span class="p">,</span> <span class="s">&quot;Ami&quot;</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">HasSuffix</span><span class="p">(</span><span class="s">&quot;Amigo&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">))</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;=== strings.Index:&quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Index</span><span class="p">(</span><span class="s">&quot;chicken&quot;</span><span class="p">,</span> <span class="s">&quot;ken&quot;</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Index</span><span class="p">(</span><span class="s">&quot;chicken&quot;</span><span class="p">,</span> <span class="s">&quot;dmr&quot;</span><span class="p">))</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;=== strings.Join:&quot;</span><span class="p">)</span>
    <span class="nx">ss</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="s">&quot;bar&quot;</span><span class="p">,</span> <span class="s">&quot;baz&quot;</span><span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">ss</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="p">))</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;=== strings.Repeat:&quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;ba&quot;</span> <span class="o">+</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Repeat</span><span class="p">(</span><span class="s">&quot;na&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;=== strings.Replace:&quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Replace</span><span class="p">(</span><span class="s">&quot;oink oink oink&quot;</span><span class="p">,</span> <span class="s">&quot;k&quot;</span><span class="p">,</span> <span class="s">&quot;ky&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Replace</span><span class="p">(</span><span class="s">&quot;oink oink oink&quot;</span><span class="p">,</span> <span class="s">&quot;oink&quot;</span><span class="p">,</span> <span class="s">&quot;moo&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;=== strings.ReplaceAll:&quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">ReplaceAll</span><span class="p">(</span><span class="s">&quot;oink oink oink&quot;</span><span class="p">,</span> <span class="s">&quot;oink&quot;</span><span class="p">,</span> <span class="s">&quot;moo&quot;</span><span class="p">))</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;=== strings.Split:&quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%q\n&quot;</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="s">&quot;a,b,c&quot;</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%q\n&quot;</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="s">&quot;a man a plan a canal panama&quot;</span><span class="p">,</span> <span class="s">&quot;a &quot;</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%q\n&quot;</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="s">&quot; xyz &quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%q\n&quot;</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Bernardo O&#39;Higgins&quot;</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%q\n&quot;</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">SplitAfter</span><span class="p">(</span><span class="s">&quot;a,b,c&quot;</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;=== strings.Map:&quot;</span><span class="p">)</span>
    <span class="nx">rot13</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">r</span> <span class="kt">rune</span><span class="p">)</span> <span class="kt">rune</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">r</span> <span class="o">&gt;=</span> <span class="sc">&#39;A&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span> <span class="o">&lt;=</span> <span class="sc">&#39;Z&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">r</span><span class="o">-</span><span class="sc">&#39;A&#39;</span><span class="o">+</span><span class="mi">13</span><span class="p">)</span><span class="o">%</span><span class="mi">26</span>
        <span class="k">case</span> <span class="nx">r</span> <span class="o">&gt;=</span> <span class="sc">&#39;a&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span> <span class="o">&lt;=</span> <span class="sc">&#39;z&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="sc">&#39;a&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">r</span><span class="o">-</span><span class="sc">&#39;a&#39;</span><span class="o">+</span><span class="mi">13</span><span class="p">)</span><span class="o">%</span><span class="mi">26</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">r</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Map</span><span class="p">(</span><span class="nx">rot13</span><span class="p">,</span> <span class="s">&quot;&#39;Twas brillig and the slithy gopher...&quot;</span><span class="p">))</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;=== strings.NewReplacer:&quot;</span><span class="p">)</span>
    <span class="nx">r</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">NewReplacer</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s">&quot;&amp;lt;&quot;</span><span class="p">,</span> <span class="s">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;&amp;gt;&quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Replace</span><span class="p">(</span><span class="s">&quot;This is &lt;b&gt;HTML&lt;/b&gt;!&quot;</span><span class="p">))</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;=== strings.Trim:&quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Trim</span><span class="p">(</span><span class="s">&quot;¡¡¡Hello, Gophers!!!&quot;</span><span class="p">,</span> <span class="s">&quot;!¡&quot;</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="s">&quot; \t\n Hello, Gophers \n\t\r\n&quot;</span><span class="p">))</span>

    <span class="kd">var</span> <span class="nx">s</span> <span class="p">=</span> <span class="s">&quot;¡¡¡Hello, Gophers!!!&quot;</span>
    <span class="nx">s</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">TrimPrefix</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="s">&quot;¡¡¡Hello, &quot;</span><span class="p">)</span>
    <span class="nx">s</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">TrimPrefix</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="s">&quot;¡¡¡Howdy, &quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>

    <span class="nx">s</span> <span class="p">=</span> <span class="s">&quot;¡¡¡Hello, Gophers!!!&quot;</span>
    <span class="nx">s</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSuffix</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="s">&quot;, Gophers!!!&quot;</span><span class="p">)</span>
    <span class="nx">s</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSuffix</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="s">&quot;, Marmots!!!&quot;</span><span class="p">)</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimLeft</span><span class="p">(</span><span class="s">&quot;¡¡¡Hello, Gophers!!!&quot;</span><span class="p">,</span> <span class="s">&quot;!¡&quot;</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimRight</span><span class="p">(</span><span class="s">&quot;¡¡¡Hello, Gophers!!!&quot;</span><span class="p">,</span> <span class="s">&quot;!¡&quot;</span><span class="p">))</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;=== strings.Builder:&quot;</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">b</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Builder</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">b</span><span class="p">,</span> <span class="s">&quot;%d...&quot;</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="s">&quot;ignition&quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">String</span><span class="p">())</span>

    <span class="c1">// Output:</span>
    <span class="c1">// === strings.Fields:</span>
    <span class="c1">// [&quot;foo&quot; &quot;bar&quot; &quot;baz&quot;]</span>
    <span class="c1">// === strings.Compare:</span>
    <span class="c1">// -1</span>
    <span class="c1">// 0</span>
    <span class="c1">// 1</span>
    <span class="c1">// === strings.Contains:</span>
    <span class="c1">// true</span>
    <span class="c1">// false</span>
    <span class="c1">// true</span>
    <span class="c1">// true</span>
    <span class="c1">// === strings.ContainsRune:</span>
    <span class="c1">// true</span>
    <span class="c1">// false</span>
    <span class="c1">// === strings.Count:</span>
    <span class="c1">// 3</span>
    <span class="c1">// 5</span>
    <span class="c1">// === strings.EqualFold:</span>
    <span class="c1">// true</span>
    <span class="c1">// === strings.HasPrefix:</span>
    <span class="c1">// true</span>
    <span class="c1">// false</span>
    <span class="c1">// true</span>
    <span class="c1">// === strings.HasSuffix:</span>
    <span class="c1">// true</span>
    <span class="c1">// false</span>
    <span class="c1">// false</span>
    <span class="c1">// true</span>
    <span class="c1">// === strings.Index:</span>
    <span class="c1">// 4</span>
    <span class="c1">// -1</span>
    <span class="c1">// === strings.Join:</span>
    <span class="c1">// foo, bar, baz</span>
    <span class="c1">// === strings.Repeat:</span>
    <span class="c1">// banana</span>
    <span class="c1">// === strings.Replace:</span>
    <span class="c1">// oinky oinky oink</span>
    <span class="c1">// moo moo moo</span>
    <span class="c1">// === strings.ReplaceAll:</span>
    <span class="c1">// moo moo moo</span>
    <span class="c1">// === strings.Split:</span>
    <span class="c1">// [&quot;a&quot; &quot;b&quot; &quot;c&quot;]</span>
    <span class="c1">// [&quot;&quot; &quot;man &quot; &quot;plan &quot; &quot;canal panama&quot;]</span>
    <span class="c1">// [&quot; &quot; &quot;x&quot; &quot;y&quot; &quot;z&quot; &quot; &quot;]</span>
    <span class="c1">// [&quot;&quot;]</span>
    <span class="c1">// [&quot;a,&quot; &quot;b,&quot; &quot;c&quot;]</span>
    <span class="c1">// === strings.Map:</span>
    <span class="c1">// &#39;Gjnf oevyyvt naq gur fyvgul tbcure...</span>
    <span class="c1">// === strings.NewReplacer:</span>
    <span class="c1">// This is &amp;lt;b&amp;gt;HTML&amp;lt;/b&amp;gt;!</span>
    <span class="c1">// === strings.Trim:</span>
    <span class="c1">// Hello, Gophers</span>
    <span class="c1">// Hello, Gophers</span>
    <span class="c1">// Gophers!!!</span>
    <span class="c1">// Hello, Gophers!!!</span>
    <span class="c1">// ¡¡¡Hello, Gophers</span>
    <span class="c1">// === strings.Builder:</span>
    <span class="c1">// 3...2...1...ignition</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="bytes">bytes</h3>
<p>包字节实现了处理字节切片([]byte)的函数。它类似于strings包的功能。</p>
<h3 id="strconv">strconv</h3>
<p>提供各种类型到字符串，以及字符串到各种其他类型的转换函数。</p>
<h3 id="regexp">regexp</h3>
<p>正则表达式使用单个字符串来描述、匹配一系列符合某个句法规则的字符串。正则表达式为文本处理提供了强大的功能。Go 作为一门通用语言，自然提供了对正则表达式的支持。</p>
<p><code>regexp</code> 包实现了正则表达式搜索。 </p>
<h3 id="unicode">unicode</h3>
<p>世界中的字符有许许多多，有英文，中文，韩文等。我们强烈需要一个<strong>大大的映射表把世界上的字符映射成计算机可以阅读的二进制数字</strong>（字节）。 这样，每个字符都给予一个独一无二的编码，就不会出现写文字的人和阅读文字的人编码不同而出现无法读取的乱码现象了。</p>
<p>于是 Unicode 就出现了，<strong>它是一种所有符号的编码映射</strong>。最开始的时候，unicode 认为使用两个字节，也就是 16 位就能包含所有的字符了。 但是非常可惜，两个字节最多只能覆盖 65536 个字符，这显然是不够的，于是附加了一套字符编码，即 unicode4.0，附加的字符用 4 个字节表示。 现在为止，大概 Unicode 可以覆盖 100 多万个字符了。</p>
<p><strong>Unicode 只是定义了一个字符和一个编码的映射，但是呢，对应的存储却没有制定</strong>。 比如一个编码 0x0041 代表大写字母 A，那么可能有一种存储至少有 4 个字节，那可能 0x00000041 来存储代表 A。 这个就是 unicode 的具体实现。unicode 的具体实现有很多种，UTF-8 和 UTF-16 就是其中两种。</p>
<p>UTF-8 表示最少用一个字节就能表示一个字符的编码实现。它采取的方式是对不同的语言使用不同的方法，将 unicode 编码按照这个方法进行转换。 我们只要记住最后的结果是英文占一个字节，中文占三个字节。这种编码实现方式也是现在应用最为广泛的方式了。</p>
<p>UTF-16 表示最少用两个字节能表示一个字符的编码实现。同样是对 unicode 编码进行转换，它的结果是英文占用两个字节，中文占用两个或者四个字节。 实际上，UTF-16 就是最严格实现了 unicode4.0。但由于英文是最通用的语言，所以推广程度没有 UTF-8 那么普及。</p>
<p>回到 go 对 unicode 包的支持，由于 UTF-8 的作者 Ken Thompson 同时也是 go 语言的创始人，所以说，在字符支持方面，几乎没有语言的理解会高于 go 了。 go 对 unicode 的支持包含三个包 :</p>
<ul>
<li>unicode</li>
<li>unicode/utf8</li>
<li>unicode/utf16</li>
</ul>
<p>unicode 包包含基本的字符判断函数。utf8 包主要负责 rune 和 byte 之间的转换。utf16 包负责 rune 和 uint16 数组之间的转换。</p>
<p>由于字符的概念有的时候比较模糊，比如字符（小写 a）普通显示为 a，在重音字符中（grave-accented）中显示为à。 这时候字符（character）的概念就有点不准确了，因为 a 和à显然是两个不同的 unicode 编码，但是却代表同一个字符，所以引入了 rune。 一个 rune 就代表一个 unicode 编码，所以上面的 a 和à是两个不同的 rune。</p>
<p>这里有个要注意的事情，go 语言的所有代码都是 UTF8 的，所以如果我们在程序中的字符串都是 utf8 编码的，但是我们的单个字符（单引号扩起来的）却是 unicode 的。</p>
<h3 id="html">html</h3>
<p>html 包提供了转义和非转义html文本的函数。</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">ExampleHtml</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">s</span> <span class="p">=</span> <span class="s">`&quot;Fran &amp; Freddie&#39;s Diner&quot; &lt;tasty@example.com&gt;`</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">html</span><span class="p">.</span><span class="nx">EscapeString</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span>
    <span class="nx">r</span> <span class="o">:=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">UnescapeString</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
    <span class="c1">// Output:</span>
    <span class="c1">//  &amp;#34;Fran &amp;amp; Freddie&amp;#39;s Diner&amp;#34; &amp;lt;tasty@example.com&amp;gt;</span>
    <span class="c1">// &quot;Fran &amp; Freddie&#39;s Diner&quot; &lt;tasty@example.com&gt;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="htmltemplate">html/template</h3>
<p>html/template包实现了数据驱动模板，用于生成针对代码注入的安全html输出。它提供了与包text/template相同的接口，当输出为HTML时，应该使用它代替text/template。</p>
<p>这里的文档主要关注包的安全特性。有关如何编写模板本身的信息，请参阅文本/模板文档。</p>
<h3 id="texttemplate">text/template</h3>
<div class="highlight"><pre><span></span><code><span class="nx">tepl</span> <span class="o">:=</span> <span class="s">&quot;data is {{ . }}&quot;</span>
<span class="nx">tmpl</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">).</span><span class="nx">Parse</span><span class="p">(</span><span class="nx">tepl</span><span class="p">)</span> <span class="c1">// 模板解析</span>
<span class="nx">data</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span>
<span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;one&quot;</span>
<span class="nx">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;two&quot;</span>
<span class="nx">tmpl</span><span class="p">.</span><span class="nx">Execute</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="c1">// 数据驱动模板</span>
<span class="c1">// Output: data is map[1:one 2:two]</span>
</code></pre></div>

<p><code>{{.}}</code> 中间的 <code>.</code> 代表传入模板的数据，根据传入的数据不同渲染不同的内容。</p>
<p><code>.</code> 可以代表任何类型，字符串、数字、结构体、哈希等。</p>
<p>至于 {{ 和 }} 包裹的内容统称为 action，分为两种类型：</p>
<ul>
<li>数据求值（data evaluations）：结果会直接复制到模板中</li>
<li>控制结构（control structures）：控制结构和我们写 Go 程序差不多，也是条件语句、循环语句、变量、函数调用等等</li>
</ul>
<h2 id="_3">数据结构</h2>
<p>数据结构是数据组织和存储的逻辑形式，以达到方便访问和修改数据的目的。</p>
<h3 id="sort">sort</h3>
<p>Sort入口函数调用的是快速排序：当切片数据量较大时，使用快速排序，如果迭代或递归深度超过 <span><span class="MathJax_Preview">maxDepth=2*ceil(lg(n+1))</span><script type="math/tex">maxDepth=2*ceil(lg(n+1))</script></span>，则使用堆排序。当切片数据量较小时（&lt;=12）时，采用希尔排序。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 常用排序</span>
<span class="nx">sort</span><span class="p">.</span><span class="nx">Ints</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
<span class="nx">sort</span><span class="p">.</span><span class="nx">Strings</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
<span class="nx">sort</span><span class="p">.</span><span class="nx">SearchInts</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1">// 结构体切片排序，自定义排序函数</span>
<span class="nx">people</span> <span class="o">:=</span> <span class="p">[]</span><span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="kt">string</span>
    <span class="nx">Age</span>  <span class="kt">int</span>
<span class="p">}{</span>
    <span class="p">{</span><span class="s">&quot;Gopher&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&quot;Alice&quot;</span><span class="p">,</span> <span class="mi">55</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&quot;Vera&quot;</span><span class="p">,</span> <span class="mi">24</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&quot;Bob&quot;</span><span class="p">,</span> <span class="mi">75</span><span class="p">},</span>
<span class="p">}</span>

<span class="nx">funcSortByAge</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">people</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Age</span> <span class="p">&lt;</span> <span class="nx">people</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">Age</span> <span class="p">}</span>
<span class="nx">sort</span><span class="p">.</span><span class="nx">Slice</span><span class="p">(</span><span class="nx">people</span><span class="p">,</span> <span class="nx">funcSortByAge</span><span class="p">)</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;By age:&quot;</span><span class="p">,</span> <span class="nx">people</span><span class="p">)</span>

<span class="c1">// 反向排序，只要定义了Less方法的类型，都可以使用</span>
<span class="nx">s</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">}</span> <span class="c1">// unsorted</span>
<span class="nx">sort</span><span class="p">.</span><span class="nx">Sort</span><span class="p">(</span><span class="nx">sort</span><span class="p">.</span><span class="nx">Reverse</span><span class="p">(</span><span class="nx">sort</span><span class="p">.</span><span class="nx">IntSlice</span><span class="p">(</span><span class="nx">s</span><span class="p">)))</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>

<span class="c1">// 二分查找</span>
<span class="nx">a</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">55</span><span class="p">}</span>
<span class="nx">x</span> <span class="o">:=</span> <span class="mi">6</span>
<span class="nx">i</span> <span class="o">:=</span> <span class="nx">sort</span><span class="p">.</span><span class="nx">Search</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">a</span><span class="p">),</span> <span class="kd">func</span><span class="p">(</span><span class="nx">i</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nx">x</span> <span class="p">})</span>
</code></pre></div>

<h3 id="list">list</h3>
<p>list包实现了双向链表，可以方便地进行对链表中的元素进行操作。</p>
<div class="highlight"><pre><span></span><code><span class="nx">l</span> <span class="o">:=</span> <span class="nx">list</span><span class="p">.</span><span class="nx">New</span><span class="p">()</span>
<span class="nx">e3</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">PushBack</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="nx">l</span><span class="p">.</span><span class="nx">PushFront</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nx">l</span><span class="p">.</span><span class="nx">PushBack</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="nx">l</span><span class="p">.</span><span class="nx">PushFront</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nx">l</span><span class="p">.</span><span class="nx">PushBack</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="k">for</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">Front</span><span class="p">();</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nx">e</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Next</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">()</span>

<span class="nx">e4</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">Remove</span><span class="p">(</span><span class="nx">e3</span><span class="p">.</span><span class="nx">Next</span><span class="p">())</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">e4</span><span class="p">,</span> <span class="s">&quot;is removed&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">Front</span><span class="p">();</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nx">e</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Next</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">()</span>
</code></pre></div>

<h3 id="heap">heap</h3>
<p>heap包支持任意实现了<code>heap.Interface</code>接口类型的堆操作。</p>
<p>堆是一个树：每个节点都是其子树的最小元素。</p>
<p>在树中的最小元素是根节点，索引是0。</p>
<p>堆是用来实现优先级队列的常用方法。为了构建一个优先级队列，Less方法中按优先级顺序实现堆接口，Push加入元素，Pop移除优先级最高的元素。</p>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">Interface</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">sort</span><span class="p">.</span><span class="nx">Interface</span>
    <span class="nx">Push</span><span class="p">(</span><span class="nx">x</span> <span class="kd">interface</span><span class="p">{})</span> <span class="c1">// add x as element Len()</span>
    <span class="nx">Pop</span><span class="p">()</span> <span class="kd">interface</span><span class="p">{}</span>   <span class="c1">// remove and return element Len() - 1.</span>
<span class="p">}</span>

<span class="c1">// 整数数组实现最小堆示例</span>
<span class="c1">// 优先级队列(pq)示例</span>
</code></pre></div>

<h3 id="ring">ring</h3>
<p>实现了循环链表（circular list，或者称之为ring）。循环链表没有开始或者结束元素，任意节点可以作为整个ring的引用。空的ring用nil Ring指针来表示。Ring中的零值是指一个元素的nil值。</p>
<h2 id="_4">时间处理</h2>
<p>time包中的主要功能包括：</p>
<ol>
<li>时间解析、显示和计算等</li>
<li>Duration</li>
<li>Time</li>
<li>定时器：Sleep/After/Ticker/Timer</li>
<li>Location</li>
</ol>
<p>time定时器通过小顶堆实现。（定时器在runtime中实现，实际挂到P的一个timer列表中）。</p>
<h2 id="_5">系统操作</h2>
<h3 id="os">os</h3>
<p>os包提供了平台无关的接口用来操作系统的功能。设计是类UNIX的，但错误处理是Go风格的，失败的调用返回类型error的值，而不是错误号。</p>
<p>os接口旨在使所有操作系统具有统一性。不在通用版本中提供的特性出现在系统特定的包syscall中。</p>
<h4 id="_6">文件相关</h4>
<div class="highlight"><pre><span></span><code><span class="c1">// File表示一个文件或者目录等</span>
<span class="kd">type</span> <span class="nx">File</span> <span class="kd">struct</span> <span class="p">{</span> 
    <span class="o">*</span><span class="nx">file</span> <span class="c1">// os specific</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">Read</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">ReadAt</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">off</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">Write</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">WriteAt</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">off</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">WriteString</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">Seek</span><span class="p">(</span><span class="nx">offset</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">whence</span> <span class="kt">int</span><span class="p">)</span>
<span class="kd">const</span> <span class="p">(</span>
    <span class="nx">SeekStart</span>   <span class="p">=</span> <span class="mi">0</span> <span class="c1">// seek relative to the origin of the file</span>
    <span class="nx">SeekCurrent</span> <span class="p">=</span> <span class="mi">1</span> <span class="c1">// seek relative to the current offset</span>
    <span class="nx">SeekEnd</span>     <span class="p">=</span> <span class="mi">2</span> <span class="c1">// seek relative to the end</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">Chown</span><span class="p">(</span><span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">error</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">Chmod</span><span class="p">(</span><span class="nx">mode</span> <span class="nx">FileMode</span><span class="p">)</span> <span class="kt">error</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">Sync</span><span class="p">()</span> <span class="kt">error</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">Readdir</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="p">([]</span><span class="nx">FileInfo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">Readdirnames</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">names</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">Stat</span><span class="p">()</span> <span class="p">(</span><span class="nx">FileInfo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">Fd</span><span class="p">()</span> <span class="kt">uintptr</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">Close</span><span class="p">()</span> <span class="kt">error</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">Truncate</span><span class="p">(</span><span class="nx">size</span> <span class="kt">int64</span><span class="p">)</span> <span class="kt">error</span> 
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">SetDeadline</span><span class="p">(</span><span class="nx">t</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span> <span class="kt">error</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">SetReadDeadline</span><span class="p">(</span><span class="nx">t</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span> <span class="kt">error</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">SetWriteDeadline</span><span class="p">(</span><span class="nx">t</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span> <span class="kt">error</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">SyscallConn</span><span class="p">()</span> <span class="p">(</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">RawConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

<span class="kd">func</span> <span class="nx">Stat</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">FileInfo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">Getwd</span><span class="p">()</span> <span class="p">(</span><span class="nx">dir</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>                 <span class="c1">// 获得当前工作路径</span>
<span class="kd">func</span> <span class="nx">Chdir</span><span class="p">(</span><span class="nx">dir</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>                         <span class="c1">// 变更工作目录</span>
<span class="kd">func</span> <span class="nx">Open</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">File</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>                <span class="c1">// 打开一个文件用于读取</span>
<span class="kd">func</span> <span class="nx">Create</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">File</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>              <span class="c1">// 创建或者截断一个文件</span>
<span class="kd">func</span> <span class="nx">OpenFile</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">flag</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">perm</span> <span class="nx">FileMode</span><span class="p">)</span>  <span class="c1">// 通用方法</span>
<span class="kd">func</span> <span class="nx">Rename</span><span class="p">(</span><span class="nx">oldpath</span><span class="p">,</span> <span class="nx">newpath</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>           <span class="c1">// 重命名（移动）</span>
<span class="kd">func</span> <span class="nx">Chmod</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">mode</span> <span class="nx">FileMode</span><span class="p">)</span> <span class="kt">error</span>         <span class="c1">// 更改权限</span>
<span class="kd">func</span> <span class="nx">Mkdir</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">perm</span> <span class="nx">FileMode</span><span class="p">)</span> <span class="kt">error</span>
<span class="kd">func</span> <span class="nx">MkdirAll</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">perm</span> <span class="nx">FileMode</span><span class="p">)</span> <span class="kt">error</span>
<span class="kd">func</span> <span class="nx">Remove</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
<span class="kd">func</span> <span class="nx">RemoveAll</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1">// 默认的临时目录</span>
<span class="kd">func</span> <span class="nx">TempDir</span><span class="p">()</span> <span class="kt">string</span>
<span class="c1">// C:\Users\W00278~1\AppData\Local\Temp</span>
<span class="c1">// /tmp</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">UserCacheDir</span><span class="p">())</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">UserConfigDir</span><span class="p">())</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">UserHomeDir</span><span class="p">())</span>
<span class="cm">/*</span>
<span class="cm">windows:</span>
<span class="cm">C:\Users\wade\AppData\Local</span>
<span class="cm">C:\Users\wade\AppData\Roaming</span>
<span class="cm">C:\Users\wade</span>

<span class="cm">linux:</span>
<span class="cm">/home/wade/.cache</span>
<span class="cm">/home/wade/.config</span>
<span class="cm">/home/wade</span>
<span class="cm">*/</span>

<span class="c1">// 读取目录下相关文件</span>
<span class="nx">f</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="s">&quot;./&quot;</span><span class="p">)</span>

<span class="nx">files</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Readdir</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">file</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">files</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">Name</span><span class="p">())</span>
<span class="p">}</span>

<span class="nx">f</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="s">&quot;../&quot;</span><span class="p">)</span>
<span class="nx">filenames</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Readdirnames</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">filenames</span><span class="p">)</span>

<span class="c1">// 生成临时目录，并删除</span>
<span class="nx">f</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">TempFile</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">TempDir</span><span class="p">(),</span> <span class="s">&quot;go-test&quot;</span><span class="p">)</span>
<span class="nx">filename</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Name</span><span class="p">()</span>
<span class="nx">f</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
<span class="nx">os</span><span class="p">.</span><span class="nx">Remove</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
</code></pre></div>

<h4 id="_7">环境变量</h4>
<div class="highlight"><pre><span></span><code><span class="nx">os</span><span class="p">.</span><span class="nx">Setenv</span><span class="p">(</span><span class="s">&quot;TEMP_ENV_KEY&quot;</span><span class="p">,</span> <span class="s">&quot;TEMP_ENV_VALUE&quot;</span><span class="p">)</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Getenv</span><span class="p">(</span><span class="s">&quot;TEMP_ENV_KEY&quot;</span><span class="p">))</span>
</code></pre></div>

<h4 id="_8">错误信息</h4>
<div class="highlight"><pre><span></span><code><span class="nx">ErrInvalid</span> <span class="p">=</span> <span class="nx">errInvalid</span><span class="p">()</span> <span class="c1">// &quot;invalid argument&quot;</span>

<span class="nx">ErrPermission</span> <span class="p">=</span> <span class="nx">errPermission</span><span class="p">()</span> <span class="c1">// &quot;permission denied&quot;</span>
<span class="nx">ErrExist</span>      <span class="p">=</span> <span class="nx">errExist</span><span class="p">()</span>      <span class="c1">// &quot;file already exists&quot;</span>
<span class="nx">ErrNotExist</span>   <span class="p">=</span> <span class="nx">errNotExist</span><span class="p">()</span>   <span class="c1">// &quot;file does not exist&quot;</span>
<span class="nx">ErrClosed</span>     <span class="p">=</span> <span class="nx">errClosed</span><span class="p">()</span>     <span class="c1">// &quot;file already closed&quot;</span>
<span class="nx">ErrNoDeadline</span> <span class="p">=</span> <span class="nx">errNoDeadline</span><span class="p">()</span> <span class="c1">// &quot;file type does not support deadline&quot;</span>
</code></pre></div>

<h4 id="_9">进程处理</h4>
<p>处理进程相关的功能：进程、进程状态、获取进程ID，启动一个进程，发送信号等。os.exec包封装了这个包的功能。</p>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">ProcessState</span> <span class="kd">struct</span>   <span class="c1">// 保存一个进程状态信息，通过Wait进行返回。</span>
<span class="kd">type</span> <span class="nx">Process</span> <span class="kd">struct</span>        <span class="c1">// 保存进程信息，通过 StartProcess 返回</span>

<span class="c1">// 进程相关处理函数，启动释放，杀死，等待，发送信号等</span>
<span class="kd">func</span> <span class="nx">StartProcess</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">argv</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="nx">attr</span> <span class="o">*</span><span class="nx">ProcAttr</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Process</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Process</span><span class="p">)</span> <span class="nx">Release</span><span class="p">()</span> <span class="kt">error</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Process</span><span class="p">)</span> <span class="nx">Kill</span><span class="p">()</span> <span class="kt">error</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Process</span><span class="p">)</span> <span class="nx">Wait</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">ProcessState</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Process</span><span class="p">)</span> <span class="nx">Signal</span><span class="p">(</span><span class="nx">sig</span> <span class="nx">Signal</span><span class="p">)</span> <span class="kt">error</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">ProcessState</span><span class="p">)</span> <span class="nx">UserTime</span><span class="p">()</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">ProcessState</span><span class="p">)</span> <span class="nx">SystemTime</span><span class="p">()</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">ProcessState</span><span class="p">)</span> <span class="nx">Exited</span><span class="p">()</span> <span class="kt">bool</span>                <span class="c1">// 判断进程是否已经退出</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">ProcessState</span><span class="p">)</span> <span class="nx">Success</span><span class="p">()</span> <span class="kt">bool</span>               <span class="c1">// 判断进程是否成功退出</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">ProcessState</span><span class="p">)</span> <span class="nx">Sys</span><span class="p">()</span> <span class="kd">interface</span><span class="p">{}</span>            <span class="c1">// 返回非系统独立的退出信息</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">ProcessState</span><span class="p">)</span> <span class="nx">SysUsage</span><span class="p">()</span> <span class="kd">interface</span><span class="p">{}</span>       <span class="c1">// 返回非系统独立的资源使用信息</span>

<span class="kd">func</span> <span class="nx">FindProcess</span><span class="p">(</span><span class="nx">pid</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Process</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>         <span class="c1">// 通过进程ID查找进程</span>
<span class="kd">func</span> <span class="nx">Getpid</span><span class="p">()</span> <span class="kt">int</span>                                   <span class="c1">// 获得进程的ID</span>
<span class="kd">func</span> <span class="nx">Getppid</span><span class="p">()</span> <span class="kt">int</span>                                  <span class="c1">// 获得父进程的ID</span>

<span class="kd">func</span> <span class="nx">Executable</span><span class="p">()</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>                   <span class="c1">// 返回当前运行进程的路径</span>
</code></pre></div>

<h4 id="_10">管道</h4>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">Pipe</span><span class="p">()</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">File</span><span class="p">,</span> <span class="nx">w</span> <span class="o">*</span><span class="nx">File</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></div>

<h3 id="osexec">os/exec</h3>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">Command</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">arg</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Cmd</span>
<span class="kd">func</span> <span class="nx">CommandContext</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">arg</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Cmd</span>

<span class="nx">Path</span> <span class="kt">string</span>                                         <span class="c1">// 运行命令的路径</span>
<span class="nx">Args</span> <span class="p">[]</span><span class="kt">string</span>
<span class="nx">Env</span> <span class="p">[]</span><span class="kt">string</span>
<span class="nx">Dir</span> <span class="kt">string</span>
<span class="nx">Process</span> <span class="o">*</span><span class="nx">os</span><span class="p">.</span><span class="nx">Process</span>                                 <span class="c1">// 进程启动后的信息</span>
<span class="nx">ProcessState</span> <span class="o">*</span><span class="nx">os</span><span class="p">.</span><span class="nx">ProcessState</span>                       <span class="c1">// 进程退出后的状态信息</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cmd</span><span class="p">)</span> <span class="nx">Start</span><span class="p">()</span> <span class="kt">error</span>                         <span class="c1">// 仅启动进程</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cmd</span><span class="p">)</span> <span class="nx">Wait</span><span class="p">()</span> <span class="kt">error</span>                          <span class="c1">// 等待进程结束</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cmd</span><span class="p">)</span> <span class="nx">Run</span><span class="p">()</span> <span class="kt">error</span>                           <span class="c1">// Start，然后Wait进程结束</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cmd</span><span class="p">)</span> <span class="nx">Output</span><span class="p">()</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>              <span class="c1">// Run命令，然后返回标准输出</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cmd</span><span class="p">)</span> <span class="nx">CombinedOutput</span><span class="p">()</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>      <span class="c1">// Run命令，然后将标准输出和错误输出合并</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">exec</span><span class="p">.</span><span class="nx">LookPath</span><span class="p">(</span><span class="s">&quot;go&quot;</span><span class="p">))</span>                    <span class="c1">// 查找进程路径，D:\Go\bin\go.exe</span>
</code></pre></div>

<h3 id="path">path</h3>
<p>path包实现了操作斜杠(<code>/</code>)分割的路径。</p>
<p>只能用于通过正斜杠分割的路径，例如在URLs中的路径。</p>
<p>不支持带有如windows中的带有驱动器的路径和反斜杠。</p>
<p>如果要操作操作系统路径，使用 <code>path/filepath</code> 包。</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">Dir</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span>                              <span class="c1">// 目录部分</span>
<span class="kd">func</span> <span class="nx">Base</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span>                             <span class="c1">// 文件名部分</span>
<span class="kd">func</span> <span class="nx">Split</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="nx">file</span> <span class="kt">string</span><span class="p">)</span>                <span class="c1">// 分割成目录，文件名两部分</span>
<span class="kd">func</span> <span class="nx">Clean</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span>                            <span class="c1">// 整理路径，去除多余的字符</span>
<span class="kd">func</span> <span class="nx">Join</span><span class="p">(</span><span class="nx">elem</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="kt">string</span>                          <span class="c1">// 将多个路径前后添加/后合并，并Clean</span>
<span class="kd">func</span> <span class="nx">Ext</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span>                              <span class="c1">// 文件的扩展名</span>
<span class="kd">func</span> <span class="nx">IsAbs</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span>                              <span class="c1">// 判断是否绝对路径</span>
<span class="kd">func</span> <span class="nx">Match</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">matched</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">e</span> <span class="kt">error</span><span class="p">)</span>  <span class="c1">// 模糊匹配</span>
</code></pre></div>

<h3 id="pathfilepath">path/filepath</h3>
<p>平台无关的路径操作。除了支持上面的<code>path</code>包中的路径操作之外，还提供了一些工具函数，方便路径处理。</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">ToSlash</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span>                         <span class="c1">// 将 \\ 替换为 /</span>
<span class="kd">func</span> <span class="nx">FromSlash</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span>                       <span class="c1">// 将 / 替换为 \\</span>
<span class="kd">func</span> <span class="nx">SplitList</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="p">[]</span><span class="kt">string</span>                     <span class="c1">// 分割 /a/b:/a/c 或者 c:\a\;c:\b\</span>
<span class="kd">func</span> <span class="nx">EvalSymlinks</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>           <span class="c1">// 符号链接的源文件</span>
<span class="kd">func</span> <span class="nx">Abs</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>                    <span class="c1">// 返回绝对路径，如果不是绝对路径添加当前工作路径</span>
<span class="kd">func</span> <span class="nx">IsAbs</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">b</span> <span class="kt">bool</span><span class="p">)</span>                         <span class="c1">// 判断是否为绝对路径</span>
<span class="kd">func</span> <span class="nx">Glob</span><span class="p">(</span><span class="nx">pattern</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">matches</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>  <span class="c1">// 路径匹配，返回所有匹配的文件或者目录</span>
<span class="kd">func</span> <span class="nx">Rel</span><span class="p">(</span><span class="nx">basepath</span><span class="p">,</span> <span class="nx">targpath</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>      <span class="c1">// 相对路径</span>
<span class="kd">func</span> <span class="nx">VolumeName</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span>                      <span class="c1">// 磁盘名称</span>
<span class="kd">func</span> <span class="nx">Walk</span><span class="p">(</span><span class="nx">root</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">walkFn</span> <span class="nx">WalkFunc</span><span class="p">)</span> <span class="kt">error</span>            <span class="c1">// 遍历所有文件，并调用自定义处理函数</span>
</code></pre></div>

<h2 id="_11">随机数</h2>
<p>math/rand包提供了随机数生成的相关函数。</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">Seed</span><span class="p">(</span><span class="nx">seed</span> <span class="kt">int64</span><span class="p">)</span>                                    <span class="c1">// 初始化种子值</span>
<span class="kd">func</span> <span class="nx">Int63</span><span class="p">()</span> <span class="kt">int64</span>
<span class="kd">func</span> <span class="nx">Uint32</span><span class="p">()</span> <span class="kt">uint32</span>
<span class="kd">func</span> <span class="nx">Uint64</span><span class="p">()</span> <span class="kt">uint64</span>
<span class="kd">func</span> <span class="nx">Int31</span><span class="p">()</span> <span class="kt">int32</span>
<span class="kd">func</span> <span class="nx">Int</span><span class="p">()</span> <span class="kt">int</span>
<span class="kd">func</span> <span class="nx">Int63n</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int64</span><span class="p">)</span> <span class="kt">int64</span>                               <span class="c1">// [0,n)</span>
<span class="kd">func</span> <span class="nx">Int31n</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int32</span><span class="p">)</span> <span class="kt">int32</span>                               <span class="c1">// [0,n)</span>
<span class="kd">func</span> <span class="nx">Intn</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span>                                     <span class="c1">// [0,n)</span>
<span class="kd">func</span> <span class="nx">Float64</span><span class="p">()</span> <span class="kt">float64</span>                                   <span class="c1">// [0.0,1.0)</span>
<span class="kd">func</span> <span class="nx">Float32</span><span class="p">()</span> <span class="kt">float32</span>                                   <span class="c1">// [0.0,1.0)</span>
<span class="kd">func</span> <span class="nx">Perm</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="p">[]</span><span class="kt">int</span>                                   <span class="c1">// [0,n)</span>
<span class="kd">func</span> <span class="nx">Shuffle</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">swap</span> <span class="kd">func</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span> <span class="kt">int</span><span class="p">))</span>  
<span class="kd">func</span> <span class="nx">Read</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">NormFloat64</span><span class="p">()</span> <span class="kt">float64</span>                               <span class="c1">// 正态分布</span>
<span class="kd">func</span> <span class="nx">ExpFloat64</span><span class="p">()</span> <span class="kt">float64</span>                                <span class="c1">// 指数分布</span>
</code></pre></div>

<p>还提供了生成新的随机源的函数接口。</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">NewSource</span><span class="p">(</span><span class="nx">seed</span> <span class="kt">int64</span><span class="p">)</span> <span class="nx">Source</span>
<span class="kd">func</span> <span class="nx">New</span><span class="p">(</span><span class="nx">src</span> <span class="nx">Source</span><span class="p">)</span> <span class="o">*</span><span class="nx">Rand</span>
<span class="c1">// Rand类型支持上面给出的随机数生成函数，但是非并发安全</span>
</code></pre></div>

<p>提供了zipf分布的随机数接口。</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">NewZipf</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Rand</span><span class="p">,</span> <span class="nx">s</span> <span class="kt">float64</span><span class="p">,</span> <span class="nx">v</span> <span class="kt">float64</span><span class="p">,</span> <span class="nx">imax</span> <span class="kt">uint64</span><span class="p">)</span> <span class="o">*</span><span class="nx">Zipf</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">z</span> <span class="o">*</span><span class="nx">Zipf</span><span class="p">)</span> <span class="nx">Uint64</span><span class="p">()</span> <span class="kt">uint64</span>
</code></pre></div>

<h2 id="_12">数据存储</h2>
<h3 id="encodingjson">encoding/json</h3>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">TestMarshal</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">type</span> <span class="nx">ColorGroup</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">ID</span>     <span class="kt">int</span>
        <span class="nx">Name</span>   <span class="kt">string</span>
        <span class="nx">Colors</span> <span class="p">[]</span><span class="kt">string</span>
    <span class="p">}</span>
    <span class="nx">group</span> <span class="o">:=</span> <span class="nx">ColorGroup</span><span class="p">{</span>
        <span class="nx">ID</span><span class="p">:</span>     <span class="mi">1</span><span class="p">,</span>
        <span class="nx">Name</span><span class="p">:</span>   <span class="s">&quot;Reds&quot;</span><span class="p">,</span>
        <span class="nx">Colors</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;Crimson&quot;</span><span class="p">,</span> <span class="s">&quot;Red&quot;</span><span class="p">,</span> <span class="s">&quot;Ruby&quot;</span><span class="p">,</span> <span class="s">&quot;Maroon&quot;</span><span class="p">},</span>
    <span class="p">}</span>
    <span class="nx">b</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">MarshalIndent</span><span class="p">(</span><span class="nx">group</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;\t&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;error:&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">{</span>
<span class="cm">    &quot;ID&quot;: 1,</span>
<span class="cm">    &quot;Name&quot;: &quot;Reds&quot;,</span>
<span class="cm">    &quot;Colors&quot;: [</span>
<span class="cm">        &quot;Crimson&quot;,</span>
<span class="cm">        &quot;Red&quot;,</span>
<span class="cm">        &quot;Ruby&quot;,</span>
<span class="cm">        &quot;Maroon&quot;</span>
<span class="cm">    ]</span>
<span class="cm">}</span>
<span class="cm">*/</span>

<span class="kd">func</span> <span class="nx">TestUnmarshal</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">jsonBlob</span> <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`</span>
<span class="s">[</span>
<span class="s">    {</span>
<span class="s">        &quot;Name&quot;: &quot;Platypus&quot;,</span>
<span class="s">        &quot;Order&quot;: &quot;Monotremata&quot;</span>
<span class="s">    },</span>
<span class="s">    {</span>
<span class="s">        &quot;Name&quot;: &quot;Quoll&quot;,</span>
<span class="s">        &quot;Order&quot;: &quot;Dasyuromorphia&quot;</span>
<span class="s">    }</span>
<span class="s">]</span>
<span class="s">`</span><span class="p">)</span>
    <span class="kd">type</span> <span class="nx">Animal</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">Name</span>  <span class="kt">string</span>
        <span class="nx">Order</span> <span class="kt">string</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">animals</span> <span class="p">[]</span><span class="nx">Animal</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">jsonBlob</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">animals</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;error:&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%+v\n&quot;</span><span class="p">,</span> <span class="nx">animals</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// [{Name:Platypus Order:Monotremata} {Name:Quoll Order:Dasyuromorphia}]</span>
</code></pre></div>

<p><a href="https://blog.golang.org/json">https://blog.golang.org/json</a></p>
<p><a href="https://www.json.org/json-zh.html">https://www.json.org/json-zh.html</a></p>
<h2 id="_13">不安全类型</h2>
<h3 id="unsafe">unsafe</h3>
<p>Pointer是任意类型的指针，可以指向任意类型数据。主要用于转换各种类型。</p>
<p>在golang中uintptr的定义是 <strong>type uintptr uintptr</strong> uintptr是golang的内置类型，是能存储指针的整型。</p>
<ol>
<li>任何类型的指针都可以被转化为Pointer</li>
<li>Pointer可以被转化为任何类型的指针</li>
<li>uintptr可以被转化为Pointer</li>
<li>Pointer可以被转化为uintptr</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1">// ArbitraryType仅用于文档目的，实际上并不是unsafe包的一部分,它表示任意Go表达式的类型。</span>
<span class="kd">type</span> <span class="nx">ArbitraryType</span> <span class="kt">int</span>
<span class="c1">// 任意类型的指针，类似于C的*void</span>
<span class="kd">type</span> <span class="nx">Pointer</span> <span class="o">*</span><span class="nx">ArbitraryType</span>
<span class="c1">// 确定结构在内存中占用的确切大小</span>
<span class="kd">func</span> <span class="nx">Sizeof</span><span class="p">(</span><span class="nx">x</span> <span class="nx">ArbitraryType</span><span class="p">)</span> <span class="kt">uintptr</span>
<span class="c1">// 返回结构体中某个field的偏移量</span>
<span class="kd">func</span> <span class="nx">Offsetof</span><span class="p">(</span><span class="nx">x</span> <span class="nx">ArbitraryType</span><span class="p">)</span> <span class="kt">uintptr</span>
<span class="c1">// 返回结构体中某个field的对其值（字节对齐的原因）</span>
<span class="kd">func</span> <span class="nx">Alignof</span><span class="p">(</span><span class="nx">x</span> <span class="nx">ArbitraryType</span><span class="p">)</span> <span class="kt">uintptr</span>


<span class="kd">func</span> <span class="nx">Float64bits</span><span class="p">(</span><span class="nx">f</span> <span class="kt">float64</span><span class="p">)</span> <span class="kt">uint64</span> <span class="p">{</span>
  <span class="c1">// 无法直接转换，报错：Connot convert expression of type *float64 to type *uint64</span>
  <span class="c1">// return *(*uint64)(&amp;f)   </span>

  <span class="c1">// 先把*float64 转成 Pointer(描述1)，再把Pointer转成*uint64(描述2)</span>
  <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">uint64</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">f</span><span class="p">))</span> 
<span class="p">}</span>
</code></pre></div>

<p>注意：<em>有时候垃圾回收器会移动一些变量以降低内存碎片等问题。这类垃圾回收器被称为移动GC。当一个变量被移动，所有的保存改变量旧地址的指针必须同时被更新为变量移动后的新地址。从垃圾收集器的视角来看，一个unsafe.Pointer是一个指向变量的指针，因此当变量被移动是对应的指针也必须被更新；但是uintptr类型的临时变量只是一个普通的数字，所以其值不应该被改变。</em></p>
<h2 id="_14">命令行参数</h2>
<h3 id="flag">flag</h3>
<p>包flag实现了命令行参数的解析。</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="nx">s</span> <span class="kt">string</span>
<span class="nx">flag</span><span class="p">.</span><span class="nx">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">s</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot;hello&quot;</span><span class="p">,</span> <span class="s">&quot;string flag&quot;</span><span class="p">)</span>
<span class="nx">b</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nx">Bool</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&quot;bool flag&quot;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">i</span> <span class="kt">int64</span>
<span class="nx">flag</span><span class="p">.</span><span class="nx">Int64Var</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">i</span><span class="p">,</span> <span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;int flag&quot;</span><span class="p">)</span>

<span class="nx">flag</span><span class="p">.</span><span class="nx">Parse</span><span class="p">()</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;bool:   &quot;</span><span class="p">,</span> <span class="o">*</span><span class="nx">b</span><span class="p">)</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;string: &quot;</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;int:    &quot;</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;args:   &quot;</span><span class="p">,</span> <span class="nx">flag</span><span class="p">.</span><span class="nx">Args</span><span class="p">())</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;nargs:  &quot;</span><span class="p">,</span> <span class="nx">flag</span><span class="p">.</span><span class="nx">NArg</span><span class="p">())</span>

<span class="c1">// ./main -b=true -i 32 -s=world a b c --d=true</span>
<span class="c1">// Output:</span>
<span class="c1">// bool:    true</span>
<span class="c1">// string:  world</span>
<span class="c1">// int:     32</span>
<span class="c1">// args:    [a b c --d=true]</span>
<span class="c1">// nargs:   4</span>
</code></pre></div>

<p>如果期望使用更强大的命令行参数处理可以使用下面的库：</p>
<p><a href="https://github.com/urfave/cli">https://github.com/urfave/cli</a> </p>
<p><a href="https://github.com/spf13/cobra">https://github.com/spf13/cobra</a></p>
<h2 id="_15">测试</h2>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">TestXxxx</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span>      <span class="c1">// 基本测试用例</span>
<span class="kd">func</span> <span class="nx">BenchmarkXxxx</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="c1">// 压力测试用例</span>
<span class="kd">func</span> <span class="nx">ExampleXxx</span><span class="p">()</span>                <span class="c1">// 示例测试用例（控制台）</span>
<span class="kd">func</span> <span class="nx">TestMain</span><span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">M</span><span class="p">)</span>      <span class="c1">// 测试 Main 函数</span>
</code></pre></div>

<h3 id="_16">单元测试</h3>
<ol>
<li>
<p>go test 自动执行，_test.go结尾的文件中的 <code>func TestXxxx(*testing.t)</code> 所有函数。</p>
</li>
<li>
<p>使用 <code>Error</code>，<code>Fail</code> 或相关方法来发出失败信号。</p>
</li>
<li>
<p>基于表驱动的批量测试</p>
</li>
<li>
<p>传递给测试函数的参数是：<code>*testing.T</code>，用于管理测试状态并支持格式化测试日志。</p>
</li>
<li>
<p>使用 <code>log</code>，<code>logf</code> 打印信息，默认不打印，通过 <code>-v</code> 参数输出。（对于基准测试，总是会被输出）。
    <div class="highlight"><pre><span></span><code><span class="nx">Fail</span><span class="p">()</span>           <span class="c1">// 测试失败，测试继续，也就是之后的代码依然会执行</span>
<span class="nx">FailNow</span>          <span class="c1">// 测试失败，测试中断 runtime.Goexit()</span>
<span class="nx">SkipNow</span>          <span class="c1">// 跳过测试，测试中断 runtime.Goexit()</span>
<span class="nx">Log</span>              <span class="c1">// 输出信息</span>
<span class="nx">Logf</span>             <span class="c1">// 输出格式化的信息</span>
<span class="nx">Skip</span>             <span class="c1">// 相当于 Log + SkipNow</span>
<span class="nx">Skipf</span>            <span class="c1">// 相当于 Logf + SkipNow</span>
<span class="nx">Error</span>            <span class="c1">// 相当于 Log + Fail</span>
<span class="nx">Errorf</span>           <span class="c1">// 相当于 Logf + Fail</span>
<span class="nx">Fatal</span>            <span class="c1">// 相当于 Log + FailNow</span>
<span class="nx">Fatalf</span>           <span class="c1">// 相当于 Logf + FailNow</span>
</code></pre></div></p>
</li>
</ol>
<h3 id="_17">基准测试</h3>
<ol>
<li><code>func BenchmarkXxx(*testing.B)</code></li>
<li>go test -bench 按顺序执行</li>
<li>自动跑N次，最长1s</li>
<li>go test -benchmem 内存统计</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">BenchmarkHello</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// BenchmarkHello-4     14858886            78.8 ns/op</span>
<span class="c1">//                      运行次数              每次循环耗时</span>
</code></pre></div>

<h3 id="_18">子测试</h3>
<p>使用 t.Run() 执行多个测试用例。</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">TestFoo</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// &lt;setup code&gt;</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;A=1&quot;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{})</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;A=2&quot;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{})</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;B=1&quot;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{})</span>
    <span class="c1">// &lt;tear-down code&gt;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="_19">示例测试</h3>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">ExampleHello</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">)</span>
    <span class="c1">// Output: Hello</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="_20">覆盖率测试</h3>
<p>执行命令 go test -cover 覆盖率测试</p>
<h2 id="_21">错误</h2>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">BazError</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Reason</span> <span class="kt">string</span>
    <span class="nx">Inner</span>  <span class="kt">error</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="nx">BazError</span><span class="p">)</span> <span class="nx">Error</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Inner</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;baz error: %s: %v&quot;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Reason</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Inner</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;baz error: %s&quot;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Reason</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="nx">BazError</span><span class="p">)</span> <span class="nx">Unwrap</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Inner</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;new error&quot;</span><span class="p">)</span>            <span class="c1">// 生成新的error</span>
    <span class="nx">err</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;fmt %s&quot;</span><span class="p">,</span> <span class="s">&quot;error&quot;</span><span class="p">)</span>       <span class="c1">// 格式化并生成新的error</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>

    <span class="nx">bzErr</span> <span class="o">:=</span> <span class="nx">BazError</span><span class="p">{</span><span class="s">&quot;wrap error&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">}</span>      <span class="c1">// wrap error</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">bzErr</span><span class="p">)</span>
    <span class="nx">err1</span> <span class="o">:=</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">Unwrap</span><span class="p">(</span><span class="nx">bzErr</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err1</span><span class="p">)</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">err1</span><span class="p">))</span>         <span class="c1">// true</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">bzErr</span><span class="p">))</span>        <span class="c1">// false</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">bzErr</span><span class="p">.</span><span class="nx">Inner</span><span class="p">))</span>  <span class="c1">// true</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">As</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">bzErr</span><span class="p">))</span>       <span class="c1">// false</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">As</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">bzErr</span><span class="p">.</span><span class="nx">Inner</span><span class="p">))</span> <span class="c1">// true</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">As</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">err</span><span class="p">))</span>         <span class="c1">// true</span>

    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="s">&quot;non-existing&quot;</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">pathError</span> <span class="o">*</span><span class="nx">os</span><span class="p">.</span><span class="nx">PathError</span>
        <span class="k">if</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">As</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">pathError</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Failed at path:&quot;</span><span class="p">,</span> <span class="nx">pathError</span><span class="p">.</span><span class="nx">Path</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">fmt error</span>
<span class="cm">baz error: wrap error: fmt error</span>
<span class="cm">fmt error</span>
<span class="cm">true</span>
<span class="cm">false</span>
<span class="cm">true</span>
<span class="cm">false</span>
<span class="cm">true</span>
<span class="cm">true</span>
<span class="cm">Failed at path: non-existing</span>
<span class="cm">*/</span>
</code></pre></div>

<h2 id="_22">反射</h2>
<p>在计算机科学领域，反射是指一类应用，它们能够自描述和自控制。也就是说，这类应用通过采用某种机制来实现对自己行为的描述（self-representation）和监测（examination），并能根据自身行为的状态和结果，调整或修改应用所描述行为的状态和相关的语义。</p>
<p>每种语言的反射模型都不同，并且有些语言根本不支持反射。Golang语言实现了反射，反射机制就是在运行时动态的调用对象的方法和属性，官方自带的reflect包就是反射相关的，只要包含这个包就可以使用。</p>
<p>Golang的gRPC也是通过反射实现的。</p>
<p>reflect包实现了运行时反射，允许程序操作任意类型的对象。典型的用法是获取一个具有静态类型<code>interface{}</code>的值，并通过调用<code>TypeOf</code>来提取其动态类型信息，后者将返回一个类型。对<code>ValueOf</code>的调用返回一个表示运行时数据的值。Zero接受一个类型并返回一个表示该类型的零值的值。</p>
<ol>
<li>接口</li>
<li>从接口值到反射对象。</li>
<li>从反射对象转换到接口值。</li>
<li>要修改反射对象，该值必须是可设置的。</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">ExampleReflect</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;== 1. Reflection goes from interface value to reflection object.&quot;</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="kt">float64</span> <span class="p">=</span> <span class="mf">3.4</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;type:&quot;</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">x</span><span class="p">))</span>

    <span class="kd">type</span> <span class="nx">MyStruct</span> <span class="kd">struct</span><span class="p">{</span> <span class="nx">i</span> <span class="kt">int</span> <span class="p">}</span>

    <span class="nx">s</span> <span class="o">:=</span> <span class="nx">MyStruct</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;type:&quot;</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span>

    <span class="nx">v</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">ValueOf</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;value:&quot;</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;value String:&quot;</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">String</span><span class="p">())</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;value Kind:&quot;</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">Kind</span><span class="p">())</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;value Type:&quot;</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">Type</span><span class="p">())</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;== 2. Reflection goes from reflection object to interface value.&quot;</span><span class="p">)</span>
    <span class="nx">y</span> <span class="o">:=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">Interface</span><span class="p">().(</span><span class="kt">float64</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">Interface</span><span class="p">())</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;== 3. To modify a reflection object, the value must be settable.&quot;</span><span class="p">)</span>
    <span class="nx">v</span> <span class="p">=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">ValueOf</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;settability of v:&quot;</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">CanSet</span><span class="p">())</span>

    <span class="nx">p</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">ValueOf</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">x</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;settability of p:&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">CanSet</span><span class="p">())</span>

    <span class="c1">// The reflection object p isn&#39;t settable, but it&#39;s not p we want to set</span>

    <span class="nx">e</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Elem</span><span class="p">()</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;settability of e:&quot;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">CanSet</span><span class="p">())</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">SetFloat</span><span class="p">(</span><span class="mf">7.1</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">Interface</span><span class="p">())</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;== Structs&quot;</span><span class="p">)</span>
    <span class="kd">type</span> <span class="nx">T</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">A</span> <span class="kt">int</span>
        <span class="nx">B</span> <span class="kt">string</span>
    <span class="p">}</span>
    <span class="nx">t</span> <span class="o">:=</span> <span class="nx">T</span><span class="p">{</span><span class="mi">23</span><span class="p">,</span> <span class="s">&quot;skidoo&quot;</span><span class="p">}</span>
    <span class="nx">u</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">ValueOf</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">t</span><span class="p">).</span><span class="nx">Elem</span><span class="p">()</span>
    <span class="nx">typeOfT</span> <span class="o">:=</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Type</span><span class="p">()</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">u</span><span class="p">.</span><span class="nx">NumField</span><span class="p">();</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">f</span> <span class="o">:=</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Field</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%d: %s %s = %v\n&quot;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span>
            <span class="nx">typeOfT</span><span class="p">.</span><span class="nx">Field</span><span class="p">(</span><span class="nx">i</span><span class="p">).</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Type</span><span class="p">(),</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Interface</span><span class="p">())</span>
    <span class="p">}</span>

    <span class="nx">u</span><span class="p">.</span><span class="nx">Field</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">SetInt</span><span class="p">(</span><span class="mi">77</span><span class="p">)</span>
    <span class="nx">u</span><span class="p">.</span><span class="nx">Field</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">SetString</span><span class="p">(</span><span class="s">&quot;Sunset&quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;t is now&quot;</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;== func for any type&quot;</span><span class="p">)</span>
    <span class="nx">swap</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">in</span> <span class="p">[]</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span> <span class="p">[]</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">Value</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[]</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">Value</span><span class="p">{</span><span class="nx">in</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">in</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
    <span class="p">}</span>

    <span class="nx">makeSwap</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">fptr</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
        <span class="nx">fn</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">ValueOf</span><span class="p">(</span><span class="nx">fptr</span><span class="p">).</span><span class="nx">Elem</span><span class="p">()</span>
        <span class="nx">v</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">MakeFunc</span><span class="p">(</span><span class="nx">fn</span><span class="p">.</span><span class="nx">Type</span><span class="p">(),</span> <span class="nx">swap</span><span class="p">)</span>
        <span class="nx">fn</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// Make and call a swap function for ints.</span>
    <span class="kd">var</span> <span class="nx">intSwap</span> <span class="kd">func</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span>
    <span class="nx">makeSwap</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">intSwap</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">intSwap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1">// Make and call a swap function for float64s.</span>
    <span class="kd">var</span> <span class="nx">floatSwap</span> <span class="kd">func</span><span class="p">(</span><span class="kt">float64</span><span class="p">,</span> <span class="kt">float64</span><span class="p">)</span> <span class="p">(</span><span class="kt">float64</span><span class="p">,</span> <span class="kt">float64</span><span class="p">)</span>
    <span class="nx">makeSwap</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">floatSwap</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">floatSwap</span><span class="p">(</span><span class="mf">2.72</span><span class="p">,</span> <span class="mf">3.14</span><span class="p">))</span>

    <span class="c1">// Output:</span>
    <span class="c1">// == 1. Reflection goes from interface value to reflection object.</span>
    <span class="c1">// type: float64</span>
    <span class="c1">// type: main.MyStruct</span>
    <span class="c1">// value: 3.4</span>
    <span class="c1">// value String: &lt;float64 Value&gt;</span>
    <span class="c1">// value Kind: float64</span>
    <span class="c1">// value Type: float64</span>
    <span class="c1">// == 2. Reflection goes from reflection object to interface value.</span>
    <span class="c1">// 3.4</span>
    <span class="c1">// 3.4</span>
    <span class="c1">// == 3. To modify a reflection object, the value must be settable.</span>
    <span class="c1">// settability of v: false</span>
    <span class="c1">// settability of p: false</span>
    <span class="c1">// settability of e: true</span>
    <span class="c1">// 7.1</span>
    <span class="c1">// 7.1</span>
    <span class="c1">// == Structs</span>
    <span class="c1">// 0: A int = 23</span>
    <span class="c1">// 1: B string = skidoo</span>
    <span class="c1">// t is now {77 Sunset}</span>
    <span class="c1">// == func for any type</span>
    <span class="c1">// 1 0</span>
    <span class="c1">// 3.14 2.72</span>
<span class="p">}</span>
</code></pre></div>

<p>一旦你理解了这些法则，在Go中使用反射就会变得更容易使用，尽管它仍然很微妙。这是一种强有力的工具，除非非常必要，否则应谨慎使用和避免使用。</p>
<p>关于反射还有很多我们还没有讲到的 —— 通过通道发送和接收，分配内存，使用切片和映射，调用方法和函数 —— 但是这篇文章足够长了。我们将在后面的文章中讨论其中的一些主题。</p>
<p><a href="https://juejin.cn/post/6844903559335526407">Golang的反射reflect深入理解和示例</a></p>
<h2 id="_23">同步</h2>
<p>包 sync 提供了基本的同步原语，比如互斥锁。除了Once和WaitGroup类型之外，大多数都是用于底层库。更高级别的同步最好通过通道来完成。</p>
<p>此包中定义的类型的值不能被复制（比如sync.Mutex，被复制后加锁，起不到保护作用）。</p>
<p>主要包括：</p>
<ol>
<li>Mutex</li>
<li>RWMutex</li>
<li>WaitGroup</li>
<li>Once: 仅执行一次动作</li>
<li>Pool</li>
<li>Map</li>
<li>Cond</li>
<li>Locker接口</li>
</ol>
<h3 id="once">Once</h3>
<p>并发运行10个协程，once.Do 保证函数只会被调用一次。</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="nx">once</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Once</span>
<span class="nx">onceBody</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;only once&quot;</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">done</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span>

<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">once</span><span class="p">.</span><span class="nx">Do</span><span class="p">(</span><span class="nx">onceBody</span><span class="p">)</span>
        <span class="nx">done</span> <span class="o">&lt;-</span> <span class="kc">true</span>
    <span class="p">}()</span>
<span class="p">}</span>
<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
    <span class="o">&lt;-</span><span class="nx">done</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="pool">Pool</h3>
<p>日志打印时直接获取 Pool 中缓存的 Buffer，避免每次分配。</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="nx">bufPool</span> <span class="p">=</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Pool</span><span class="p">{</span>
    <span class="nx">New</span><span class="p">:</span> <span class="kd">func</span><span class="p">()</span> <span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span>
        <span class="c1">// The Pool&#39;s New function should generally only return pointer</span>
        <span class="c1">// types, since a pointer can be put into the return interface</span>
        <span class="c1">// value without an allocation:</span>
        <span class="k">return</span> <span class="nb">new</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">)</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="c1">// timeNow is a fake version of time.Now for tests.</span>
<span class="kd">func</span> <span class="nx">timeNow</span><span class="p">()</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Unix</span><span class="p">(</span><span class="mi">1136214245</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">Log</span><span class="p">(</span><span class="nx">w</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">b</span> <span class="o">:=</span> <span class="nx">bufPool</span><span class="p">.</span><span class="nx">Get</span><span class="p">().(</span><span class="o">*</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">)</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">Reset</span><span class="p">()</span>
    <span class="c1">// Replace this with time.Now() in a real logger.</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="nx">timeNow</span><span class="p">().</span><span class="nx">UTC</span><span class="p">().</span><span class="nx">Format</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">RFC3339</span><span class="p">))</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">WriteByte</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">)</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">WriteByte</span><span class="p">(</span><span class="sc">&#39;=&#39;</span><span class="p">)</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
    <span class="nx">w</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">())</span>
    <span class="nx">bufPool</span><span class="p">.</span><span class="nx">Put</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">Log</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span> <span class="s">&quot;path&quot;</span><span class="p">,</span> <span class="s">&quot;/search?q=flowers&quot;</span><span class="p">)</span>
    <span class="nx">Log</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span> <span class="s">&quot;path&quot;</span><span class="p">,</span> <span class="s">&quot;/search?q=animals&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="waitgroup">WaitGroup</h3>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
    <span class="kd">var</span> <span class="nx">urls</span> <span class="p">=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span>
        <span class="s">&quot;http://www.baidu.com/&quot;</span><span class="p">,</span>
        <span class="s">&quot;http://www.sina.com/&quot;</span><span class="p">,</span>
        <span class="s">&quot;http://www.github.com/&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">url</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">urls</span> <span class="p">{</span>
        <span class="nx">wg</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">url</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nx">Done</span><span class="p">()</span>
            <span class="nx">rsp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;get url&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="p">}</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">rsp</span><span class="p">.</span><span class="nx">Status</span><span class="p">)</span>
        <span class="p">}(</span><span class="nx">url</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="map">Map</h3>
<p>Map 类似于 Go-Map[interface{}]interface{}，但是对于多个goroutine并发使用是安全的，无需额外的锁定或协调。加载、存储和删除以摊余固定时间运行。</p>
<p>Map 类型是专用的。大多数代码应该使用一个普通的Go映射，并使用单独的锁或协调，以获得更好的类型安全性，并且更容易维护映射内容中的其他不变量。</p>
<p>Map 类型针对两种常见的用例进行了优化：
1. 当给定键的条目只被写入一次而多次被读取时，例如在只会增长的缓存中；
2. 当多个goroutine对不相交的键集进行读、写和重写时。在这两种情况下，与单独的Mutex或RWMutex配对的Go-Map相比，使用Map可以显著减少锁争用。</p>
<p>Zero 映射是空的，可以使用。Map 第一次使用后不得复制。</p>
<h3 id="cond">Cond</h3>
<p>Cond实现了一个条件变量，它是goroutines等待或发布事件发生的集合点。每个Cond都有一个关联的锁对象L(通常是 Mutex 或 RWMutex )，在更改条件和调用Wait方法时必须持有该锁。第一次使用后不能复制Cond。</p>
<h3 id="syncatomic">sync/atomic</h3>
<p>atomic提供了底层的原子内存原语用于实现同步算法。</p>
<p>这些函数需要小心地正确的使用。除了特殊的底层的应用，同步应该使用通道或者sync包中提供的功能来实现。通过通信来共享内存，不要通过共享内存来通信。</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">AddInt32</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">int32</span><span class="p">,</span> <span class="nx">delta</span> <span class="kt">int32</span><span class="p">)</span> <span class="p">(</span><span class="nx">new</span> <span class="kt">int32</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">AddInt64</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">int64</span><span class="p">,</span> <span class="nx">delta</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="nx">new</span> <span class="kt">int64</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">AddUint32</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">uint32</span><span class="p">,</span> <span class="nx">delta</span> <span class="kt">uint32</span><span class="p">)</span> <span class="p">(</span><span class="nx">new</span> <span class="kt">uint32</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">AddUint64</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">uint64</span><span class="p">,</span> <span class="nx">delta</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="nx">new</span> <span class="kt">uint64</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">AddUintptr</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">uintptr</span><span class="p">,</span> <span class="nx">delta</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="p">(</span><span class="nx">new</span> <span class="kt">uintptr</span><span class="p">)</span>

<span class="kd">func</span> <span class="nx">CompareAndSwapInt32</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">int32</span><span class="p">,</span> <span class="nx">old</span><span class="p">,</span> <span class="nx">new</span> <span class="kt">int32</span><span class="p">)</span> <span class="p">(</span><span class="nx">swapped</span> <span class="kt">bool</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">CompareAndSwapInt64</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">int64</span><span class="p">,</span> <span class="nx">old</span><span class="p">,</span> <span class="nx">new</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="nx">swapped</span> <span class="kt">bool</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">CompareAndSwapUint32</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">uint32</span><span class="p">,</span> <span class="nx">old</span><span class="p">,</span> <span class="nx">new</span> <span class="kt">uint32</span><span class="p">)</span> <span class="p">(</span><span class="nx">swapped</span> <span class="kt">bool</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">CompareAndSwapUint64</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">uint64</span><span class="p">,</span> <span class="nx">old</span><span class="p">,</span> <span class="nx">new</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="nx">swapped</span> <span class="kt">bool</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">CompareAndSwapUintptr</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">uintptr</span><span class="p">,</span> <span class="nx">old</span><span class="p">,</span> <span class="nx">new</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="p">(</span><span class="nx">swapped</span> <span class="kt">bool</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">CompareAndSwapPointer</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">old</span><span class="p">,</span> <span class="nx">new</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">(</span><span class="nx">swapped</span> <span class="kt">bool</span><span class="p">)</span>

<span class="kd">func</span> <span class="nx">LoadInt32</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">int32</span><span class="p">)</span> <span class="p">(</span><span class="nx">val</span> <span class="kt">int32</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">LoadInt64</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="nx">val</span> <span class="kt">int64</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">LoadUint32</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">uint32</span><span class="p">)</span> <span class="p">(</span><span class="nx">val</span> <span class="kt">uint32</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">LoadUint64</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="nx">val</span> <span class="kt">uint64</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">LoadUintptr</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">uintptr</span><span class="p">)</span> <span class="p">(</span><span class="nx">val</span> <span class="kt">uintptr</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">LoadPointer</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">(</span><span class="nx">val</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span>

<span class="kd">func</span> <span class="nx">StoreInt32</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">int32</span><span class="p">,</span> <span class="nx">val</span> <span class="kt">int32</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">StoreInt64</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">int64</span><span class="p">,</span> <span class="nx">val</span> <span class="kt">int64</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">StoreUint32</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">uint32</span><span class="p">,</span> <span class="nx">val</span> <span class="kt">uint32</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">StoreUint64</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">uint64</span><span class="p">,</span> <span class="nx">val</span> <span class="kt">uint64</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">StoreUintptr</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">uintptr</span><span class="p">,</span> <span class="nx">val</span> <span class="kt">uintptr</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">StorePointer</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">val</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span>

<span class="kd">func</span> <span class="nx">SwapInt32</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">int32</span><span class="p">,</span> <span class="nx">new</span> <span class="kt">int32</span><span class="p">)</span> <span class="p">(</span><span class="nx">old</span> <span class="kt">int32</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">SwapInt64</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">int64</span><span class="p">,</span> <span class="nx">new</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="nx">old</span> <span class="kt">int64</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">SwapUint32</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">uint32</span><span class="p">,</span> <span class="nx">new</span> <span class="kt">uint32</span><span class="p">)</span> <span class="p">(</span><span class="nx">old</span> <span class="kt">uint32</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">SwapUint64</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">uint64</span><span class="p">,</span> <span class="nx">new</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="nx">old</span> <span class="kt">uint64</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">SwapUintptr</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">uintptr</span><span class="p">,</span> <span class="nx">new</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="p">(</span><span class="nx">old</span> <span class="kt">uintptr</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">SwapPointer</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">new</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">(</span><span class="nx">old</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span>

<span class="kd">type</span> <span class="nx">Value</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// contains filtered or unexported fields</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">v</span> <span class="o">*</span><span class="nx">Value</span><span class="p">)</span> <span class="nx">Load</span><span class="p">()</span> <span class="p">(</span><span class="nx">x</span> <span class="kd">interface</span><span class="p">{})</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">v</span> <span class="o">*</span><span class="nx">Value</span><span class="p">)</span> <span class="nx">Store</span><span class="p">(</span><span class="nx">x</span> <span class="kd">interface</span><span class="p">{})</span>
</code></pre></div>

<h2 id="_24">网络</h2>
<h3 id="net">net</h3>
<p>net软件包为网络I/O提供了一个可移植的接口，包括TCP/IP、UDP、域名解析和Unix域套接字。</p>
<p>尽管包提供了对低级联网原语的访问，但是大多数客户端只需要Dial、Listen和Accept函数以及相关的Conn和Listener接口提供的基本接口。crypto/tls包使用相同的接口和类似的拨号和侦听函数。</p>
<p>简单的客户端，服务器程序示例：</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">client</span><span class="p">(</span><span class="nx">msg</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Dial</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;127.0.0.1:2345&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalln</span><span class="p">(</span><span class="s">&quot;client&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;client send: %s&quot;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">msg</span><span class="p">))</span>
    <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">msg</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalln</span><span class="p">(</span><span class="s">&quot;client&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">n</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalln</span><span class="p">(</span><span class="s">&quot;client write len:&quot;</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">server</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">ln</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listen</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;:2345&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalln</span><span class="p">(</span><span class="s">&quot;server&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">Accept</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalln</span><span class="p">(</span><span class="s">&quot;server&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">conn</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">defer</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
            <span class="nx">data</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
            <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalln</span><span class="p">(</span><span class="s">&quot;server&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;server recv: %s (%d bytes)&quot;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">data</span><span class="p">[:</span><span class="nx">n</span><span class="p">]),</span> <span class="nx">n</span><span class="p">)</span>
        <span class="p">}(</span><span class="nx">conn</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">go</span> <span class="nx">server</span><span class="p">()</span>
    <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
    <span class="nx">client</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">))</span>
    <span class="nx">client</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;world&quot;</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>

<p>还提供了 TCPListener，TCPConn, UDPConn等类型。</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">ListenTCP</span><span class="p">(</span><span class="nx">network</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">laddr</span> <span class="o">*</span><span class="nx">TCPAddr</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">TCPListener</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">TCPListener</span><span class="p">)</span> <span class="nx">Accept</span><span class="p">()</span> <span class="p">(</span><span class="nx">Conn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">TCPListener</span><span class="p">)</span> <span class="nx">AcceptTCP</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">TCPConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">TCPListener</span><span class="p">)</span> <span class="nx">Close</span><span class="p">()</span> <span class="kt">error</span>

<span class="kd">func</span> <span class="nx">DialTCP</span><span class="p">(</span><span class="nx">network</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">laddr</span><span class="p">,</span> <span class="nx">raddr</span> <span class="o">*</span><span class="nx">TCPAddr</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">TCPConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">TCPConn</span><span class="p">)</span> <span class="nx">Close</span><span class="p">()</span> <span class="kt">error</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">TCPConn</span><span class="p">)</span> <span class="nx">LocalAddr</span><span class="p">()</span> <span class="nx">Addr</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">TCPConn</span><span class="p">)</span> <span class="nx">Read</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">TCPConn</span><span class="p">)</span> <span class="nx">Write</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

<span class="kd">func</span> <span class="nx">ListenUDP</span><span class="p">(</span><span class="nx">network</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">laddr</span> <span class="o">*</span><span class="nx">UDPAddr</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">UDPConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">ListenMulticastUDP</span><span class="p">(</span><span class="nx">network</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">ifi</span> <span class="o">*</span><span class="nx">Interface</span><span class="p">,</span> <span class="nx">gaddr</span> <span class="o">*</span><span class="nx">UDPAddr</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">UDPConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

<span class="kd">func</span> <span class="nx">DialUDP</span><span class="p">(</span><span class="nx">network</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">laddr</span><span class="p">,</span> <span class="nx">raddr</span> <span class="o">*</span><span class="nx">UDPAddr</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">UDPConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">UDPConn</span><span class="p">)</span> <span class="nx">Close</span><span class="p">()</span> <span class="kt">error</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">UDPConn</span><span class="p">)</span> <span class="nx">Read</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">UDPConn</span><span class="p">)</span> <span class="nx">Write</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></div>

<p>还支持基于 IP 的连接处理，用于其它底层协议的处理。</p>
<h3 id="nethttp">net/http</h3>
<p>http包是通过net包来实现的。</p>
<p>简单的http客户端和服务器示例：</p>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">helloHandler</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">helloHandler</span><span class="p">)</span> <span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">io</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;hello\n&quot;</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nx">world</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">io</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;world\n&quot;</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nx">headers</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">headers</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Header</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">h</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">headers</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;%v: %v\n&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">h</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">&quot;/hello&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">helloHandler</span><span class="p">{})</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/world&quot;</span><span class="p">,</span> <span class="nx">world</span><span class="p">)</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/headers&quot;</span><span class="p">,</span> <span class="nx">headers</span><span class="p">)</span>
    <span class="k">go</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:8080&quot;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>

    <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>

    <span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
    <span class="nx">wg</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">go</span> <span class="nx">client</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">wg</span><span class="p">,</span> <span class="s">&quot;/hello&quot;</span><span class="p">)</span>
    <span class="k">go</span> <span class="nx">client</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">wg</span><span class="p">,</span> <span class="s">&quot;/world&quot;</span><span class="p">)</span>
    <span class="k">go</span> <span class="nx">client</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">wg</span><span class="p">,</span> <span class="s">&quot;/headers&quot;</span><span class="p">)</span>
    <span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">client</span><span class="p">(</span><span class="nx">wg</span> <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nx">Done</span><span class="p">()</span>
    <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;http://127.0.0.1:8080&quot;</span> <span class="o">+</span> <span class="nx">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalln</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
    <span class="nx">body</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadAll</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalln</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">body</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="netrpc">net/rpc</h3>
<p>rpc包提供了通过网络或者其它I/O连接方位一个对象导出的方法。一个服务器可以注册一个对象，将对象类型的名称作为一个可见的服务。在注册后，对象的导出方法可以被远程访问。一个服务器可以注册多个不同类型的对象（服务），但是注册同一个类型的多个对象会返回错误。</p>
<p>只有那些满足这些标准的方法才能被远程访问；其它方法将会被忽略：</p>
<ul>
<li>方法的类型是导出的</li>
<li>方法是导出的</li>
<li>方法有两个参数，都是导出（内置）的类型</li>
<li>方法的第二个参数是一个指针</li>
<li>方法返回错误类型</li>
</ul>
<p>实际上，该方法必须看起来大致类似：</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">T</span><span class="p">)</span> <span class="nx">MethodName</span><span class="p">(</span><span class="nx">argType</span> <span class="nx">T1</span><span class="p">,</span> <span class="nx">replyType</span> <span class="o">*</span><span class="nx">T2</span><span class="p">)</span> <span class="kt">error</span>
</code></pre></div>

<p>其中，T1和T2可以通过encoding/gob进行封送。即使使用不同的编解码器，这些要求也适用。（将来，这些要求可能会软化自定义编解码器。）</p>
<p>该方法的第一个参数表示调用方提供的参数；第二个参数表示要返回给调用方的结果参数。该方法的返回值（如果非nil）将作为字符串传回，客户端会将其视为由errors.New创建的字符串。如果返回错误，则不会将reply参数返回给客户端。</p>
<p>服务器可以通过调用ServeConn处理单个连接上的请求。更典型的是，它将创建一个网络侦听器并调用Accept，或者对于HTTP侦听器，调用HandleHTTP和http.Serve。</p>
<p>希望使用该服务的客户端先建立连接，然后在该连接上调用NewClient。方便函数Dial (DialHTTP)执行原始网络连接（HTTP连接）的两个步骤。生成的Client对象有两个方法，Call和Go，它们指定要调用的服务和方法、包含参数的指针和接收结果参数的指针。</p>
<p>Call方法等待远程调用完成，而Go方法异步启动调用并使用Call结构的Done通道发出完成信号。</p>
<p>除非设置了显式编解码器，否则使用包encoding/gob来传输数据。</p>
<p>这里有一个简单的例子。服务器希望导出Arith类型的对象：</p>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">Args</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">A</span><span class="p">,</span> <span class="nx">B</span> <span class="kt">int</span>
<span class="p">}</span>
<span class="kd">type</span> <span class="nx">Quotient</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Quo</span><span class="p">,</span> <span class="nx">Rem</span> <span class="kt">int</span>
<span class="p">}</span>
<span class="kd">type</span> <span class="nx">Arith</span> <span class="kt">int</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Arith</span><span class="p">)</span> <span class="nx">Multiply</span><span class="p">(</span><span class="nx">args</span> <span class="o">*</span><span class="nx">Args</span><span class="p">,</span> <span class="nx">reply</span> <span class="o">*</span><span class="kt">int</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="o">*</span><span class="nx">reply</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">A</span> <span class="o">*</span> <span class="nx">args</span><span class="p">.</span><span class="nx">B</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Arith</span><span class="p">)</span> <span class="nx">Divide</span><span class="p">(</span><span class="nx">args</span> <span class="o">*</span><span class="nx">Args</span><span class="p">,</span> <span class="nx">quo</span> <span class="o">*</span><span class="nx">Quotient</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">B</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;divide by zero&quot;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">quo</span><span class="p">.</span><span class="nx">Quo</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">A</span> <span class="o">/</span> <span class="nx">args</span><span class="p">.</span><span class="nx">B</span>
    <span class="nx">quo</span><span class="p">.</span><span class="nx">Rem</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">A</span> <span class="o">%</span> <span class="nx">args</span><span class="p">.</span><span class="nx">B</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">server</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">arith</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Arith</span><span class="p">)</span>
    <span class="nx">rpc</span><span class="p">.</span><span class="nx">Register</span><span class="p">(</span><span class="nx">arith</span><span class="p">)</span>
    <span class="nx">rpc</span><span class="p">.</span><span class="nx">HandleHTTP</span><span class="p">()</span>
    <span class="nx">l</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listen</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;:1234&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;listen error:&quot;</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">Serve</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">go</span> <span class="nx">server</span><span class="p">()</span>
    <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
    <span class="nx">client</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">client</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rpc</span><span class="p">.</span><span class="nx">DialHTTP</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;127.0.0.1:1234&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;dialing:&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// Synchronous call</span>
    <span class="nx">args</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Args</span><span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">}</span>
    <span class="kd">var</span> <span class="nx">reply</span> <span class="kt">int</span>
    <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Call</span><span class="p">(</span><span class="s">&quot;Arith.Multiply&quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">reply</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;arith error:&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Arith: %d * %d = %d\n&quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">A</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">B</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span>

    <span class="c1">// Asynchronous call</span>
    <span class="nx">args1</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">Args</span><span class="p">{</span><span class="nx">Args</span><span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="nx">Args</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">}}</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">args</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">args1</span> <span class="p">{</span>
        <span class="nx">quotient</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Quotient</span><span class="p">)</span>
        <span class="nx">divCall</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Go</span><span class="p">(</span><span class="s">&quot;Arith.Divide&quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">quotient</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="nx">replyCall</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">divCall</span><span class="p">.</span><span class="nx">Done</span> <span class="c1">// will be equal to divCall</span>
        <span class="k">if</span> <span class="nx">divCall</span><span class="p">.</span><span class="nx">Error</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Arith: %d / %d = %v\n&quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">A</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">B</span><span class="p">,</span> <span class="nx">replyCall</span><span class="p">.</span><span class="nx">Error</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="p">}</span>
        <span class="c1">// check errors, print, etc.</span>
        <span class="nx">res</span> <span class="o">:=</span> <span class="nx">replyCall</span><span class="p">.</span><span class="nx">Reply</span><span class="p">.(</span><span class="o">*</span><span class="nx">Quotient</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Arith: %d / %d = %d\n&quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">A</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">B</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Quo</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Arith: %d %% %d = %d\n&quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">A</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">B</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Rem</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">Arith: 7 * 8 = 56</span>
<span class="cm">Arith: 4 / 2 = 2</span>
<span class="cm">Arith: 4 % 2 = 0</span>
<span class="cm">Arith: 2 / 0 = divide by zero</span>
<span class="cm">*/</span>
</code></pre></div>

<p>rpc用于go语言之间的函数调用，服务器端定义函数，客户端调用服务器端的函数。</p>
<p>gRPC提供了跨语言之间的相互调用。gRPC基于http/2协议，支持流式调用接口。</p>
<h2 id="_25">日志</h2>
<h3 id="log">log</h3>
<p>log模块提供了简单的日志功能</p>
<ol>
<li>支持定制日志文件:行号，日期定制，日志前缀功能。</li>
<li>支持 Output, Println, Print, Panic, Fatal等接口</li>
<li>用户定义 Writer 接口，默认输出到 os.Stderr</li>
<li>不支持日志级别</li>
</ol>
<h2 id="_26">运行时</h2>
<p>运行时（runtime）包含了与Go runtime系统交互的操作，例如那些用于控制goroutine的函数。还包括了reflect包使用的底层类型信息，请参阅reflect的文档，了解运行时类型系统的可编程接口。</p>
<h3 id="_27">环境变量</h3>
<p>环境变量控制Go程序运行时的行为。</p>
<ul>
<li>GOGC 设置垃圾收集目标的百分值。</li>
<li>GOGC=100 （默认）</li>
<li>GOGC=off 可以完全关闭GC。</li>
<li>debug.SetGCPercent 函数可以设置百分值。</li>
<li>GODEBUG 控制运行时调试变量。是逗号分割的列表例如 </li>
<li>GODEBUG=gctrace=1</li>
<li>GODEBUG=scheddetail=1,schedtrace=2000    # 每2s输出一次 调度信息</li>
<li>还有其它更细致的参数用于控制GC，参考文档</li>
<li>GOMAXPROCS  变量限制可以同时执行用户级Go代码的操作系统线程数。对于可以代表Go代码在系统调用中阻塞的线程数没有限制；这些线程数不计入GOMAXPROCS限制。runtime包的GOMAXPROCS函数查询和更改限制。</li>
<li>GORACE 变量配置竞争检测器参数（添加了 -race 编译的程序）。</li>
<li><code>log_path</code> (default <code>stderr</code>): 日志输出路径</li>
<li><code>exitcode</code> (default <code>66</code>): 退出码</li>
<li><code>strip_path_prefix</code> (default <code>""</code>): 前缀</li>
<li>...</li>
<li>GOTRACEBACK 变量控制当Go程序由于未恢复的 panic 或意外的运行时条件而失败时生成的输出信息的数量。默认情况下，失败会打印当前goroutine 的堆栈跟踪，省略运行时系统内部的函数，然后以退出码2退出。如果当前没有goroutine在运行或者失败是运行时内部的，则失败时会打印所有goroutine的堆栈跟踪。</li>
<li>GOTRACEBACK=none 只输出panic异常信息。
    GOTRACEBACK=single 只输出被认为引发panic异常的那个goroutine的相关信息。
    GOTRACEBACK=all 输出所有goroutines的相关信息，除去与go runtime相关的stack frames.
    GOTRACEBACK=system 输出所有goroutines的相关信息，包括与go runtime相关的stack frames,从而得知哪些goroutine是go runtime启动运行的。
    GOTRACEBACK=crash 在system的基础上，go runtime触发进程segfault错误，从而生成core dump, 当然要操作系统允许的情况下， 而不是调用os.Exit。</li>
<li>由于历史原因， GOTRACEBACK设置0、1和2分别是none、all和system的同义词。</li>
<li>runtime/debug 的SetTraceback函数允许在运行时增加输出量，但不能将输出量减少到环境变量指定的量以下。</li>
<li>参见https://golang.org/pkg/runtime/debug/#SetTraceback。</li>
<li>GOARCH、GOOS、GOPATH和GOROOT环境变量组成了Go环境变量集。它们影响Go程序的构建（请参见https://golang.org/cmd/go和https://golang.org/pkg/go/build）。GOARCH、GOOS和GOROOT在编译时被记录，并且由该包中的常量或函数提供，但是它们不影响运行时系统的执行。</li>
</ul>
<h3 id="runtime">runtime</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Caller 报告有关调用goroutine堆栈上的函数调用的文件和行号信息。参数skip是要提升的堆栈帧数，其中0标识调用方。（由于历史原因，“skip”的含义在 Caller 和 Callers 之间有所不同。）返回值报告相应调用的文件内的程序计数器、文件名和行号。如果无法获得信息，则布尔ok为false。</span>
<span class="c1">// Callers调用goroutine的堆栈上的函数调用的返回程序计数器切片pc。参数skip是在pc中记录之前要跳过的堆栈帧数，其中0标识Callers本身的帧， 1标识调用Callers的调用者的帧。返回写入pc的条目数。</span>
<span class="kd">func</span> <span class="nx">Caller</span><span class="p">(</span><span class="nx">skip</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">pc</span> <span class="kt">uintptr</span><span class="p">,</span> <span class="nx">file</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">line</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">ok</span> <span class="kt">bool</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">Callers</span><span class="p">(</span><span class="nx">skip</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">pc</span> <span class="p">[]</span><span class="kt">uintptr</span><span class="p">)</span> <span class="kt">int</span>
<span class="kd">func</span> <span class="nx">CallersFrames</span><span class="p">(</span><span class="nx">callers</span> <span class="p">[]</span><span class="kt">uintptr</span><span class="p">)</span> <span class="o">*</span><span class="nx">Frames</span>
<span class="kd">func</span> <span class="nx">Stack</span><span class="p">(</span><span class="nx">buf</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">all</span> <span class="kt">bool</span><span class="p">)</span> <span class="kt">int</span>   <span class="c1">// 调用栈信息</span>

<span class="kd">func</span> <span class="nx">FuncForPC</span><span class="p">(</span><span class="nx">pc</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="o">*</span><span class="nx">Func</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">Func</span><span class="p">)</span> <span class="nx">FileLine</span><span class="p">(</span><span class="nx">pc</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="p">(</span><span class="nx">file</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">line</span> <span class="kt">int</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">GC</span><span class="p">()</span>

<span class="c1">// 设置可以同时执行的最大CPU的个数，返回前一次设置的值</span>
<span class="kd">func</span> <span class="nx">GOMAXPROCS</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span>

<span class="c1">// 当前进程使用的逻辑CPU的个数</span>
<span class="kd">func</span> <span class="nx">NumCPU</span><span class="p">()</span> <span class="kt">int</span>

<span class="kd">func</span> <span class="nx">NumCgoCall</span><span class="p">()</span> <span class="kt">int64</span>
<span class="kd">func</span> <span class="nx">NumGoroutine</span><span class="p">()</span> <span class="kt">int</span>

<span class="c1">// 终止当前的goroutine，不影响其他的goroutine</span>
<span class="c1">// 会调用所有 defer 注册的函数</span>
<span class="kd">func</span> <span class="nx">Goexit</span><span class="p">()</span>

<span class="c1">// 让出处理器，让其它goroutine运行，不会挂起当前goroutine，执行会自动恢复</span>
<span class="kd">func</span> <span class="nx">Gosched</span><span class="p">()</span>

<span class="c1">// 锁定当前线程，其它goroutine不会在这个线程上执行，直到 unlock，</span>
<span class="c1">// 如果没有unlock，线程在goroutine执行完后会被终止</span>
<span class="kd">func</span> <span class="nx">LockOSThread</span><span class="p">()</span>
<span class="kd">func</span> <span class="nx">UnlockOSThread</span><span class="p">()</span>

<span class="c1">// 设置一个断点，调试时会停下来</span>
<span class="kd">func</span> <span class="nx">Breakpoint</span><span class="p">()</span>

<span class="c1">// SetFinalizer设置为obj关联finalizer。当垃圾收集器发现一个具有关联终结器的无法访问的块时，它将清除关联并在一个单独的goroutine中运行终结器（obj）。这使目标再次可达，但是现在没有相关的终结器。假设SetFinalizer不再被调用，下一次垃圾回收器发现obj不可达时，它将释放obj。</span>
<span class="c1">// 使用场景 cache 的垃圾收集（参考：istio的中lrucache）</span>
<span class="kd">func</span> <span class="nx">SetFinalizer</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">finalizer</span> <span class="kd">interface</span><span class="p">{})</span>

<span class="kd">func</span> <span class="nx">ReadMemStats</span><span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">MemStats</span><span class="p">)</span>
<span class="kd">type</span> <span class="nx">MemStats</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Alloc</span> <span class="kt">uint64</span>
    <span class="nx">TotalAlloc</span> <span class="kt">uint64</span>
    <span class="nx">Sys</span> <span class="kt">uint64</span>
    <span class="nx">Lookups</span> <span class="kt">uint64</span>
    <span class="nx">Mallocs</span> <span class="kt">uint64</span>
    <span class="nx">Frees</span> <span class="kt">uint64</span>
    <span class="nx">HeapAlloc</span> <span class="kt">uint64</span>
    <span class="nx">HeapSys</span> <span class="kt">uint64</span>
    <span class="nx">HeapIdle</span> <span class="kt">uint64</span>
    <span class="nx">HeapInuse</span> <span class="kt">uint64</span>
    <span class="nx">HeapReleased</span> <span class="kt">uint64</span>
    <span class="nx">StackInuse</span> <span class="kt">uint64</span>
    <span class="nx">StackSys</span> <span class="kt">uint64</span>
    <span class="nx">NextGC</span> <span class="kt">uint64</span>
    <span class="nx">LastGC</span> <span class="kt">uint64</span>
    <span class="nx">NumGC</span> <span class="kt">uint32</span>
    <span class="nx">NumForcedGC</span> <span class="kt">uint32</span> <span class="c1">// Go 1.8</span>
    <span class="nx">EnableGC</span> <span class="kt">bool</span>
    <span class="nx">DebugGC</span> <span class="kt">bool</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">SetBlockProfileRate</span><span class="p">(</span><span class="nx">rate</span> <span class="kt">int</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">SetCPUProfileRate</span><span class="p">(</span><span class="nx">hz</span> <span class="kt">int</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">SetCgoTraceback</span><span class="p">(</span><span class="nx">version</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">traceback</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">symbolizer</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span>

<span class="kd">func</span> <span class="nx">BlockProfile</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="nx">BlockProfileRecord</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">ok</span> <span class="kt">bool</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">CPUProfile</span><span class="p">()</span> <span class="p">[]</span><span class="kt">byte</span>
<span class="kd">func</span> <span class="nx">GoroutineProfile</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="nx">StackRecord</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">ok</span> <span class="kt">bool</span><span class="p">)</span>
<span class="kd">func</span> <span class="nx">ThreadCreateProfile</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="nx">StackRecord</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">ok</span> <span class="kt">bool</span><span class="p">)</span>

<span class="kd">var</span> <span class="nx">MemProfileRate</span> <span class="kt">int</span> <span class="p">=</span> <span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span>
<span class="kd">func</span> <span class="nx">MemProfile</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="nx">MemProfileRecord</span><span class="p">,</span> <span class="nx">inuseZero</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">ok</span> <span class="kt">bool</span><span class="p">)</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">MemProfileRecord</span><span class="p">)</span> <span class="nx">Stack</span><span class="p">()</span> <span class="p">[]</span><span class="kt">uintptr</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">MemProfileRecord</span><span class="p">)</span> <span class="nx">InUseObjects</span><span class="p">()</span> <span class="kt">int64</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">MemProfileRecord</span><span class="p">)</span> <span class="nx">InUseBytes</span><span class="p">()</span> <span class="kt">int64</span>

<span class="c1">// 由 runtime.Trace 调用，实现当前进程的跟踪</span>
<span class="kd">func</span> <span class="nx">StartTrace</span><span class="p">()</span> <span class="kt">error</span>
<span class="kd">func</span> <span class="nx">ReadTrace</span><span class="p">()</span> <span class="p">[]</span><span class="kt">byte</span>
<span class="kd">func</span> <span class="nx">StopTrace</span><span class="p">()</span>
</code></pre></div>

<h3 id="runtimedebug">runtime/debug</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// 释放内存到OS</span>
<span class="kd">func</span> <span class="nx">FreeOSMemory</span><span class="p">()</span>

<span class="c1">// 将 runtime.Stack 返回的栈信息打印到标准错误输出</span>
<span class="kd">func</span> <span class="nx">PrintStack</span><span class="p">()</span>

<span class="c1">// 读取GC信息到 stats 中</span>
<span class="kd">func</span> <span class="nx">ReadGCStats</span><span class="p">(</span><span class="nx">stats</span> <span class="o">*</span><span class="nx">GCStats</span><span class="p">)</span>

<span class="c1">// 设置触发GC的百分比，默认100%，或者读取环境变量 GOGC 来设置</span>
<span class="kd">func</span> <span class="nx">SetGCPercent</span><span class="p">(</span><span class="nx">percent</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span>

<span class="c1">// 设置 goroutine 的栈大小，如果超过则会 </span>
<span class="c1">// 初始设置：64位系统1GB，32位系统250MB</span>
<span class="kd">func</span> <span class="nx">SetMaxStack</span><span class="p">(</span><span class="nx">bytes</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span>

<span class="c1">// 设置Go可以使用操作系统线程个数，默认10000个</span>
<span class="c1">// 限制控制了操作系统线程的个数，并不是goroutine的个数</span>
<span class="c1">// Go程序只有在程序准备运行，但所有现有线程在系统调用、cgo调用中被阻塞，或者由于使用runtime.LockOSThread而被锁定到其他程序时，才会创建新线程。</span>
<span class="kd">func</span> <span class="nx">SetMaxThreads</span><span class="p">(</span><span class="nx">threads</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span>

<span class="c1">// 控制运行时的的行为，不希望的地址（非nil），如runtime内存损坏</span>
<span class="kd">func</span> <span class="nx">SetPanicOnFault</span><span class="p">(</span><span class="nx">enabled</span> <span class="kt">bool</span><span class="p">)</span> <span class="kt">bool</span>

<span class="c1">// 设置crash时的打印信息级别，与GOTRACEBACK一样</span>
<span class="c1">// 如果SetTraceback低于环境变量，则设置被忽略</span>
<span class="kd">func</span> <span class="nx">SetTraceback</span><span class="p">(</span><span class="nx">level</span> <span class="kt">string</span><span class="p">)</span>

<span class="c1">// 返回当前调用的goroutine的格式化堆栈信息</span>
<span class="c1">// 用一个很大的缓冲区调用 runtime.Stack 来捕获整个跟踪</span>
<span class="kd">func</span> <span class="nx">Stack</span><span class="p">()</span> <span class="p">[]</span><span class="kt">byte</span>

<span class="c1">// WriteHeapDump将堆及其中的对象的描述写入给定的文件描述符。</span>
<span class="c1">// WriteHeapDump会挂起所有goroutine的执行，直到堆转储完全写入。因此，不能将文件描述符连接到其另一端位于同一Go进程中的管道或套接字；相反，应使用临时文件或网络套接字。</span>
<span class="c1">// 堆转储格式在https://golang.org/s/go15heapdump中定义。</span>
<span class="kd">func</span> <span class="nx">WriteHeapDump</span><span class="p">(</span><span class="nx">fd</span> <span class="kt">uintptr</span><span class="p">)</span>

<span class="c1">// 输出嵌入到运行二进制中的build信息，只有支持module的二进制可用</span>
<span class="kd">func</span> <span class="nx">ReadBuildInfo</span><span class="p">()</span> <span class="p">(</span><span class="nx">info</span> <span class="o">*</span><span class="nx">BuildInfo</span><span class="p">,</span> <span class="nx">ok</span> <span class="kt">bool</span><span class="p">)</span>
</code></pre></div>

<h3 id="runtimepprof">runtime/pprof</h3>
<p>pprof包将运行时分析数据以pprof可视化工具期望的格式写出。</p>
<p>分析一个Go程序</p>
<p>第一个步骤就是打开分析功能。有三种类型的性能分析：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 1. go test中内置了对使用标准测试包构建的性能分析基准的支持。例如，在当前目录下运行基准程序，将CPU和内存配置文件写入cpu.prof和mem.prof中。</span>
<span class="k">go</span> <span class="nx">test</span> <span class="o">-</span><span class="nx">cpuprofile</span> <span class="nx">cpu</span><span class="p">.</span><span class="nx">prof</span> <span class="o">-</span><span class="nx">memprofile</span> <span class="nx">mem</span><span class="p">.</span><span class="nx">prof</span> <span class="o">-</span><span class="nx">bench</span> <span class="p">.</span>

<span class="c1">// 2. 要向独立程序添加等效分析支持，请将以下代码添加到主函数中：</span>
<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">f1</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="s">&quot;cpuprofile&quot;</span><span class="p">)</span>
    <span class="nx">pprof</span><span class="p">.</span><span class="nx">StartCPUProfile</span><span class="p">(</span><span class="nx">f1</span><span class="p">)</span>
    <span class="k">defer</span> <span class="nx">pprof</span><span class="p">.</span><span class="nx">StopCPUProfile</span><span class="p">()</span>

    <span class="c1">// ... rest of the program ...</span>

    <span class="nx">f2</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="s">&quot;memprofile&quot;</span><span class="p">)</span>
    <span class="nx">runtime</span><span class="p">.</span><span class="nx">GC</span><span class="p">()</span> <span class="c1">// get up-to-date statistics</span>
    <span class="nx">pprof</span><span class="p">.</span><span class="nx">WriteHeapProfile</span><span class="p">(</span><span class="nx">f2</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 3. 还有一个标准的HTTP接口来分析数据。添加以下行将在/debug/pprof/ URL下安装处理程序以下载实时分析文件：</span>
<span class="kn">import</span> <span class="nx">_</span> <span class="s">&quot;net/http/pprof&quot;</span>
</code></pre></div>

<p>第二步是使用可视化工具进行分析：</p>
<div class="highlight"><pre><span></span><code><span class="k">go</span> <span class="nx">tool</span> <span class="nx">pprof</span> <span class="nx">cpu</span><span class="p">.</span><span class="nx">prof</span>
</code></pre></div>

<p>pprof命令行中有许多命令可用。常用的命令包括“top”（打印程序热点的摘要）和“web”（打开热点及其调用图的交互图）。有关所有pprof命令的信息，请使用“help”。</p>
<h3 id="runtimetrace">runtime/trace</h3>
<p>执行跟踪捕获范围广泛的执行事件，如goroutine创建/阻塞/解除阻塞、syscall进入/退出/额、GC相关事件、堆大小更改、处理器启动/停止等。大多数事件都会捕获精确的纳秒精度时间戳和堆栈跟踪。生成的跟踪可以使用 go 工具跟踪进行分析。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Example demonstrates the use of the trace package to trace</span>
<span class="c1">// the execution of a Go program. The trace output will be</span>
<span class="c1">// written to the file trace.out</span>
<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">f</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="s">&quot;trace.out&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;failed to create trace output file: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Close</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;failed to close trace file: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">Start</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;failed to start trace: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">Stop</span><span class="p">()</span>
    <span class="c1">// your program here</span>
    <span class="nx">RunMyProgram</span><span class="p">()</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nx">RunMyProgram</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;this function will be traced&quot;</span><span class="p">)</span>
        <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="k">go</span> <span class="nx">tool</span> <span class="nx">trace</span> <span class="p">.</span><span class="o">/</span><span class="nx">trace</span><span class="p">.</span><span class="nx">out</span>
</code></pre></div>

<h3 id="runtimerace">runtime/race</h3>
<p>race 包提供了数据争用的检查逻辑。不提供对外的公共接口。</p>
<p>数据争用是并发系统中最常见也是最难调试的bug类型。两个线程并发访问同一个变量（至少有一个写入）时会发生。</p>
<div class="highlight"><pre><span></span><code><span class="k">go</span> <span class="nx">test</span> <span class="o">-</span><span class="nx">race</span> <span class="nx">mypkg</span>    <span class="c1">// to test the package</span>
<span class="k">go</span> <span class="nx">run</span> <span class="o">-</span><span class="nx">race</span> <span class="nx">mysrc</span><span class="p">.</span><span class="k">go</span>  <span class="c1">// to run the source file</span>
<span class="k">go</span> <span class="nx">build</span> <span class="o">-</span><span class="nx">race</span> <span class="nx">mycmd</span>   <span class="c1">// to build the command</span>
<span class="k">go</span> <span class="nx">install</span> <span class="o">-</span><span class="nx">race</span> <span class="nx">mypkg</span> <span class="c1">// to install the package</span>

<span class="c1">// 通过环境变量控制发生争用时的相关参数设置</span>
<span class="nx">GORACE</span><span class="p">=</span><span class="s">&quot;option1=val1 option2=val2&quot;</span>

<span class="c1">// 通过下面的方式可以在执行代码时不使用数据竞争检测器</span>
<span class="c1">// +build !race</span>
</code></pre></div>

<p>竞争检测器运行在：</p>
<p><code>linux/amd64</code>, <code>linux/ppc64le</code>, <code>linux/arm64</code>, <code>freebsd/amd64</code>, <code>netbsd/amd64</code>, <code>darwin/amd64</code>, and <code>windows/amd64</code>.</p>
<p>竞争检测的代价因程序而异，但对于典型程序，内存使用量可能会增加5-10倍，执行时间可能会增加2-20倍。</p>
<div class="highlight"><pre><span></span><code>go build -race main.go
go run -race main.go
go test -race main.go
go install -race mypkg
</code></pre></div>

<p>对于 atomic.StoreInt32() atomic.LoadInt32() 存取变量也支持竞争检查。</p>
<p>runtime/race package contains the data race detector runtime library.
It is based on ThreadSanitizer race detector, that is currently a part of
the LLVM project (<a href="https://github.com/llvm/llvm-project/tree/master/compiler-rt">https://github.com/llvm/llvm-project/tree/master/compiler-rt</a>).</p>
<p>参考文章：<a href="https://golang.org/doc/articles/race_detector.html">https://golang.org/doc/articles/race_detector.html</a></p>
<p><a href="https://krakensystems.co/blog/2019/golang-race-detection">https://krakensystems.co/blog/2019/golang-race-detection</a></p>
<h2 id="_28">其它</h2>
<p>database/sql 了解其连接池的实现。</p>
<p>context</p>
<h1 id="go_1">Go第三方库</h1>
<h2 id="_29">编解码</h2>
<h3 id="protobuf">protobuf</h3>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2016 - 2021 iswade
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\s\\-\uff0c\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>