


<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <link rel="canonical" href="https://iswade.github.io/go/go_notes/">
      
      
      <link rel="shortcut icon" href="../../themes/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.1.1">
    
    
      
        <title>Go - Blog</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.a676eddb.min.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/palette.b302131d.min.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../themes/extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    <body dir="" data-md-color-primary="white" data-md-color-accent="blue">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#go" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="">
    <a href="https://iswade.github.io/" title="Blog" class="md-header-nav__button md-logo" aria-label="Blog">
      
  <img src="../../themes/me.jpg" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Blog
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Go
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" /></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            键入以开始搜索
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://iswade.github.io/" title="Blog" class="md-nav__button md-logo" aria-label="Blog">
      
  <img src="../../themes/me.jpg" alt="logo">

    </a>
    Blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="iswade's blog" class="md-nav__link">
      iswade's blog
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../00_long_time_plan/" title="5 年计划" class="md-nav__link">
      5 年计划
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../01_database_notes/" title="Database Notes" class="md-nav__link">
      Database Notes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../02_distributed_system_papers/" title="分布式系统领域经典论文翻译集" class="md-nav__link">
      分布式系统领域经典论文翻译集
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../about/" title="About" class="md-nav__link">
      About
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../advanced_markdown/" title="高级markdown" class="md-nav__link">
      高级markdown
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Algorithms
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Algorithms" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Algorithms
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../algorithms/algorithms/" title="Algorithms" class="md-nav__link">
      Algorithms
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Articles
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Articles" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Articles
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../articles/boltdb/" title="BoltDB" class="md-nav__link">
      BoltDB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../articles/etcd/" title="ETCD" class="md-nav__link">
      ETCD
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../articles/go_concurrency/" title="Go 并发编程" class="md-nav__link">
      Go 并发编程
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../articles/partition/" title="分布式系统之数据分区" class="md-nav__link">
      分布式系统之数据分区
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../articles/pebble/" title="Pebble" class="md-nav__link">
      Pebble
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../articles/performance/" title="perf 工具使用" class="md-nav__link">
      perf 工具使用
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../articles/raft/" title="Raft 算法实现" class="md-nav__link">
      Raft 算法实现
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../articles/summary_2017/" title="2017 总结" class="md-nav__link">
      2017 总结
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../articles/summary_2018/" title="2018 总结" class="md-nav__link">
      2018 总结
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Database
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Database" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Database
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../database/db_internals/" title="读书笔记" class="md-nav__link">
      读书笔记
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../database/db_internals_ch09_failure_detection/" title="分布式系统之故障检测" class="md-nav__link">
      分布式系统之故障检测
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../database/db_internals_ch13_dist_transactions/" title="分布式系统之分布式事务" class="md-nav__link">
      分布式系统之分布式事务
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../database/db_internals_ch14_consensus/" title="分布式系统之共识" class="md-nav__link">
      分布式系统之共识
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../database/replication/" title="分布式系统之复制" class="md-nav__link">
      分布式系统之复制
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      Distributed systems
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Distributed systems" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Distributed systems
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../distributed_systems/00_preface/" title="前言" class="md-nav__link">
      前言
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../distributed_systems/01_introduction/" title="第一章 概述" class="md-nav__link">
      第一章 概述
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../distributed_systems/02_interprocess/" title="第二章 进程间通信：概述" class="md-nav__link">
      第二章 进程间通信：概述
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../distributed_systems/03_models/" title="第三章 通信模型" class="md-nav__link">
      第三章 通信模型
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../distributed_systems/04_representing/" title="第四章 表示分布式算法 _语法和语义_" class="md-nav__link">
      第四章 表示分布式算法 _语法和语义_
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../distributed_systems/06_time/" title="第六章 分布式系统中的时间" class="md-nav__link">
      第六章 分布式系统中的时间
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-11" type="checkbox" id="nav-11" checked>
    
    <label class="md-nav__link" for="nav-11">
      Go
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Go" data-md-level="1">
      <label class="md-nav__title" for="nav-11">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Go
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../exam04/" title="Exam04" class="md-nav__link">
      Exam04
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../go_exercises/" title="Go exercises" class="md-nav__link">
      Go exercises
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../go_exercises100/" title="Go exercises100" class="md-nav__link">
      Go exercises100
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../go_interview/" title="Go interview" class="md-nav__link">
      Go interview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../go_libs/" title="Go标准库" class="md-nav__link">
      Go标准库
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Go
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,9H17V7H3V9M3,13H17V11H3V13M3,17H17V15H3V17M19,17H21V15H19V17M19,7V9H21V7H19M19,13H21V11H19V13Z" /></svg>
        </span>
      </label>
    
    <a href="./" title="Go" class="md-nav__link md-nav__link--active">
      Go
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      目录
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#todo" class="md-nav__link">
    TODO
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../go_tools/" title="Go 语言工具" class="md-nav__link">
      Go 语言工具
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-12" type="checkbox" id="nav-12">
    
    <label class="md-nav__link" for="nav-12">
      Notes
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Notes" data-md-level="1">
      <label class="md-nav__title" for="nav-12">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Notes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/all/" title="笔记本" class="md-nav__link">
      笔记本
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/bash/" title="Bash" class="md-nav__link">
      Bash
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/bash_turorial/" title="Bash 简介" class="md-nav__link">
      Bash 简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/git/" title="git 入门教程" class="md-nav__link">
      git 入门教程
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/pragmatic_programmer/" title="程序员修炼之道读书笔记" class="md-nav__link">
      程序员修炼之道读书笔记
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/python/" title="python基础" class="md-nav__link">
      python基础
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/vmware/" title="Vmware" class="md-nav__link">
      Vmware
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-12-8" type="checkbox" id="nav-12-8">
    
    <label class="md-nav__link" for="nav-12-8">
      Adb nodes
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Adb nodes" data-md-level="2">
      <label class="md-nav__title" for="nav-12-8">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Adb nodes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/adb_nodes/01_in_memory_database/" title="内存数据库" class="md-nav__link">
      内存数据库
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/adb_nodes/09_storage_models_data_layout/" title="存储模型和数据布局" class="md-nav__link">
      存储模型和数据布局
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/adb_nodes/15_execution/" title="15 execution" class="md-nav__link">
      15 execution
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/adb_nodes/17_hashjoins/" title="并行 JOIN 算法（Hashing）" class="md-nav__link">
      并行 JOIN 算法（Hashing）
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/adb_nodes/22_optimizer_implementation_I/" title="优化器实现 I" class="md-nav__link">
      优化器实现 I
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/adb_nodes/23_optimizer_implementation_II/" title="优化器实现 II" class="md-nav__link">
      优化器实现 II
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/adb_nodes/24_cost_models/" title="基于代价的优化" class="md-nav__link">
      基于代价的优化
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/adb_nodes/25_self_driving/" title="自动驾驶数据库" class="md-nav__link">
      自动驾驶数据库
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-12-9" type="checkbox" id="nav-12-9">
    
    <label class="md-nav__link" for="nav-12-9">
      Db nodes
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Db nodes" data-md-level="2">
      <label class="md-nav__title" for="nav-12-9">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Db nodes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/00_database_systems_2018/" title="关系语言" class="md-nav__link">
      关系语言
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/01_relational_model/" title="关系模型" class="md-nav__link">
      关系模型
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/02_advanced_SQL/" title="高级 SQL" class="md-nav__link">
      高级 SQL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/03_Database_Storage_I/" title="数据库存储（I）" class="md-nav__link">
      数据库存储（I）
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/04_Database_Storage_II/" title="数据库存储（II）" class="md-nav__link">
      数据库存储（II）
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/05_Buffer_Pool/" title="缓存池" class="md-nav__link">
      缓存池
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/06_Hash_Tables/" title="哈希表" class="md-nav__link">
      哈希表
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/07_Tree_Indexes_I/" title="树索引（I）" class="md-nav__link">
      树索引（I）
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/08_Tree_Indexes_II/" title="树索引（II）" class="md-nav__link">
      树索引（II）
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/09_Index_Concurrency/" title="索引并发控制" class="md-nav__link">
      索引并发控制
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/10_Query_Processing/" title="查询处理" class="md-nav__link">
      查询处理
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/11_Sorting_Aggregations/" title="排序和聚集" class="md-nav__link">
      排序和聚集
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/12_joins/" title="JOIN 算法" class="md-nav__link">
      JOIN 算法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/13_Query_Optimization/" title="查询优化" class="md-nav__link">
      查询优化
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/14_parallel_execution/" title="并行执行" class="md-nav__link">
      并行执行
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/15_embedded_logic/" title="嵌入数据库逻辑" class="md-nav__link">
      嵌入数据库逻辑
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/16_concurrency_control/" title="并发控制理论" class="md-nav__link">
      并发控制理论
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/18_timestamp_ordering/" title="时间顺序并发控制" class="md-nav__link">
      时间顺序并发控制
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/19_MVCC/" title="多版本并发控制" class="md-nav__link">
      多版本并发控制
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/20_logging/" title="日志" class="md-nav__link">
      日志
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/21_recovery/" title="数据库恢复" class="md-nav__link">
      数据库恢复
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/db_nodes/22_distribute_OLTP/" title="分布式 OLTP 数据库" class="md-nav__link">
      分布式 OLTP 数据库
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-13" type="checkbox" id="nav-13">
    
    <label class="md-nav__link" for="nav-13">
      Translate
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Translate" data-md-level="1">
      <label class="md-nav__title" for="nav-13">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Translate
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/An%20Overview%20of%20Query%20Optimization%20in%20Relational%20Systems/" title="关系系统中的查询优化" class="md-nav__link">
      关系系统中的查询优化
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/Aurora_design_cloud_native_database/" title="Aurora：我们如何设计云原生关系数据库" class="md-nav__link">
      Aurora：我们如何设计云原生关系数据库
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/Calvin%20Fast%20Distributed%20Transactions/" title="Calvin: 分区数据库的快速分布式事务" class="md-nav__link">
      Calvin: 分区数据库的快速分布式事务
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/F1_query/" title="F1 Query：大规模数据的声明式查询" class="md-nav__link">
      F1 Query：大规模数据的声明式查询
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/The%20State%20of%20the%20Art%20in%20Distributed%20Query%20Processing/" title="分布式查询处理的最新进展" class="md-nav__link">
      分布式查询处理的最新进展
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/btree_vs_lsmtree/" title="现代存储系统背后的算法" class="md-nav__link">
      现代存储系统背后的算法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/comparison_of_database_isolation/" title="数据库隔离级别的比较" class="md-nav__link">
      数据库隔离级别的比较
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/distsys/" title="分布式系统大纲" class="md-nav__link">
      分布式系统大纲
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/faunadb_transaction/" title="无时钟的一致性：FaunaDB的分布式事务协议" class="md-nav__link">
      无时钟的一致性：FaunaDB的分布式事务协议
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/generalized_consensus/" title="广义分布式共识" class="md-nav__link">
      广义分布式共识
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/go_interface/" title="如何使用 Go 接口？" class="md-nav__link">
      如何使用 Go 接口？
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/linux_sysadmin/" title="Linux sysadmin" class="md-nav__link">
      Linux sysadmin
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/paxos_made_live/" title="Paxos Made Live(译)" class="md-nav__link">
      Paxos Made Live(译)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/raft/" title="raft详解" class="md-nav__link">
      raft详解
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/strong_consistency_models/" title="Strong consistency models" class="md-nav__link">
      Strong consistency models
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/taurus_paper/" title="Taurus Database: How to be Fast, Available, and Frugal in the Cloud" class="md-nav__link">
      Taurus Database: How to be Fast, Available, and Frugal in the Cloud
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/taurus_paper_cn/" title="TaurusDB: 高性能高可用低成本云数据库" class="md-nav__link">
      TaurusDB: 高性能高可用低成本云数据库
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/to_be_manager/" title="How to be a manager" class="md-nav__link">
      How to be a manager
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/zookeeper/" title="ZooKeeper: 互联网系统无等待协调服务" class="md-nav__link">
      ZooKeeper: 互联网系统无等待协调服务
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-13-20" type="checkbox" id="nav-13-20">
    
    <label class="md-nav__link" for="nav-13-20">
      Google practices
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Google practices" data-md-level="2">
      <label class="md-nav__title" for="nav-13-20">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Google practices
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/Google_practices/practices/" title="Goolge 工程实践文档" class="md-nav__link">
      Goolge 工程实践文档
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-13-20-2" type="checkbox" id="nav-13-20-2">
    
    <label class="md-nav__link" for="nav-13-20-2">
      Review
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Review" data-md-level="3">
      <label class="md-nav__title" for="nav-13-20-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Review
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/Google_practices/review/developer/" title="Developer" class="md-nav__link">
      Developer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/Google_practices/review/review/" title="代码检视开发者指导" class="md-nav__link">
      代码检视开发者指导
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/Google_practices/review/reviewer/" title="Reviewer" class="md-nav__link">
      Reviewer
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-13-21" type="checkbox" id="nav-13-21">
    
    <label class="md-nav__link" for="nav-13-21">
      Crdb
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Crdb" data-md-level="2">
      <label class="md-nav__title" for="nav-13-21">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Crdb
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/crdb/crdb_distribution_layer/" title="分布层" class="md-nav__link">
      分布层
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/crdb/crdb_distsql/" title="分布式 SQL 查询" class="md-nav__link">
      分布式 SQL 查询
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/crdb/crdb_join/" title="CockroachDB 中的 JOIN" class="md-nav__link">
      CockroachDB 中的 JOIN
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/crdb/crdb_paper/" title="CockroachDB: The Resilient Geo-Distributed SQL Database" class="md-nav__link">
      CockroachDB: The Resilient Geo-Distributed SQL Database
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/crdb/crdb_paper_cn/" title="CockroachDB：弹性地理分布SQL数据库" class="md-nav__link">
      CockroachDB：弹性地理分布SQL数据库
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/crdb/crdb_pipelining/" title="管道化共识写入加速分布式 SQL 事务" class="md-nav__link">
      管道化共识写入加速分布式 SQL 事务
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/crdb/crdb_query_planning/" title="SQL 查询计划" class="md-nav__link">
      SQL 查询计划
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/crdb/crdb_replication_layer/" title="复制层" class="md-nav__link">
      复制层
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/crdb/crdb_sql_layer/" title="SQL 层" class="md-nav__link">
      SQL 层
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/crdb/crdb_sql_life/" title="[译] SQL的一生（CRDB）" class="md-nav__link">
      [译] SQL的一生（CRDB）
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-13-22" type="checkbox" id="nav-13-22">
    
    <label class="md-nav__link" for="nav-13-22">
      Misc
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Misc" data-md-level="2">
      <label class="md-nav__title" for="nav-13-22">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Misc
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/misc/CI/" title="持续集成系统" class="md-nav__link">
      持续集成系统
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translate/misc/datastore/" title="DBDB: Dog Bed Database" class="md-nav__link">
      DBDB: Dog Bed Database
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      目录
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#todo" class="md-nav__link">
    TODO
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <h1 id="go">Go</h1>
<p>TODO:</p>
<ol>
<li>
<p>字符串到byte切片的转换，内存是怎么分配的？[]byte(s)</p>
<blockquote>
<p>新分配内存</p>
</blockquote>
</li>
<li></li>
</ol>
<p>标签： 笔记</p>
<ol>
<li>开发速度：编译，工具</li>
<li>并发模型：goroutine，runtime，chan，sync，race；调度模型(MPG)</li>
<li>类型系统：简单类型，组合，接口，闭包</li>
</ol>
<table>
<thead>
<tr>
<th>能力项</th>
<th>题目数量</th>
<th>答对数量</th>
<th>正确率</th>
</tr>
</thead>
<tbody>
<tr>
<td>1. <strong>通用规范遵从与应用(Go)</strong></td>
<td><strong>10</strong></td>
<td><strong>7</strong></td>
<td><strong>70.00%</strong></td>
</tr>
<tr>
<td>掌握并理解Go通用规范中的规则和要求，编写满足规范要求的代码</td>
<td>6</td>
<td>6</td>
<td>100.00%</td>
</tr>
<tr>
<td>熟悉并理解业界主流规范，如：Effective  Go、Go Code Review Comments等</td>
<td>4</td>
<td>1</td>
<td>25.00%</td>
</tr>
<tr>
<td>2. <strong>安全规范遵从与应用(Go)</strong></td>
<td><strong>16</strong></td>
<td><strong>10</strong></td>
<td><strong>62.50%</strong></td>
</tr>
<tr>
<td>了解常用静态工具，如：govet等，能使用工具发现代码的问题并修复</td>
<td>1</td>
<td>1</td>
<td>100.00%</td>
</tr>
<tr>
<td>掌握常见的代码安全陷阱和危害，如：DoS，命令/SQL/XSS注入等，能编写满足安全规范要求的代码</td>
<td>1</td>
<td>1</td>
<td>100.00%</td>
</tr>
<tr>
<td>熟悉华为Go语言安全编程规范的基本规则要求，如：输入校验，整数安全，内存安全与资源管理，错误处理，并发安全，敏感数据安全，异常处理等</td>
<td>8</td>
<td>5</td>
<td>62.50%</td>
</tr>
<tr>
<td>深刻掌握Go安全编码规范，能理解规范背后的原理，如：资源，异常，敏感数据，文件安全，加解密等</td>
<td>5</td>
<td>3</td>
<td>60.00%</td>
</tr>
<tr>
<td>熟悉代码安全检视方法，分析代码或增量代码的对系统安全性的影响，指导安全编码</td>
<td>1</td>
<td>0</td>
<td>0.00%</td>
</tr>
<tr>
<td>3. <strong>编程语言能力(Go)</strong></td>
<td><strong>34</strong></td>
<td><strong>21</strong></td>
<td><strong>61.80%</strong></td>
</tr>
<tr>
<td>熟悉常用工具：如：build，clean，install，run，test，fmt，vet，get，list，pprof，trace，race  detector等</td>
<td>1</td>
<td>1</td>
<td>100.00%</td>
</tr>
<tr>
<td>掌握基本语法和基本特性：变量，操作符，程序结构，流程控制语句，基本数据类型，数组，指针，切片，map，结构体，函数，方法，接口，包，goroutines、Channels等。</td>
<td>21</td>
<td>14</td>
<td>66.70%</td>
</tr>
<tr>
<td>掌握Go编程的高级特性：反射，类型安全，类型系统，类型自动推导、unsafe包，cgo，defer，panic等</td>
<td>6</td>
<td>4</td>
<td>66.70%</td>
</tr>
<tr>
<td>熟练使用Go常用包、框架：bufio，strings，strconv，errors，regexp，json，net，os，sync,  time，unsafe，flag，runtime，debug，trace，encoding，html/template等</td>
<td>4</td>
<td>2</td>
<td>50.00%</td>
</tr>
<tr>
<td>了解Go常见包、框架：bufio，strings，strconv，errors，regexp，json，net，os，sync,  time等</td>
<td>1</td>
<td>0</td>
<td>0.00%</td>
</tr>
<tr>
<td>掌握Go的Runtime和关键特性，比如GC，内存管理，逃逸分析，协程调度等</td>
<td>1</td>
<td>0</td>
<td>0.00%</td>
</tr>
</tbody>
</table>
<h2 id="todo">TODO</h2>
<ol>
<li><img alt="🆗" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/1f197.svg" title=":ok:" /> 基础知识：如：命名、变量、操作符、基本输入输出，程序结构等</li>
<li><img alt="🆗" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/1f197.svg" title=":ok:" /> 流程控制语句</li>
<li><img alt="🆗" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/1f197.svg" title=":ok:" /> 原始基本数据类型</li>
<li><img alt="🆗" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/1f197.svg" title=":ok:" /> 原始复合数据类型</li>
<li><img alt="🆗" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/1f197.svg" title=":ok:" /> 结构体的声明与使用</li>
<li><img alt="🆗" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/1f197.svg" title=":ok:" /> 函数/方法/接口的声明实现与使用</li>
<li><img alt="🆗" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/1f197.svg" title=":ok:" /> 包的设计、组织与使用</li>
<li><img alt="🆗" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/1f197.svg" title=":ok:" /> Goroutines、Channels和同步</li>
<li><img alt="🆗" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/1f197.svg" title=":ok:" /> 错误处理</li>
<li><img alt="🆗" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/1f197.svg" title=":ok:" /> 反射</li>
<li><img alt="🆗" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/1f197.svg" title=":ok:" />常用包，如：bufio，strings，strconv，errors，regexp，json，net，os，sync, time，unsafe，flag，runtime，debug，trace，encoding，html/template等</li>
<li><img alt="🆗" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/1f197.svg" title=":ok:" />常用工具，如：build，clean，install，run，test，fmt，vet，get，list，pprof，trace，race detector等</li>
<li>底层编码相关知识，如：Plan9汇编，内存管理机制与GC，逃逸分析，协程调度机制，CGO</li>
<li>了解多核并发，性能优化调优，CPU架构等</li>
</ol>
<h1 id="_1">语言基础</h1>
<ol>
<li>特征：语法简单；并发模型；内存分配；垃圾收集；静态链接；标准库；工具链</li>
</ol>
<h2 id="_2">类型</h2>
<h3 id="_3">变量</h3>
<ol>
<li>变量可以和常量一样初始化</li>
<li>也可以是运行时可计算的表达式</li>
<li>全局变量未使用不会编译时报错，局部变量未使用编译时会报错</li>
<li>多变量赋值时，先计算所有值，然后再赋值，从左到右依次进行</li>
<li>自动推导</li>
<li>var i = 1 推导出来的类型是 int</li>
<li>var f = 0.0 推导出来的类型是 float64</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="p">(</span>
    <span class="nx">home</span>   <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getenv</span><span class="p">(</span><span class="s">&quot;HOME&quot;</span><span class="p">)</span>
    <span class="nx">user</span>   <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getenv</span><span class="p">(</span><span class="s">&quot;USER&quot;</span><span class="p">)</span>
    <span class="nx">gopath</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getenv</span><span class="p">(</span><span class="s">&quot;GOPATH&quot;</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_4">常量</h3>
<ol>
<li>常量值必须是编译期可确定的数字、字符、字符串、布尔值</li>
<li>在常量组中，如不提供类型和初始化值，那么视作与上⼀常量相同</li>
<li>在编译时创建，在定义函数的本地常量时也是一样</li>
<li>定义常量的表达式必须是常量，在编译时可以计算</li>
<li>如 <code>1&lt;&lt;3</code> 是常量表达式，<code>math.Sin(math.Pi/4)</code> 不是</li>
<li>枚举类型通常使用 <code>iota</code> 枚举器来实现，可以定义较复杂的表达式，iota 从0开始</li>
<li>常量通常会在编译器在预处理阶段直接展开，作为指令数据使用，无法获取地址</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">ByteSize</span> <span class="kt">float64</span>

<span class="kd">const</span> <span class="p">(</span>
    <span class="nx">_</span>           <span class="p">=</span> <span class="kc">iota</span> <span class="c1">// 忽略第一个值</span>
    <span class="nx">KB</span> <span class="nx">ByteSize</span> <span class="p">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="kc">iota</span><span class="p">)</span>
    <span class="nx">MB</span>
    <span class="nx">GB</span>
    <span class="nx">TB</span>
    <span class="nx">PB</span>
    <span class="nx">EB</span>
    <span class="nx">ZB</span>
    <span class="nx">YB</span>
<span class="p">)</span>

<span class="c1">// 将一个类型附加一个String() 方法，可以方便任意值自动打印格式化</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="nx">ByteSize</span><span class="p">)</span> <span class="nx">String</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">b</span> <span class="o">&gt;=</span> <span class="nx">YB</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%.2fYB&quot;</span><span class="p">,</span> <span class="nx">b</span><span class="o">/</span><span class="nx">YB</span><span class="p">)</span>
    <span class="k">case</span> <span class="nx">b</span> <span class="o">&gt;=</span> <span class="nx">ZB</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%.2fZB&quot;</span><span class="p">,</span> <span class="nx">b</span><span class="o">/</span><span class="nx">ZB</span><span class="p">)</span>
    <span class="k">case</span> <span class="nx">b</span> <span class="o">&gt;=</span> <span class="nx">EB</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%.2fEB&quot;</span><span class="p">,</span> <span class="nx">b</span><span class="o">/</span><span class="nx">EB</span><span class="p">)</span>
    <span class="k">case</span> <span class="nx">b</span> <span class="o">&gt;=</span> <span class="nx">PB</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%.2fPB&quot;</span><span class="p">,</span> <span class="nx">b</span><span class="o">/</span><span class="nx">PB</span><span class="p">)</span>
    <span class="k">case</span> <span class="nx">b</span> <span class="o">&gt;=</span> <span class="nx">TB</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%.2fTB&quot;</span><span class="p">,</span> <span class="nx">b</span><span class="o">/</span><span class="nx">TB</span><span class="p">)</span>
    <span class="k">case</span> <span class="nx">b</span> <span class="o">&gt;=</span> <span class="nx">GB</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%.2fGB&quot;</span><span class="p">,</span> <span class="nx">b</span><span class="o">/</span><span class="nx">GB</span><span class="p">)</span>
    <span class="k">case</span> <span class="nx">b</span> <span class="o">&gt;=</span> <span class="nx">MB</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%.2fMB&quot;</span><span class="p">,</span> <span class="nx">b</span><span class="o">/</span><span class="nx">MB</span><span class="p">)</span>
    <span class="k">case</span> <span class="nx">b</span> <span class="o">&gt;=</span> <span class="nx">KB</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%.2fKB&quot;</span><span class="p">,</span> <span class="nx">b</span><span class="o">/</span><span class="nx">KB</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%.2fB&quot;</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
<span class="p">}</span>


<span class="c1">// 中断的常量，必须显示恢复</span>
<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">(</span>
        <span class="nx">a</span> <span class="p">=</span> <span class="kc">iota</span>
        <span class="nx">b</span>
        <span class="nx">c</span> <span class="p">=</span> <span class="mi">10</span>
        <span class="nx">d</span>
        <span class="nx">e</span> <span class="p">=</span> <span class="kc">iota</span>
    <span class="p">)</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// 0 1 10 10 4</span>
</code></pre></div>

<h3 id="_5">基本类型</h3>
<p>变量长度</p>
<ol>
<li>rune 类型的长度是4个字节</li>
<li>int, uint 是4个字节或者8个字节（32bit 64bit不同的系统长度不一样）</li>
<li>uintptr 是4个字节或者8个字节（32bit 64bit不同的系统长度不一样）</li>
</ol>
<h3 id="_6">引用类型</h3>
<p>引用类型：特指内置的三种类型slice、map和chan。</p>
<h3 id="_7">类型转换</h3>
<p>Go所有类型之间必须显式转换。</p>
<h3 id="_8">自定义类型</h3>
<ol>
<li>别名（无需显式转化，可以直接赋值）</li>
<li><code>type byte = uint8</code></li>
<li><code>type rune = int32</code></li>
<li>新类型 <code>type myint int</code>，（新类型与基础类型之间需要显式转换）</li>
<li>与明确标识符的bool/int/string等类型相比，数组、切片、字典、通道等类型与具体元素类型或者长度有关，故称之为<strong>未命名类型</strong>。可以用type将其变为命名类型。</li>
</ol>
<h2 id="_9">表达式和语句</h2>
<h3 id="_10">保留字</h3>
<p>Go语言仅有25个保留关键字。</p>
<h3 id="_11">运算符</h3>
<blockquote>
<p>硬件的方向是物理，软件的结局是数学。</p>
</blockquote>
<ol>
<li>一元运算符优先级最高</li>
<li>二元运算符优先级分成五个级别</li>
<li>相同优先级的二元运算符，从左往右依次计算</li>
</ol>
<h3 id="_12">位运算符</h3>
<div class="highlight"><pre><span></span><code>AND           a &amp; b        按位与：都为1               
OR            a | b        按位或：至少一个1            
XOR           a ^ b        按位亦或：只有一个1          
NOT           ^a           按位取反（一元）             
AND NOT       a &amp;^ b       按位清除                   
LEFT SHIFT    a &lt;&lt; 2       左移                      
RIGHT SHIFT   a &gt;&gt; 2       右移
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="p">(</span>
    <span class="nx">read</span> <span class="kt">byte</span> <span class="p">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="kc">iota</span>
    <span class="nx">write</span>
    <span class="nx">exec</span>
    <span class="nx">freeze</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">a</span> <span class="o">:=</span> <span class="nx">read</span> <span class="p">|</span> <span class="nx">write</span> <span class="p">|</span> <span class="nx">freeze</span>
    <span class="nx">b</span> <span class="o">:=</span> <span class="nx">read</span> <span class="p">|</span> <span class="nx">freeze</span> <span class="p">|</span> <span class="nx">exec</span>
    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">a</span> <span class="o">&amp;^</span> <span class="nx">b</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%04b &amp;^ %04b = %04b\n&quot;</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// 1011 &amp;^ 1101 = 0010</span>
</code></pre></div>

<h3 id="_13">自增</h3>
<ol>
<li>自增自减不再是运算符。只能作为独立语句，不能用于表达式。</li>
<li>表达式通常是求值代码，可作为右值或参数使用。</li>
<li>而语句完成一个行为，例如if，for代码块。</li>
<li>表达式可作为语句用，但是语句却不能当做表达式。</li>
</ol>
<h3 id="_14">指针</h3>
<ol>
<li>
<p>内存地址是内存中每个字节的唯一编号，而指针则是一个实体。</p>
</li>
<li>
<p>指针会分配内存空间，相当于一个用来专门保存地址的整形变量。</p>
</li>
<li>
<p>指针类型仅支持相等运算符，不能做加减法以及类型转换。</p>
</li>
<li>
<p>可以通过 <code>unsafe.Pointer</code> 将指针转换为 <code>uintptr</code> 后进行加减运算，但是可能会造成非法访问。</p>
</li>
<li>
<p><code>Pointer</code> 类似C语言中的 <code>void *</code>，可以用来转换指针类型。</p>
</li>
<li>
<p><code>uintptr</code> 进行是一个特殊整型，并不引用目标对象，无法阻止垃圾回收对象内存。</p>
</li>
<li>
<p>零长度对象的地址是否相同和具体的版本有关，不过肯定不等于nil。</p>
<p>(参看《Go语言学习笔记》1.5版本相等，1.15.2版本不相等)</p>
</li>
</ol>
<h3 id="_15">声明与赋值</h3>
<div class="highlight"><pre><span></span><code><span class="nx">f</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
<span class="nx">d</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Stat</span><span class="p">()</span>
</code></pre></div>

<h3 id="if">if</h3>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="nx">x</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">y</span>
<span class="p">}</span>

<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">Chmod</span><span class="p">(</span><span class="mo">0664</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="for">for</h3>
<p>循环语句for综合了所有循环类型</p>
<ol>
<li>初始化语句仅被执行一次</li>
<li>条件表达式中如果有函数，则可能会被编译器优化掉，也可能是动态结果必须重复执行</li>
<li>支持字符串，数组，数组指针，切片，字典，通道类型，返回索引、键值数据</li>
<li>range会复制目标数据（例如<strong>数组</strong>）</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="nx">init</span><span class="p">;</span> <span class="nx">condition</span><span class="p">;</span> <span class="nx">post</span> <span class="p">{</span> <span class="p">}</span>
<span class="k">for</span> <span class="nx">condition</span> <span class="p">{</span> <span class="p">}</span>
<span class="k">for</span> <span class="p">{</span> <span class="p">}</span>

<span class="nx">sum</span> <span class="o">:=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
    <span class="nx">sum</span> <span class="o">+=</span> <span class="nx">i</span>
<span class="p">}</span>

<span class="c1">// range 可以遍历：数组、切片、字符串、映射，读取管道</span>
<span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">oldMap</span> <span class="p">{</span>
    <span class="nx">newMap</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="p">=</span> <span class="nx">value</span>
<span class="p">}</span>

<span class="c1">// go没有逗号表达式，++，--为语句而不是表达式，所以</span>
<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">j</span><span class="p">;</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span> <span class="p">=</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nx">j</span><span class="o">-</span><span class="mi">1</span> <span class="p">{</span>
    <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">a</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">a</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="switch">switch</h3>
<ol>
<li>条件表达式非常丰富，支持常量，条件表达式</li>
<li>不能出现重复case常量值</li>
<li>无需显式break语句，case执行完后自动中断</li>
<li>如果需要继续执行下一个case则需要显式 <code>fallthrough</code></li>
<li>可用于接口类型匹配</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1">// 等值比较</span>
<span class="kd">func</span> <span class="nx">shouldEscape</span><span class="p">(</span><span class="nx">c</span> <span class="kt">byte</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="nx">c</span> <span class="p">{</span>
    <span class="k">case</span> <span class="sc">&#39; &#39;</span><span class="p">,</span> <span class="sc">&#39;?&#39;</span><span class="p">,</span> <span class="sc">&#39;&amp;&#39;</span><span class="p">,</span> <span class="sc">&#39;=&#39;</span><span class="p">,</span> <span class="sc">&#39;#&#39;</span><span class="p">,</span> <span class="sc">&#39;+&#39;</span><span class="p">,</span> <span class="sc">&#39;%&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>

<span class="c1">// 多条件判断</span>
<span class="kd">func</span> <span class="nx">byteType</span><span class="p">(</span><span class="nx">c</span> <span class="kt">byte</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">{</span>
    <span class="k">case</span> <span class="sc">&#39;0&#39;</span> <span class="o">&lt;=</span> <span class="nx">c</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;number&quot;</span>
    <span class="k">case</span> <span class="sc">&#39;a&#39;</span> <span class="o">&lt;=</span> <span class="nx">c</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;z&#39;</span><span class="p">:</span>
        <span class="k">fallthrough</span>
    <span class="k">case</span> <span class="sc">&#39;A&#39;</span> <span class="o">&lt;=</span> <span class="nx">c</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;Z&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;alphabet&quot;</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;unknown&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">byteType</span><span class="p">(</span><span class="nx">c</span> <span class="kt">byte</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">{</span>
    <span class="k">case</span> <span class="sc">&#39;0&#39;</span> <span class="o">&lt;=</span> <span class="nx">c</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;number&quot;</span>
    <span class="k">case</span> <span class="sc">&#39;a&#39;</span> <span class="o">&lt;=</span> <span class="nx">c</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;z&#39;</span><span class="p">,</span><span class="sc">&#39;A&#39;</span> <span class="o">&lt;=</span> <span class="nx">c</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;Z&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;alphabet&quot;</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;unknown&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 类型判断</span>
<span class="kd">var</span> <span class="nx">t</span> <span class="kd">interface</span><span class="p">{}</span>
<span class="nx">t</span> <span class="p">=</span> <span class="nx">functionOfSomeType</span><span class="p">()</span>
<span class="k">switch</span> <span class="nx">t</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
<span class="k">default</span><span class="p">:</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;unexpected type %T\n&quot;</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span>     <span class="c1">// %T 打印任何类型的 t</span>
<span class="k">case</span> <span class="kt">bool</span><span class="p">:</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;boolean %t\n&quot;</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span>             <span class="c1">// t 是 bool 类型</span>
<span class="k">case</span> <span class="kt">int</span><span class="p">:</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;integer %d\n&quot;</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span>             <span class="c1">// t 是 int 类型</span>
<span class="k">case</span> <span class="o">*</span><span class="kt">bool</span><span class="p">:</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;pointer to boolean %t\n&quot;</span><span class="p">,</span> <span class="o">*</span><span class="nx">t</span><span class="p">)</span> <span class="c1">// t 是 *bool 类型</span>
<span class="k">case</span> <span class="o">*</span><span class="kt">int</span><span class="p">:</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;pointer to integer %d\n&quot;</span><span class="p">,</span> <span class="o">*</span><span class="nx">t</span><span class="p">)</span> <span class="c1">// t 是 *int 类型</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="gotocontinuebreak">goto/continue/break</h3>
<ol>
<li>goto必须定义标签，未使用的标签会报编译错误</li>
<li>goto不能跳转到其它函数，也不能跳转到内层代码块内</li>
<li>break用于switch、for、select语句</li>
<li>continue仅用于for循环</li>
<li>配合标签，break和continue可以在多层嵌套总指定目标层级</li>
</ol>
<h2 id="_16">格式化</h2>
<ol>
<li>
<p>使用tab键缩进</p>
</li>
<li>
<p>对行长度没有限制，如果人为换行，则新行使用tab键缩进</p>
</li>
<li>
<p>对字段的注释自动对齐</p>
</li>
<li>
<p>所有标准包都是经过格式化的</p>
</li>
<li>
<p>根据运算符的优先级加入空格（例如 <code>x&lt;&lt;8 + y&lt;&lt;16</code>）</p>
</li>
<li>
<p>goimport 导入顺序：空行或者行注释分割的块进行分布处理，块内部包名进行排序。</p>
</li>
</ol>
<p>建议顺序：标准库，系统库，第三方库，本项目的库。</p>
<p>不同的分组之间使用空行分割开。</p>
<p>可以使用 goimports 工具自动格式化，自动删除和引入包。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 对文件格式化</span>
gofmt -w main.go

<span class="c1"># 对目录格式化</span>
gofmt -w ./

<span class="c1"># 对包格式化</span>
go fmt
go fmt package_name

<span class="c1"># 对导入包进行格式化</span>
goimport -w main.go
</code></pre></div>

<h2 id="_17">注释</h2>
<ol>
<li>快注释 <code>/* this is multi-line comments */</code></li>
<li>行注释 <code>// this is block comments</code></li>
<li>godoc通过注释生成文档</li>
<li>包名上方的注释（任何一个文件都可以，如果多个文件注释，则都会被输出）</li>
<li>导出函数上方的注释（应该以函数名开始）</li>
<li>分组的注释（将多个变量通过 <code>var()</code> 方式组合到一起，上方进行注释）</li>
</ol>
<h2 id="_18">命名</h2>
<ol>
<li>包名</li>
</ol>
<ul>
<li>导入包后，包名作为内容的访问器</li>
<li>包名应该简短、精确，引起共鸣</li>
<li>按照惯例，软件包使用小写的单个单词名称。<strong>不需要下划线或首字母大写</strong></li>
<li>不必担心导入冲突</li>
<li>通常使用目录的basename</li>
<li>包中的变量不要再加包名（例如 bufio.Reader 而不是 bufio.bufReader）</li>
</ul>
<ol start="2">
<li>Getters</li>
</ol>
<ul>
<li>一个字段是 owner，应该使用一个 Ower() 方法获取，而不是 GetOwer()</li>
<li>set方法则可以使用 SetOwer()</li>
</ul>
<ol start="3">
<li>接口名称</li>
</ol>
<ul>
<li>
<p>单个方法的接口，在方法名后面加上 "er" 表示接口名称</p>
<p>如：<code>Reader</code>, <code>Writer</code>等</p>
</li>
<li>
<p>字符串转换使用 <code>String</code> 而不是 <code>ToString</code></p>
</li>
</ul>
<ol start="4">
<li>混合大小写（驼峰格式）</li>
</ol>
<ul>
<li>
<p>使用 <code>MixedCaps</code> 或者 <code>mixedCaps</code>，不使用下划线分割多个单词</p>
</li>
<li>
<p>函数名，结构，常量/枚举，全局变量，局部变量，接口名等都适用</p>
</li>
</ul>
<ol start="5">
<li>文件名</li>
</ol>
<ul>
<li>不能以 . 或者 _ 开头</li>
<li>_test.go 会被 go test 工具编译运行</li>
<li><code>'*_GOOS' 、‘*_GOARCH’、'*_GOOS_GOARCH'</code> 会被隐式处理</li>
</ul>
<ol start="6">
<li>目录名</li>
</ol>
<ul>
<li><strong>目录名必须为全小写单词，允许加中划线‘-’组合方式，但是头尾不能为中划线</strong></li>
</ul>
<h2 id="_19">函数</h2>
<ol>
<li>函数属于第一类对象，具有相同签名（参数以及返回值列表）的视作同一类型</li>
<li>函数支持多返回值（返回值可以命名）</li>
<li>第一类对象指可在运行期创建，可用作函数参数或者返回值，也可以存入变量的实体</li>
<li>函数只能判断其是否为nil，不支持其它比较</li>
<li>从函数返回局部变量指针是安全的（编译器会进行逃逸分析是否在堆上分配内存）</li>
<li>函数参数都是值拷贝传递（区别是拷贝目标是对象，还是拷贝指针）</li>
<li>被复制的指针会延长目标对象生命周期</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">fa</span><span class="p">()</span> <span class="p">{</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nx">fb</span><span class="p">()</span> <span class="p">{</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nb">println</span><span class="p">(</span><span class="nx">fa</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span>     <span class="c1">// 输出：false</span>
    <span class="c1">// println(fa == fb)   // 输出：func can only be compared to nil</span>
<span class="p">}</span>

<span class="c1">// 多返回值，命名返回值</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">file</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nx">Write</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>

<span class="c1">// defer</span>
<span class="k">defer</span> <span class="nx">un</span><span class="p">(</span><span class="nx">trace</span><span class="p">(</span><span class="sc">&#39;a&#39;</span><span class="p">))</span>
<span class="c1">// 基于函数调用，会先调用 trace(&#39;a&#39;)--&gt;&#39;A&#39;，然后退出时调用：un(&#39;A&#39;) </span>
</code></pre></div>

<h3 id="_20">变参</h3>
<p>变参本质上一个切片。</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">f</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span> <span class="o">...</span><span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">a</span> <span class="p">{</span>
            <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">100</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">a</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">}</span>
    <span class="nx">f</span><span class="p">(</span><span class="nx">a</span><span class="o">...</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// [101 102 103]</span>
</code></pre></div>

<h3 id="_21">匿名函数</h3>
<ol>
<li>匿名函数是指没有定义名字的符号的函数</li>
<li>函数内部不能定义有名函数，可以定义匿名函数</li>
</ol>
<h3 id="_22">闭包</h3>
<ol>
<li>闭包是在其语法上下文中引用了自由变量的函数</li>
<li>闭包是<strong>函数和其引用的环境</strong>的环境的组合体</li>
<li>闭包直接引用了原环境变量</li>
<li>多个匿名函数引用同一环境变量，任何修改行为都会影响其他函数取值，在并发场景下，需要做同步处理</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">test</span><span class="p">()</span> <span class="p">[]</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">s</span> <span class="p">[]</span><span class="kd">func</span><span class="p">()</span>

    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">s</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="nb">println</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">s</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">f</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">test</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">f</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">0xc0000140c0 2</span>
<span class="cm">0xc0000140c0 2</span>
<span class="cm">*/</span>
</code></pre></div>

<h3 id="defer">defer</h3>
<ol>
<li>延迟调用注册的是调用，必须提供执行所需参数。</li>
<li>单数值在注册时被复制被缓存起来。</li>
<li>延迟调用可以修改当前函数的命名返回值。</li>
<li>defer调用函数返回值被抛弃。</li>
<li>return和panic都会引发defer调用。</li>
<li>先注册后执行。</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="nx">m</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>

<span class="kd">func</span> <span class="nx">call</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">m</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
    <span class="nx">m</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">deferCall</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">m</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
    <span class="k">defer</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">BenchmarkCall</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">call</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">BenchmarkDefer</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">deferCall</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">BenchmarkCall-4     92063137            12.5 ns/op         0 B/op          0 allocs/op</span>
<span class="cm">BenchmarkDefer-4    77778711            14.8 ns/op         0 B/op          0 allocs/op</span>

<span class="cm">在Go1.14版本后，defer性能已经被优化得非常好了。</span>
<span class="cm">*/</span>
</code></pre></div>

<h3 id="init">init</h3>
<ol>
<li>每个文件都可以定义init函数（可以定义多个init函数）</li>
<li>init函数在变量申明之后，调用init函数</li>
<li>所有导入包被初始化之后，才调用init函数</li>
<li>常见的用法是在程序执行前，验证或者修复程序状态</li>
<li>如果包内有多个init函数，每个init的执行顺序是不确定的</li>
</ol>
<h2 id="_23">数据</h2>
<h3 id="_24">字符串</h3>
<p>字符串是一个不可变字节（byte）序列，本身是一个复合结构。</p>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">stringStruct</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">str</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
    <span class="nx">len</span> <span class="kt">int</span>
<span class="p">}</span>
</code></pre></div>

<ol>
<li>头部指针指向字节数组，没有NULL结尾。</li>
<li>默认以UTF-8编码存储Unicode字符。</li>
<li>字面量中允许使用十六进制、八进制和UTF编码格式。</li>
<li>字符串默认值是""，而不是nil。</li>
<li>可以使用索引访问字节数组（非字符），但是不能获取元素地址。</li>
<li>对字符串进行切片时返回子串时，内部依旧指向元字节数组。</li>
<li>使用for遍历字符串时，分byte和rune两种方式。</li>
<li>要修改字符串，需要将其转换为可变类型（[]rune 或者 []byte），完成后再转换回来。转换需要重新分配内存，并复制数据。</li>
<li>有些时候，转换会拖累算法性能，可以尝试用“非安全”方法进行改善。原理是：[]byte和string的头结构“部分相同”。</li>
<li>动态构建字符串（用加法拼接字符串，每次都重新分配内存）也容易造成性能问题。可以使用 <code>strings.Join</code> 或者 <code>bytes.Buffer</code> 来改善。</li>
<li>使用单引号的字符，默认就是rune类型。</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">ExampleStrings</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">s</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">s1</span> <span class="kt">string</span>
    <span class="nx">s2</span> <span class="o">:=</span> <span class="s">&quot;世界\x61\142\u0041&quot;</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%s\n&quot;</span><span class="p">,</span> <span class="nx">s2</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;% x, len: %d\n&quot;</span><span class="p">,</span> <span class="nx">s2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s2</span><span class="p">))</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%T %T %T\n&quot;</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">s1</span><span class="p">,</span> <span class="nx">s2</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="o">*</span><span class="nx">s</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">s1</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">s2</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%d\n&quot;</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Sizeof</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%d\n&quot;</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Sizeof</span><span class="p">(</span><span class="nx">s1</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%d\n&quot;</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Sizeof</span><span class="p">(</span><span class="nx">s2</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%#v\n&quot;</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">StringHeader</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">(</span><span class="nx">s</span><span class="p">)))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%#v\n&quot;</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">StringHeader</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">s1</span><span class="p">)))</span>
    <span class="c1">// fmt.Printf(&quot;%#v\n&quot;, (*reflect.StringHeader)(unsafe.Pointer(&amp;s2)))</span>
    <span class="c1">// &amp;reflect.StringHeader{Data:0x4c7430, Len:9}</span>

    <span class="c1">// Output:</span>
    <span class="c1">// 世界abA</span>
    <span class="c1">// e4 b8 96 e7 95 8c 61 62 41, len: 9</span>
    <span class="c1">// *string string string</span>
    <span class="c1">// true true false</span>
    <span class="c1">// 8</span>
    <span class="c1">// 16</span>
    <span class="c1">// 16</span>
    <span class="c1">// &amp;reflect.StringHeader{Data:0x0, Len:0}</span>
    <span class="c1">// &amp;reflect.StringHeader{Data:0x0, Len:0}</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">ExampleStrings02</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">s</span> <span class="o">:=</span> <span class="s">&quot;世界&quot;</span>

    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%d: [%c]\n&quot;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">s</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">c</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%d: [%c]\n&quot;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%T %T\n&quot;</span><span class="p">,</span> <span class="sc">&#39;我&#39;</span><span class="p">,</span> <span class="sc">&#39;w&#39;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">utf8</span><span class="p">.</span><span class="nx">RuneCountInString</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span>
    <span class="c1">// Output:</span>
    <span class="c1">// 0: [ä]</span>
    <span class="c1">// 1: [¸]</span>
    <span class="c1">// 2: []</span>
    <span class="c1">// 3: [ç]</span>
    <span class="c1">// 4: []</span>
    <span class="c1">// 5: []</span>
    <span class="c1">// 0: [世]</span>
    <span class="c1">// 3: [界]</span>
    <span class="c1">// int32 int32</span>
    <span class="c1">// 世界 2</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="_25">数组</h3>
<ol>
<li>数组是值，把一个数组赋值给另一个数组是所有元素的拷贝(<img alt="⭐️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/2b50.svg" title=":star:" />)</li>
<li>如果把数组传给函数，则是数组的拷贝，并不是指针</li>
<li>数组的大小是其类型的一部分。类型<code>[10]int</code>和<code>[20]int</code>是不同的类型。</li>
<li>数组是构建切片的基础</li>
<li>使用range进行数组遍历时，实际遍历的是数组的拷贝，可以使用切片来代替数组，避免数组的拷贝</li>
<li>如果元素支持 == 或者 != 操作符，则数组也支持此操作</li>
<li>可获取任意元素地址，数组指针可以用来操作元素</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">Sum</span><span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="kt">float64</span><span class="p">)</span> <span class="p">(</span><span class="nx">sum</span> <span class="kt">float64</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="o">*</span><span class="nx">a</span> <span class="p">{</span>
        <span class="nx">sum</span> <span class="o">+=</span> <span class="nx">v</span>
    <span class="p">}</span>
    <span class="k">return</span>
<span class="p">}</span>

<span class="nx">array</span> <span class="o">:=</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="kt">float64</span><span class="p">{</span><span class="mf">7.0</span><span class="p">,</span> <span class="mf">8.5</span><span class="p">,</span> <span class="mf">9.1</span><span class="p">}</span>
<span class="nx">x</span> <span class="o">:=</span> <span class="nx">Sum</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">array</span><span class="p">)</span>  <span class="c1">// 需要显式取地址，尽量使用切片</span>
</code></pre></div>

<h3 id="_26">切片</h3>
<ol>
<li>三种初始化方式</li>
<li>切片作为参数传递时，仅传递地址（实际传递的是下面所示的结构，按值传递）</li>
<li>传递切片不需要传递长度</li>
<li>切片不支持比较操作，即使元素类型支持也不行，仅能判断是否为nil</li>
<li>可以获取元素地址，但是不能像数组那样用指针访问元素内容</li>
<li>切片操作 <code>s[start:end]</code> 底层还是指向原有数组，修改新切片对所有关联数组可见</li>
<li>Append操作<ol>
<li><code>s = append(s, d)</code>，需要将切片返回出来：传递slice给另一个函数，如果在这个函数中进行append操作，导致新创建了底层数组。则slice中的内容不会反映到上层调用函数中</li>
<li>nil切片，也可以进行append操作</li>
<li>append时，如果超出cap限制，，新分配数组是原数组cap的2倍</li>
</ol>
</li>
<li><code>copy(dst, src)</code> 仅拷贝len(dst)和len(src)较小的一个。允许区间重叠。</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1">// slice 的底层实现</span>
<span class="kd">type</span> <span class="nx">Slice</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">data</span> <span class="o">*</span><span class="kt">byte</span> <span class="c1">// pointer to the first element</span>
    <span class="nx">len</span> <span class="kt">int</span>
    <span class="nx">cap</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span> <span class="p">[]</span><span class="kt">int</span>
    <span class="nx">b</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{}</span>
    <span class="nx">c</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="nb">println</span><span class="p">(</span><span class="nx">a</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">b</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">c</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;a: %#v\n&quot;</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">SliceHeader</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">a</span><span class="p">)))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;b: %#v\n&quot;</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">SliceHeader</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">b</span><span class="p">)))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;b: %#v\n&quot;</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">SliceHeader</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">)))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;a size: %d\n&quot;</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Sizeof</span><span class="p">(</span><span class="nx">a</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;b size: %d\n&quot;</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Sizeof</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;c size: %d\n&quot;</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Sizeof</span><span class="p">(</span><span class="nx">c</span><span class="p">))</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">true false false</span>
<span class="cm">a: &amp;reflect.SliceHeader{Data:0x0, Len:0, Cap:0}</span>
<span class="cm">b: &amp;reflect.SliceHeader{Data:0x11c3e60, Len:0, Cap:0}</span>
<span class="cm">b: &amp;reflect.SliceHeader{Data:0xc0000c4000, Len:3, Cap:3}</span>
<span class="cm">a size: 24</span>
<span class="cm">b size: 24</span>
<span class="cm">c size: 24</span>
<span class="cm">*/</span>
</code></pre></div>

<p>二维切片</p>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">Transform</span> <span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="kt">float64</span>  <span class="c1">// A 3x3 array, really an array of arrays.</span>
<span class="kd">type</span> <span class="nx">LinesOfText</span> <span class="p">[][]</span><span class="kt">byte</span>     <span class="c1">// A slice of byte slices.</span>

<span class="c1">// 切片的长度是可变的，所以每个内部切片可以有不同的长度</span>
<span class="nx">text</span> <span class="o">:=</span> <span class="nx">LinesOfText</span> <span class="p">{</span>
    <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;Now is the time&quot;</span><span class="p">),</span>
    <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;for all good gophers&quot;</span><span class="p">),</span>
    <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;to bring some fun to the party.&quot;</span><span class="p">),</span>
<span class="p">}</span>

<span class="c1">// 创建二维切片</span>
<span class="nx">picture</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([][]</span><span class="kt">uint8</span><span class="p">,</span> <span class="nx">YSize</span><span class="p">)</span>
<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">picture</span> <span class="p">{</span>
    <span class="nx">picture</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">uint8</span><span class="p">,</span> <span class="nx">XSize</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 通过创建一维切片，然后生成二维切片</span>
<span class="nx">picture</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([][]</span><span class="kt">uint8</span><span class="p">,</span> <span class="nx">YSize</span><span class="p">)</span>
<span class="nx">pixels</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">uint8</span><span class="p">,</span> <span class="nx">XSize</span><span class="o">*</span><span class="nx">YSize</span><span class="p">)</span>
<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">picture</span> <span class="p">{</span>
    <span class="nx">picture</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">pixels</span> <span class="p">=</span> <span class="nx">pixels</span><span class="p">[:</span><span class="nx">XSize</span><span class="p">],</span> <span class="nx">pixels</span><span class="p">[</span><span class="nx">XSize</span><span class="p">:]</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="map">map</h3>
<ol>
<li>map是一个方便而又强大的内置数据结构</li>
<li>map有两种类型的初始化方式，值为nil的map无法直接使用</li>
<li>将一种类型(key)与另一种类型关联起来(value)，key必须是支持相等运算符的类型</li>
<li>键可以是定义了相等运算符的任何类型（整数，浮点数，复数，字符串，指针，接口（只要动态类型支持相等运算），结构和数组）</li>
<li>切片不能被当做key来使用，因为切片的相等是未定义的</li>
<li>map可以通过函数参数传递，修改内容对调用者可见</li>
<li>对map进行range迭代，每次返回的KV顺序都是不同的。但是<code>fmt.Printf("%v", m)</code>方式输出时固定的顺序（方便写测试用例）</li>
<li>不能直接修改value成员（结构或者数组）</li>
<li>在迭代期间删除或者新增键值是安全的</li>
<li>运行时会对map的并发做出检测</li>
<li>在创建时预先准备足够的空间有助于提升性能，减少扩张时的内存分配和重新哈希操作</li>
<li>map不会收缩，如果仅操作一个大map中的小部分，建议用新的map来替代，大的map可以被垃圾回收</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">m</span> <span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="kt">string</span>
    <span class="nx">m1</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span>
    <span class="nx">m2</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="kt">string</span><span class="p">{}</span>

    <span class="c1">// m[1] = &quot;one&quot;     // panic: assignment to entry in nil map</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">m</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">m1</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">m2</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">m1</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">m2</span><span class="p">)</span>

    <span class="nx">m1</span><span class="p">[</span><span class="mi">1000</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;one thousand&quot;</span>
    <span class="nx">m1</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;one hundred&quot;</span>
    <span class="nx">m1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;one&quot;</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">m1</span><span class="p">)</span>

    <span class="nx">m3</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">][]</span><span class="kt">int</span><span class="p">)</span>
    <span class="nx">m3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
    <span class="nx">m3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">}</span>
    <span class="nx">m3</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">}</span>

    <span class="kd">type</span> <span class="nx">user</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">name</span> <span class="kt">string</span>
        <span class="nx">age</span>  <span class="kt">byte</span>
    <span class="p">}</span>
    <span class="nx">m4</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="nx">user</span><span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;Tom&quot;</span><span class="p">,</span> <span class="mi">19</span><span class="p">},</span>
        <span class="mi">2</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;Jim&quot;</span><span class="p">,</span> <span class="mi">28</span><span class="p">},</span>
    <span class="p">}</span>
    <span class="c1">// m4[1].age++     // cannot assign to struct field m4[1].age in map</span>
    <span class="nx">_</span> <span class="p">=</span> <span class="nx">m4</span>

    <span class="nx">m5</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="kt">int</span><span class="p">)</span>
    <span class="nx">m5</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">}</span>
    <span class="c1">// m5[1][1] = 1   // cannot assign to m5[1][1]</span>
    <span class="nx">v</span> <span class="o">:=</span> <span class="nx">m5</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="nx">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="mi">200</span>
    <span class="nx">_</span> <span class="p">=</span> <span class="nx">m5</span>
<span class="cm">/*</span>
<span class="cm">true false false</span>
<span class="cm">map[]</span>
<span class="cm">map[]</span>
<span class="cm">map[1:one 100:one hundred 1000:one thousand]</span>
<span class="cm">*/</span>
<span class="p">}</span>


<span class="c1">// key是接口类型</span>
<span class="nx">m</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kd">interface</span><span class="p">{}]</span><span class="kt">string</span><span class="p">)</span>
<span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;string 1&quot;</span>
<span class="nx">m</span><span class="p">[</span><span class="mf">1.1</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;string 1.1&quot;</span>
<span class="nx">m</span><span class="p">[[</span><span class="mi">3</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">}]</span> <span class="p">=</span> <span class="s">&quot;array&quot;</span>
<span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">m</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 通过“复合”定义</span>
<span class="kd">var</span> <span class="nx">timeZone</span> <span class="p">=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span>
    <span class="s">&quot;UTC&quot;</span><span class="p">:</span>  <span class="mi">0</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span>
    <span class="s">&quot;EST&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">5</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span>
    <span class="s">&quot;CST&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">6</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span>
    <span class="s">&quot;MST&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">7</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span>
    <span class="s">&quot;PST&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">8</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span>
<span class="p">}</span>
<span class="nx">offset</span> <span class="o">:=</span> <span class="nx">timeZone</span><span class="p">[</span><span class="s">&quot;EST&quot;</span><span class="p">]</span>  <span class="c1">// 通过key直接取值</span>

<span class="c1">// 实现集合</span>
<span class="nx">attended</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">bool</span><span class="p">{</span>
    <span class="s">&quot;Ann&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s">&quot;Joe&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="o">...</span>
<span class="p">}</span>
<span class="k">if</span> <span class="nx">attended</span><span class="p">[</span><span class="nx">person</span><span class="p">]</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">person</span><span class="p">,</span> <span class="s">&quot;was at the meeting&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 测试是否存在</span>
<span class="k">if</span> <span class="nx">seconds</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">timeZone</span><span class="p">[</span><span class="nx">tz</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">seconds</span>
<span class="p">}</span>
<span class="c1">// 忽略值</span>
<span class="nx">_</span><span class="p">,</span> <span class="nx">present</span> <span class="o">:=</span> <span class="nx">timeZone</span><span class="p">[</span><span class="nx">tz</span><span class="p">]</span>

<span class="c1">// 删除，即使不存在也是安全的</span>
<span class="nb">delete</span><span class="p">(</span><span class="nx">timeZone</span><span class="p">,</span> <span class="s">&quot;PDT&quot;</span><span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">m</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">)</span>
    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">{</span>
            <span class="nx">m</span><span class="p">[</span><span class="s">&quot;a&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="mi">1</span>
            <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Microsecond</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>

    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">{</span>
            <span class="nx">_</span> <span class="p">=</span> <span class="nx">m</span><span class="p">[</span><span class="s">&quot;b&quot;</span><span class="p">]</span>
            <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Microsecond</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>
    <span class="k">select</span> <span class="p">{}</span> <span class="c1">// 阻止进程退出</span>
<span class="p">}</span>
<span class="c1">// fatal error: concurrent map read and map write</span>
</code></pre></div>

<h3 id="_27">结构</h3>
<ol>
<li>只有所有字段类型全部支持比较操作时，才可以做相等操作</li>
<li>可以使用指针直接操作结构体中的字段，但是不能是多级指针</li>
<li>空结构<code>struct{}</code>是指没有字段的结构体，无论是其自身还是作为数组元素类型，其长度都为零</li>
<li>空结构可以作为通道元素类型，用于事件通知</li>
<li><strong>匿名字段</strong>是指没有名字，只有类型的字段，也被称作嵌入字段或者嵌入类型（从编译器的角度看，只是隐式地以类型名作为字段名字。</li>
<li>标签：可以通过反射获取标签信息</li>
<li>对齐：在分配内存时，通常以所有字段总最长的基础类型宽度作为标准。（[]int基础类型是int，对齐宽度是8）</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span> <span class="kd">struct</span><span class="p">{}</span>
    <span class="kd">var</span> <span class="nx">b</span> <span class="p">[</span><span class="mi">100</span><span class="p">]</span><span class="kd">struct</span><span class="p">{}</span>
    <span class="nb">println</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Sizeof</span><span class="p">(</span><span class="nx">a</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Sizeof</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span>
<span class="p">}</span>
<span class="c1">// 0 0</span>
</code></pre></div>

<h3 id="new">new</h3>
<p>new 的作用是为任意类型申请一片内存空间，并返回指向这片内存的指针。初始化这一块内存区域为零值。在设计数据结构时安排使用每种类型的零值而无需进一步初始化很有用。</p>
<ol>
<li>创建内存区域，返回指针</li>
<li>初始化零值，无需进一步初始化</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">SyncedBuffer</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">lock</span>    <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
    <span class="nx">buffer</span>  <span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
<span class="p">}</span>

<span class="nx">p</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">SyncedBuffer</span><span class="p">)</span>  <span class="c1">// type *SyncedBuffer</span>
<span class="kd">var</span> <span class="nx">v</span> <span class="nx">SyncedBuffer</span>      <span class="c1">// type  SyncedBuffer</span>
</code></pre></div>

<h3 id="_28">构造</h3>
<p>上面的方式来初始化，有时候并不能满足所有场景，有些情况需要根据参数进行结构的构造。</p>
<p>例如：</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">NewFile</span><span class="p">(</span><span class="nx">fd</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">File</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">fd</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="nx">f</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">File</span><span class="p">)</span>
    <span class="nx">f</span><span class="p">.</span><span class="nx">fd</span> <span class="p">=</span> <span class="nx">fd</span>
    <span class="nx">f</span><span class="p">.</span><span class="nx">name</span> <span class="p">=</span> <span class="nx">name</span>
    <span class="nx">f</span><span class="p">.</span><span class="nx">dirinfo</span> <span class="p">=</span> <span class="kc">nil</span>
    <span class="nx">f</span><span class="p">.</span><span class="nx">nepipe</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="nx">f</span>
<span class="p">}</span>
</code></pre></div>

<p>进一步通过“组合”的方式可以简化：</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">NewFile</span><span class="p">(</span><span class="nx">fd</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">File</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">fd</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">File</span><span class="p">{</span><span class="nx">fd</span><span class="p">:</span> <span class="nx">fd</span><span class="p">,</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">name</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>"组合"方式还可以用于，数组、切片、映射的索引和键（只要索引和键不相同即可）：</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="p">(</span>
    <span class="nx">Enone</span>  <span class="p">=</span> <span class="kc">iota</span>
    <span class="nx">Eio</span>
    <span class="nx">Einval</span>
<span class="p">)</span>
<span class="nx">a</span> <span class="o">:=</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="kt">string</span>   <span class="p">{</span><span class="nx">Enone</span><span class="p">:</span> <span class="s">&quot;no error&quot;</span><span class="p">,</span> <span class="nx">Eio</span><span class="p">:</span> <span class="s">&quot;Eio&quot;</span><span class="p">,</span> <span class="nx">Einval</span><span class="p">:</span> <span class="s">&quot;invalid argument&quot;</span><span class="p">}</span>
<span class="nx">s</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span>      <span class="p">{</span><span class="nx">Enone</span><span class="p">:</span> <span class="s">&quot;no error&quot;</span><span class="p">,</span> <span class="nx">Eio</span><span class="p">:</span> <span class="s">&quot;Eio&quot;</span><span class="p">,</span> <span class="nx">Einval</span><span class="p">:</span> <span class="s">&quot;invalid argument&quot;</span><span class="p">}</span>
<span class="nx">m</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="nx">Enone</span><span class="p">:</span> <span class="s">&quot;no error&quot;</span><span class="p">,</span> <span class="nx">Eio</span><span class="p">:</span> <span class="s">&quot;Eio&quot;</span><span class="p">,</span> <span class="nx">Einval</span><span class="p">:</span> <span class="s">&quot;invalid argument&quot;</span><span class="p">}</span>
</code></pre></div>

<h3 id="make">make</h3>
<p>make 关键字的作用是创建 slice、map 和 chan 内置的数据结构，返回初始化后的值，而不是零值。（引用类型：特指内置的三种类型slice、map和chan）。</p>
<p>make会被编译器翻译成具体的创建函数，由其分配内存和初始化成员结构，返回对象而非指针。</p>
<p>原因是：这三种类型必须在使用前进行初始化。</p>
<p>例如切片，包含了三个字段描述（指向数据的指针，内部是一个数组），长度还有容量。</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nb">make</span><span class="p">(</span><span class="nx">t</span> <span class="nx">Type</span><span class="p">,</span> <span class="nx">size</span> <span class="o">...</span><span class="nx">IntegerType</span><span class="p">)</span> <span class="nx">Type</span>

<span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>              <span class="c1">// len=4,cap=4</span>
<span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>           <span class="c1">// len=4,cap=8</span>
<span class="nx">s</span><span class="p">:</span> <span class="p">=</span> <span class="o">*</span><span class="nb">new</span><span class="p">([]</span><span class="kt">int</span><span class="p">)</span>            <span class="c1">// len=0,cap=0,注意new返回指针</span>
<span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span>        <span class="c1">// len=0,cap=NA</span>
<span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="kt">string</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>     <span class="c1">// len=0,cap=NA</span>
<span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>              <span class="c1">// len=0,cap=0,unbuffered</span>
<span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>           <span class="c1">// len=0,cap=4</span>
</code></pre></div>

<p>要获得显式指针，请使用new分配或显式获取变量的地址。</p>
<h3 id="_29">输出</h3>
<ol>
<li>格式化输出与C的printf函数族类似，但是更加丰富，更通用</li>
</ol>
<ul>
<li>
<p><code>fmt.Printf</code>：格式化输出</p>
</li>
<li>
<p><code>fmt.Fprintf</code>：格式化输出到指定文件</p>
</li>
<li>
<p><code>fmt.Sprintf</code>：输出到字符串，实现 <code>io.Writer</code> 接口的类型, <code>os.Stdout</code> 和 <code>os.Stderr</code> </p>
</li>
</ul>
<ol start="2">
<li>不需要格式化，按照Go提供的默认打印</li>
</ol>
<ul>
<li><code>fmt.Print</code> </li>
<li><code>fmt.Println</code> </li>
</ul>
<ol start="3">
<li>
<p>诸如 <code>％d</code> 之类的数字格式不带有标志或大小的标志；相反，使用参数的类型来决定这些属性</p>
</li>
<li>
<p><code>%v</code> 打印任意值（包罗万象）</p>
</li>
</ol>
<ul>
<li>
<p>对于map，打印时按key的字母顺序输出</p>
</li>
<li>
<p><code>%+v</code>：输出结构中的字段名称</p>
</li>
<li>
<p><code>%#v</code>：输出Go语法的值</p>
</li>
</ul>
<ol start="5">
<li>
<p><code>%q</code> 打印双引号引起来的值；<code>%#q</code> 使用反引号</p>
</li>
<li>
<p><code>%x</code> 可在字符串，字节数组和字节切片以及整数上使用，生成一个长的十六进制字符串
- <code>% x</code> 格式的空格在字节之间放置空格。
  - <code>fmt.Printf("% x\n", "string")</code></p>
<ul>
<li><code>Output: 73 74 72 69 6e 67</code></li>
<li><code>%#x</code> 格式在打印十六进制时，打印<code>0x</code>前缀</li>
</ul>
</li>
<li>
<p><code>%b</code> 打印二进制值</p>
</li>
<li>
<p><code>%T</code> 输出值的类型</p>
</li>
<li>
<p>自定义类型的格式化</p>
</li>
</ol>
<p>输出 <code>func (t *T) String() string {}</code></p>
<p>自定义格式化注意不要陷入死循环</p>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">MyString</span> <span class="kt">string</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="nx">MyString</span><span class="p">)</span> <span class="nx">String</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="c1">// 错误，陷入死循环</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;MyString=%s&quot;</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 修改后</span>
<span class="kd">type</span> <span class="nx">MyString</span> <span class="kt">string</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="nx">MyString</span><span class="p">)</span> <span class="nx">String</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="c1">// 使用 string 进行类型转化</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;MyString=%s&quot;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">m</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>

<ol start="10">
<li>可变参数打印</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">MyPrintln</span><span class="p">(</span><span class="nx">v</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">v</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
 <span class="nx">MyPrintln</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>
<span class="cm">/* </span>
<span class="cm">Output:</span>
<span class="cm">[1 2 3]</span>
<span class="cm">1 2 3</span>
<span class="cm">*/</span>
</code></pre></div>

<h4 id="general">General</h4>
<ul>
<li><code>%v</code> 以默认的方式打印变量的值</li>
<li><code>%T</code> 打印变量的类型</li>
</ul>
<h4 id="integer">Integer</h4>
<ul>
<li><code>%+d</code> 带符号的整型，<code>fmt.Printf("%+d", 255)</code>输出<code>+255</code></li>
<li><code>%q</code> 打印单引号</li>
<li><code>%o</code> 不带零的八进制</li>
<li><code>%#o</code> 带零的八进制</li>
<li><code>%x</code> 小写的十六进制</li>
<li><code>%X</code> 大写的十六进制</li>
<li><code>%#x</code> 带0x的十六进制</li>
<li><code>%U</code> 打印Unicode字符</li>
<li><code>%#U</code> 打印带字符的Unicode</li>
<li><code>%b</code> 打印整型的二进制</li>
</ul>
<h4 id="integer-width">Integer width</h4>
<ul>
<li><code>%5d</code> 表示该整型最大长度是5，下面这段代码</li>
</ul>
<div class="highlight"><pre><span></span><code>  fmt.Printf<span class="o">(</span><span class="s2">&quot;|%5d|&quot;</span>, <span class="m">1</span><span class="o">)</span>
  fmt.Printf<span class="o">(</span><span class="s2">&quot;|%5d|&quot;</span>, <span class="m">1234567</span><span class="o">)</span>
</code></pre></div>

<p>输出结果如下：</p>
<div class="highlight"><pre><span></span><code><span class="o">|</span>    <span class="mi">1</span><span class="o">|</span>
<span class="o">|</span><span class="mi">1234567</span><span class="o">|</span>   
</code></pre></div>

<ul>
<li><code>%-5d</code>则相反，打印结果会自动左对齐</li>
<li><code>%05d</code>会在数字前面补零。</li>
</ul>
<h4 id="float">Float</h4>
<ul>
<li><code>%f</code> (=<code>%.6f</code>) 6位小数点</li>
<li><code>%e</code> (=<code>%.6e</code>) 6位小数点（科学计数法）</li>
<li><code>%g</code> 用最少的数字来表示</li>
<li><code>%.3g</code> 最多3位<strong>数字</strong>来表示</li>
<li><code>%.3f</code> 最多3位<strong>小数</strong>来表示</li>
</ul>
<h4 id="string">String</h4>
<ul>
<li><code>%s</code> 正常输出字符串</li>
<li><code>%q</code> 字符串带双引号，字符串中的引号带转义符</li>
<li><code>%#q</code> 字符串带反引号，如果字符串内有反引号，就用双引号代替</li>
<li><code>%x</code> 将字符串转换为小写的16进制格式</li>
<li><code>%X</code> 将字符串转换为大写的16进制格式</li>
<li><code>% x</code> 带空格的16进制格式</li>
</ul>
<h4 id="string-width-5">String Width (以5做例子）</h4>
<ul>
<li><code>%5s</code> 最小宽度为5</li>
<li><code>%-5s</code> 最小宽度为5（左对齐）</li>
<li><code>%.5s</code> 最大宽度为5</li>
<li><code>%5.7s</code> 最小宽度为5，最大宽度为7</li>
<li><code>%-5.7s</code> 最小宽度为5，最大宽度为7（左对齐）</li>
<li><code>%5.3s</code> 如果宽度大于3，则截断</li>
<li><code>%05s</code> 如果宽度小于5，就会在字符串前面补零</li>
</ul>
<h4 id="struct">Struct</h4>
<ul>
<li><code>%v</code> 正常打印。比如：<code>{sam {12345 67890}}</code></li>
<li><code>%+v</code> 带字段名称。比如：<code>{name:sam phone:{mobile:12345 office:67890}</code></li>
<li><code>%#v</code> 用Go的语法打印。
   比如<code>main.People{name:”sam”, phone:main.Phone{mobile:”12345”, office:”67890”}}</code></li>
</ul>
<h4 id="boolean">Boolean</h4>
<ul>
<li><code>%t</code> 打印true或false</li>
</ul>
<h4 id="pointer">Pointer</h4>
<ul>
<li><code>%p</code> 带0x的指针</li>
<li><code>%#p</code> 不带0x的指针</li>
</ul>
<p><a href="https://golang-examples.tumblr.com/post/86795367134/fmtprintf-format-reference-cheat-sheet">https://golang-examples.tumblr.com/post/86795367134/fmtprintf-format-reference-cheat-sheet</a></p>
<h3 id="append">append</h3>
<ol>
<li><code>func append(slice []T, elements ...T) []T</code></li>
<li>我们无法写 T 类型这样的行数，需要编译器的支持</li>
<li>并且需要返回切片，因为函数内部可能会变更切片</li>
<li><code>s = append(s, 4, 5, 6)</code> 多个元素加入切片</li>
<li><code>s = append(s, s...)</code>  切片加入切片</li>
</ol>
<h2 id="_30">方法</h2>
<h3 id="_31">指针与值</h3>
<ol>
<li>方法可以给任意有名的类型来定义（除了指针或者接口），非结构体也可以</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">myPointer</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
<span class="kd">type</span> <span class="nx">myInterface</span> <span class="kd">interface</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">myPointer</span><span class="p">)</span> <span class="nx">String</span><span class="p">()</span>   <span class="p">{}</span> <span class="c1">// 编译报错</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">myInterface</span><span class="p">)</span> <span class="nx">String</span><span class="p">()</span> <span class="p">{}</span> <span class="c1">// 编译报错</span>
</code></pre></div>

<ol start="2">
<li>自定义切片类型，自定义Append方法，结果需要返回更新后的切片</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">ByteSlice</span> <span class="p">[]</span><span class="kt">byte</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">slice</span> <span class="nx">ByteSlice</span><span class="p">)</span> <span class="nx">Append</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
    <span class="c1">// 与 append 方法类似，切片会被扩展，扩展后是新的地址</span>
<span class="p">}</span>
</code></pre></div>

<ol start="3">
<li>也可以定义一个指向切片的指针来更新</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">ByteSlice</span><span class="p">)</span> <span class="nx">Append</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">slice</span> <span class="o">:=</span> <span class="o">*</span><span class="nx">p</span>
    <span class="c1">// Body as above, without the return.</span>
    <span class="o">*</span><span class="nx">p</span> <span class="p">=</span> <span class="nx">slice</span>
<span class="p">}</span>
</code></pre></div>

<ol start="4">
<li>实际上，可以写一个Write方法来实现，这样切片类型满足了 <code>io.Writer</code> 接口</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">ByteSlice</span><span class="p">)</span> <span class="nx">Write</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">slice</span> <span class="o">:=</span> <span class="o">*</span><span class="nx">p</span>
    <span class="c1">// Again as above.</span>
    <span class="o">*</span><span class="nx">p</span> <span class="p">=</span> <span class="nx">slice</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">b</span> <span class="nx">ByteSlice</span>
<span class="c1">// 这里取b的地址，因为只有*ByteSlice满足 io.Writer 接口</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">b</span><span class="p">,</span> <span class="s">&quot;This hour has %d days\n&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
</code></pre></div>

<ol start="5">
<li>接收器指针与接收器值的规则是，可以使用实例值或者指针调用方法，编译器会根据receiver类型自动进行转换。</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">person</span> <span class="kd">struct</span> <span class="p">{</span>
 <span class="nx">name</span> <span class="kt">string</span>
 <span class="nx">age</span>  <span class="kt">uint8</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="nx">person</span><span class="p">)</span> <span class="nx">value</span><span class="p">()</span> <span class="p">{</span>
 <span class="nx">p</span><span class="p">.</span><span class="nx">name</span> <span class="p">=</span> <span class="s">&quot;zhangshu&quot;</span>
 <span class="nx">p</span><span class="p">.</span><span class="nx">age</span> <span class="p">=</span> <span class="mi">18</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">person</span><span class="p">)</span> <span class="nx">pointer</span><span class="p">()</span> <span class="p">{</span>
 <span class="nx">p</span><span class="p">.</span><span class="nx">name</span> <span class="p">=</span> <span class="s">&quot;wangyi&quot;</span>
 <span class="nx">p</span><span class="p">.</span><span class="nx">age</span> <span class="p">=</span> <span class="mi">8</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
 <span class="kd">var</span> <span class="nx">ps</span> <span class="nx">person</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">ps</span><span class="p">)</span>
 <span class="nx">ps</span><span class="p">.</span><span class="nx">value</span><span class="p">()</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">ps</span><span class="p">)</span>
 <span class="nx">ps</span><span class="p">.</span><span class="nx">pointer</span><span class="p">()</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">ps</span><span class="p">)</span>

 <span class="nx">pp</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">person</span><span class="p">{}</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="o">*</span><span class="nx">pp</span><span class="p">)</span>
 <span class="nx">pp</span><span class="p">.</span><span class="nx">value</span><span class="p">()</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="o">*</span><span class="nx">pp</span><span class="p">)</span>
 <span class="nx">pp</span><span class="p">.</span><span class="nx">pointer</span><span class="p">()</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="o">*</span><span class="nx">pp</span><span class="p">)</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">{ 0}</span>
<span class="cm">{ 0}</span>
<span class="cm">{wangyi 8}</span>
<span class="cm">{ 0}</span>
<span class="cm">{ 0}</span>
<span class="cm">{wangyi 8}</span>
<span class="cm">*/</span>
</code></pre></div>

<ol start="6">
<li>方法集</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">S</span> <span class="kd">struct</span><span class="p">{}</span>
<span class="kd">type</span> <span class="nx">T</span> <span class="kd">struct</span><span class="p">{</span> <span class="nx">S</span> <span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">S</span><span class="p">)</span> <span class="nx">FuncSVal</span><span class="p">()</span>  <span class="p">{}</span>
<span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">S</span><span class="p">)</span> <span class="nx">FuncSPtr</span><span class="p">()</span> <span class="p">{}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">T</span><span class="p">)</span> <span class="nx">FuncTVal</span><span class="p">()</span>  <span class="p">{}</span>
<span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">T</span><span class="p">)</span> <span class="nx">FuncTPtr</span><span class="p">()</span> <span class="p">{}</span>

<span class="kd">func</span> <span class="nx">methodSet</span><span class="p">(</span><span class="nx">a</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
 <span class="nx">t</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
 <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">n</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">NumMethod</span><span class="p">();</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
     <span class="nx">m</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Method</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
     <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Type</span><span class="p">)</span>
 <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
 <span class="kd">var</span> <span class="nx">t</span> <span class="nx">T</span>
 <span class="nx">methodSet</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;------------------------&quot;</span><span class="p">)</span>
 <span class="nx">methodSet</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">t</span><span class="p">)</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">FuncSVal func(main.T)</span>
<span class="cm">FuncTVal func(main.T)</span>
<span class="cm">------------------------</span>
<span class="cm">FuncSPtr func(*main.T)</span>
<span class="cm">FuncSVal func(*main.T)</span>
<span class="cm">FuncTPtr func(*main.T)</span>
<span class="cm">FuncTVal func(*main.T)</span>
<span class="cm">*/</span>
</code></pre></div>

<ol start="7">
<li>面向对象的三大特征“封装”、“继承”和”多态“，Go仅实现了部分特征，更倾向于使用”组合优于继承“这种思想。</li>
</ol>
<h3 id="_32">指针与值接收器总结</h3>
<ol>
<li>基本指导</li>
<li>对于给定的类型，不要混合使用值和指针接收器</li>
<li>如果有疑问，使用指针接收器（安全并且可扩展）</li>
<li>指针接受器</li>
<li>方法需要修改接受者</li>
<li>结构中包含了 sync.Mutex 或者类似的同步字段（不能被拷贝）</li>
<li>很大的结构，数组（使用指针接收器更高效）</li>
<li>值接收器</li>
<li>对于 map，func 和 chan 类型</li>
<li>对于简单的基本类型：int, string</li>
<li>只有值类型，没有可变字段和指针的小数组，结构</li>
<li>对于切片，不会触发重新切片或者重新分配</li>
<li>可以将接收器，当做函数的一个参数来思考用哪种方式传递</li>
</ol>
<h3 id="_33">匿名字段</h3>
<ol>
<li>可以像访问匿名字段成员那样调用其方法，由编译器负责查找</li>
<li>方法也有同名遮蔽问题，但是利用这个特性，可实现类似覆盖的操作</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">user</span> <span class="kd">struct</span><span class="p">{}</span>
<span class="kd">type</span> <span class="nx">manager</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
    <span class="nx">user</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="nx">toString</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">&quot;user&quot;</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">manager</span><span class="p">)</span> <span class="nx">toString</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">m</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; is manager&quot;</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">m</span> <span class="o">:=</span> <span class="nx">manager</span><span class="p">{}</span>
    <span class="nx">m</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
    <span class="nx">m</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

    <span class="nb">println</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>
    <span class="nb">println</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="_34">接口</h2>
<p>从内部的实现来看，接口自身也是一种结构类型，只是编译器会对其做出很多限制：（不能有字段；不能定义自己的方法；只能声明方法，不能实现；可以嵌入其他接口类型）</p>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">iface</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">tab</span>  <span class="o">*</span><span class="nx">itab</span>
    <span class="nx">data</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
<span class="p">}</span>
</code></pre></div>

<ol>
<li>在Go语言中，接口提供了一种特定化一个对象行为的方式：如果可以这样做，则可以在这里使用。</li>
<li>在Go语言中，一个或者两个方法的接口很常见。</li>
<li>通常接口名称根据方法名称派生而来，例如 <code>io.writer</code> 是实现了 <code>Write</code> 接口。</li>
<li>一个类型可以实现多个接口。（例如一个集合类型可以通过排序接口排序，还可以通过格式化接口自定义输出格式）</li>
<li>如果一个接口没有任何方法声明，那么就是一个空接口<code>interface{}</code>，它的用途类似面向对象里的根类型 <code>Object</code>，可被赋值为任何对象。</li>
<li>接口变量默认值是nil。如果实现接口的类型支持，则可以做相等运算。</li>
<li>只有当接口变量内部的两个指针（itab, data）都为nil时，接口才是nil。</li>
<li>使用ok-idiom模式，即使接口到具体类型转换失败，也不会引发panic。</li>
<li>可以使用switch在多种类型之间做出判断。这种方式不支持fallthrough。</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">w</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">w</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span>

    <span class="kd">var</span> <span class="nx">buf1</span> <span class="o">*</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">buf1</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span>

    <span class="nx">w</span> <span class="p">=</span> <span class="nx">buf1</span>                  <span class="c1">// 接口类型中有两个字段，赋值之后type变为非nil值，data还是nil</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">w</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">w</span><span class="p">))</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">true</span>
<span class="cm">true</span>
<span class="cm">false</span>
<span class="cm">*bytes.Buffer</span>
<span class="cm">true</span>
<span class="cm">*/</span>
</code></pre></div>

<h3 id="_35">接口转换和类型断言</h3>
<ol>
<li><code>type switch</code>  也是一种转化：接受一个接口，对于每个分支，转化为一种类型。<code>switch str := value.(type)</code></li>
<li>如果我们只关心一种类型，如果我们知道值保存的是 <code>string</code> ，我们希望提取出来，则可以使用类型断言。<code>value.(string)</code></li>
<li>类型断言后的结果是：（1）精确的类型（2）可以转换成的另一个接口</li>
<li>类型断言如果与期望的类型不匹配，则会出现运行时错误。</li>
<li>可以使用 <code>str, ok := value.(string)</code> 来判断是否是指定的类型。</li>
<li>如果转换失败，则str是一个空字符串。</li>
</ol>
<h3 id="_36">通用性</h3>
<p>若某种现有的类型仅实现了一个接口，且除此之外并无可导出的方法，则该类型本身就无需导出。 <strong>仅导出该接口</strong>能让我们更专注于其行为而非实现，其它属性不同的实现则能镜像该原始类型的行为。 这也能够避免为每个通用接口的实例重复编写文档。</p>
<p>构造函数应当返回一个接口值而非实现的类型。</p>
<p>只需修改构造函数调用即可，其余代码则不受算法改变的影响。</p>
<p>【GO设计思想】减少冗余，替换实现很简单，可以快速验证不同的实现。</p>
<h3 id="_37">接口和方法</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// 1. 结构体附加接口</span>
<span class="kd">type</span> <span class="nx">Counter</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">n</span> <span class="kt">int</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">ctr</span> <span class="o">*</span><span class="nx">Counter</span><span class="p">)</span> <span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ctr</span><span class="p">.</span><span class="nx">n</span><span class="o">++</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;counter = %d\n&quot;</span><span class="p">,</span> <span class="nx">ctr</span><span class="p">.</span><span class="nx">n</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 2. 整数类型附加接口</span>
<span class="kd">type</span> <span class="nx">Counter1</span> <span class="kt">int</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">ctr</span> <span class="o">*</span><span class="nx">Counter1</span><span class="p">)</span> <span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">*</span><span class="nx">ctr</span><span class="o">++</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;counter = %d\n&quot;</span><span class="p">,</span> <span class="o">*</span><span class="nx">ctr</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 3. 通道类型附加接口</span>
<span class="kd">type</span> <span class="nx">Chan</span> <span class="kd">chan</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">ch</span> <span class="nx">Chan</span><span class="p">)</span> <span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">req</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprint</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;notification sent&quot;</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">ch</span> <span class="nx">Chan</span><span class="p">)</span> <span class="nx">readChan</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">ch</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">Method</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 4. 方法类型附加接口</span>
<span class="kd">type</span> <span class="nx">HandlerFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">f</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nx">ArgServer</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintln</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">ctr</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Counter</span><span class="p">)</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">&quot;/counter&quot;</span><span class="p">,</span> <span class="nx">ctr</span><span class="p">)</span>

    <span class="nx">c</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="nx">Chan</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">go</span> <span class="nx">c</span><span class="p">.</span><span class="nx">readChan</span><span class="p">()</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">&quot;/chan&quot;</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>

    <span class="nx">http</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">&quot;/args&quot;</span><span class="p">,</span> <span class="nx">HandlerFunc</span><span class="p">(</span><span class="nx">ArgServer</span><span class="p">))</span>

    <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:8080&quot;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>

<p>从一个结构，一个整数，一个通道和一个函数来建立HTTP服务器，这是因为接口仅仅是方法的集合，而几乎任何类型都能定义方法。</p>
<h2 id="_38">其它</h2>
<h3 id="_39">转换</h3>
<ol>
<li><code>Sequence []int</code> 与 <code>[]int</code> 类型可以安全互转。</li>
<li>上面的转换并没有创建新值，只是临时地像具有新类型一样工作。</li>
<li>有些转换如整数到浮点数的转换会产生新值。</li>
<li>在Go语言中转换表达式类型以访问一组不同方法是一种习惯用法。</li>
<li>可以将序列类型转换为<code>type IntSlice []int</code>然后使用<code>IntSlice</code>类型的排序方法：<code>sort.IntSlice(s).Sort()</code></li>
</ol>
<h3 id="_40">空白标识符</h3>
<ol>
<li>多重赋值，<code>if _, err := os.Stat(path); os.IsNotExist(err)</code></li>
<li>未使用的导入和变量 <code>var _ = fmt.Print</code>  <code>var _ io.Reader</code></li>
<li>为辅助作用而导入 <code>import _ "net/http/pprof"</code></li>
<li>接口检查 <code>if _, ok := val.(json.Marshaler); ok</code></li>
</ol>
<h3 id="_41">内嵌</h3>
<ol>
<li>接口内嵌</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">Reader</span> <span class="kd">interface</span> <span class="p">{</span>
 <span class="nx">Read</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Writer</span> <span class="kd">interface</span> <span class="p">{</span>
 <span class="nx">Write</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// ReadWriter 接口结合了 Reader 和 Writer 接口。</span>
<span class="kd">type</span> <span class="nx">ReadWriter</span> <span class="kd">interface</span> <span class="p">{</span>
 <span class="nx">Reader</span>
 <span class="nx">Writer</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li>结构内嵌</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1">// ReadWriter 存储了指向 Reader 和 Writer 的指针。</span>
<span class="c1">// 它实现了 io.ReadWriter。</span>
<span class="kd">type</span> <span class="nx">ReadWriter</span> <span class="kd">struct</span> <span class="p">{</span>
 <span class="o">*</span><span class="nx">Reader</span>  <span class="c1">// *bufio.Reader（结构）</span>
 <span class="o">*</span><span class="nx">Writer</span>  <span class="c1">// *bufio.Writer（结构）</span>
<span class="p">}</span>

<span class="c1">// 也可以定义为</span>
<span class="kd">type</span> <span class="nx">ReadWriter</span> <span class="kd">struct</span> <span class="p">{</span>
 <span class="nx">reader</span> <span class="o">*</span><span class="nx">Reader</span>
 <span class="nx">writer</span> <span class="o">*</span><span class="nx">Writer</span>
<span class="p">}</span>
<span class="c1">// 但是必须定义转发方法，才能满足io接口，通过结构体内嵌，就能避免繁琐</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">rw</span> <span class="o">*</span><span class="nx">ReadWriter</span><span class="p">)</span> <span class="nx">Read</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
 <span class="k">return</span> <span class="nx">rw</span><span class="p">.</span><span class="nx">reader</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<ol start="3">
<li>
<p>命名冲突问题，解决规则：字段或者方法 <code>X</code> 会隐藏该类型中更深层嵌套的其他 <code>X</code>。</p>
</li>
<li>
<p>相同的嵌套层级上出现相同的名字，通常会产生一个错误。</p>
</li>
</ol>
<h3 id="_42">错误</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// error 是一个Go内置接口类型，nil表示没有错误</span>
<span class="kd">type</span> <span class="kt">error</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">Error</span><span class="p">()</span> <span class="kt">string</span>
<span class="p">}</span>
</code></pre></div>

<ul>
<li>error</li>
<li>panic <code>func panic(v interface{})</code></li>
<li>recover <code>func recover() interface{}</code> 在panic后重新获取goroutine的控制权，恢复正常执行，返回panic传入的内容。</li>
<li>尽管这种模式很有用，但它应当仅在包内使用。将内部的 <code>panic</code> 调用转为 <code>error</code> 值，它并不会向调用者暴露出 <code>panic</code>。这是个值得遵守的良好规则。</li>
<li>panic信息会被向上（调用者）传递，如果没有遇到recover，则继续传递直到main，然后抛出异常。</li>
<li>defer在发生panic时也会被调用，先defer后panic。</li>
</ul>
<h2 id="_43">并发</h2>
<p>不要通过共享内存来通信，而应<strong>通过通信来共享内存</strong>。</p>
<p>例如，引用计数通过为整数变量添加互斥锁可以很好地实现。但是通过通道来控制访问，能够写出更简洁，正确的程序。</p>
<p>若将通信看做同步者， 那就完全不需要其它同步了。</p>
<p>Unix管道就与这种模型完美契合。 尽管Go的并发处理方式来源于Hoare的通信顺序处理（CSP）， 它依然可以看做是类型安全的Unix管道的实现。</p>
<h3 id="goroutine">goroutine</h3>
<ol>
<li>goroutine是一个函数，在同一个地址空间与其它goroutine并发执行。</li>
<li>它是轻量级的，其消耗基本就只有栈空间分配。而且栈开始时很小，代价很小，并且通过根据需要分配（和释放）堆存储来增长。</li>
<li>goroutine在操作系统多线程上实现多路复用。因此如果等待I/O，则其它可以继续。设计隐藏了许多线程创建和管理的复杂性。</li>
<li>启动goroutine的函数如果有返回值，会被丢弃（因为返回值一般是同步等待的）</li>
<li><code>go routine()</code></li>
</ol>
<h3 id="chan">chan</h3>
<ol>
<li>无缓冲chan，<code>c1 := make(chan int)</code></li>
<li>有缓冲chan，<code>c2 := make(chan int, 3)</code></li>
<li>指向文件指针的带缓冲chan，<code>c3 := make(chan *os.File, 100)</code></li>
</ol>
<p>示例：关闭通道，引发其他等待goroutine全部收到信号。</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>

    <span class="nx">ready</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">wg</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">id</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nx">Done</span><span class="p">()</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="s">&quot;: ready.&quot;</span><span class="p">)</span>
            <span class="o">&lt;-</span><span class="nx">ready</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="s">&quot;: running...&quot;</span><span class="p">)</span>
            <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Int</span><span class="p">()</span><span class="o">%</span><span class="mi">3</span><span class="p">))</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="s">&quot;: finish&quot;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Format</span><span class="p">(</span><span class="s">&quot;15:04:05&quot;</span><span class="p">))</span>
        <span class="p">}(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Ready ? Go!&quot;</span><span class="p">)</span>
    <span class="nb">close</span><span class="p">(</span><span class="nx">ready</span><span class="p">)</span>
    <span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">3 : ready.</span>
<span class="cm">2 : ready.</span>
<span class="cm">1 : ready.</span>
<span class="cm">Ready ? Go!</span>
<span class="cm">3 : running...</span>
<span class="cm">1 : running...</span>
<span class="cm">2 : running...</span>
<span class="cm">2 : finish 22:07:02</span>
<span class="cm">1 : finish 22:07:03</span>
<span class="cm">3 : finish 22:07:04</span>
<span class="cm">*/</span>
</code></pre></div>

<p>示例：这段代码是一个速率受限的、并行的、无阻塞的RPC系统的框架，而且看不到互斥代码。</p>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">Request</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">args</span>       <span class="p">[]</span><span class="kt">int</span>
    <span class="nx">f</span>          <span class="kd">func</span><span class="p">([]</span><span class="kt">int</span><span class="p">)</span> <span class="kt">int</span>
    <span class="nx">resultChan</span> <span class="kd">chan</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">sum</span><span class="p">(</span><span class="nx">a</span> <span class="p">[]</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">s</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">a</span> <span class="p">{</span>
        <span class="nx">s</span> <span class="o">+=</span> <span class="nx">v</span>
        <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">server</span><span class="p">(</span><span class="nx">queue</span> <span class="kd">chan</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">req</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">queue</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">resultChan</span> <span class="o">&lt;-</span> <span class="nx">req</span><span class="p">.</span><span class="nx">f</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">args</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">client</span><span class="p">(</span><span class="nx">queue</span> <span class="kd">chan</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">s</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">i</span><span class="p">}</span>
        <span class="nx">request</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Request</span><span class="p">{</span><span class="nx">s</span><span class="p">,</span> <span class="nx">sum</span><span class="p">,</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)}</span>
        <span class="nx">queue</span> <span class="o">&lt;-</span> <span class="nx">request</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;sum%v answer: %d\n&quot;</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="o">&lt;-</span><span class="nx">request</span><span class="p">.</span><span class="nx">resultChan</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">queue</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">Request</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">go</span> <span class="nx">server</span><span class="p">(</span><span class="nx">queue</span><span class="p">)</span>
    <span class="nx">client</span><span class="p">(</span><span class="nx">queue</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="_44">并行</h3>
<p>并行向量相加</p>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">Vector</span> <span class="p">[]</span><span class="kt">float64</span>

<span class="c1">// Apply the operation to v[i], v[i+1] ... up to v[n-1].</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">v</span> <span class="nx">Vector</span><span class="p">)</span> <span class="nx">DoSome</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">u</span> <span class="nx">Vector</span><span class="p">,</span> <span class="nx">c</span> <span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">v</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">u</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="nx">c</span> <span class="o">&lt;-</span> <span class="mi">1</span> <span class="c1">// signal that this piece is done</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">v</span> <span class="nx">Vector</span><span class="p">)</span> <span class="nx">DoAll</span><span class="p">(</span><span class="nx">u</span> <span class="nx">Vector</span><span class="p">,</span> <span class="nx">numCPU</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">c</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">numCPU</span><span class="p">)</span> <span class="c1">// Buffering optional but sensible.</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">numCPU</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="k">go</span> <span class="nx">v</span><span class="p">.</span><span class="nx">DoSome</span><span class="p">(</span><span class="nx">i</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span><span class="o">/</span><span class="nx">numCPU</span><span class="p">,</span> <span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span><span class="o">/</span><span class="nx">numCPU</span><span class="p">,</span> <span class="nx">u</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// Drain the channel.</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">numCPU</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="o">&lt;-</span><span class="nx">c</span> <span class="c1">// wait for one task to complete</span>
    <span class="p">}</span>
    <span class="c1">// All done.</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">numCPU</span> <span class="o">:=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">NumCPU</span><span class="p">()</span>

    <span class="kd">const</span> <span class="nx">MAX</span> <span class="p">=</span> <span class="mi">100000000</span>
    <span class="nx">v</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="nx">Vector</span><span class="p">,</span> <span class="nx">MAX</span><span class="p">)</span>
    <span class="nx">u</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="nx">Vector</span><span class="p">,</span> <span class="nx">MAX</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">MAX</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">v</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
        <span class="nx">u</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">v</span><span class="p">.</span><span class="nx">DoAll</span><span class="p">(</span><span class="nx">u</span><span class="p">,</span> <span class="nx">numCPU</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">v</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
<span class="p">}</span>
</code></pre></div>

<p>Go是一个支持并发的语言，并非所有并行问题都适合用Go来解决。</p>
<h3 id="_45">多路选择</h3>
<p>select 语句提供了一种处理多通道的方法。跟 switch 语句很像，但是每个分支都是一个通道：</p>
<ul>
<li>所有通道都会被监听</li>
<li>select 会阻塞直到某个通道读取到内容</li>
<li>如果多个通道都可以处理，则会以伪随机的方式处理</li>
<li>
<p>如果有默认分支，并且没有通道就绪，则会立即执行</p>
</li>
<li></li>
</ul>
<h2 id="web">web服务器</h2>
<p>生成二维码</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Q=17, R=18</span>
<span class="kd">var</span> <span class="nx">addr</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;addr&quot;</span><span class="p">,</span> <span class="s">&quot;:1718&quot;</span><span class="p">,</span> <span class="s">&quot;http service address&quot;</span><span class="p">)</span> 

<span class="kd">var</span> <span class="nx">templ</span> <span class="p">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">Must</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;qr&quot;</span><span class="p">).</span><span class="nx">Parse</span><span class="p">(</span><span class="nx">templateStr</span><span class="p">))</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">flag</span><span class="p">.</span><span class="nx">Parse</span><span class="p">()</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">(</span><span class="nx">QR</span><span class="p">))</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="o">*</span><span class="nx">addr</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;ListenAndServe:&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">QR</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">templ</span><span class="p">.</span><span class="nx">Execute</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">FormValue</span><span class="p">(</span><span class="s">&quot;s&quot;</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">templateStr</span> <span class="p">=</span> <span class="s">`</span>
<span class="s">&lt;html&gt;</span>
<span class="s">&lt;head&gt; &lt;title&gt;QR Link Generator&lt;/title&gt;&lt;/head&gt;</span>

<span class="s">&lt;body&gt;</span>
<span class="s">    &lt;form action=&quot;/&quot; name=f method=&quot;GET&quot;&gt;</span>
<span class="s">        &lt;input maxLength=64 size=32 name=s value=&quot;&quot; title=&quot;二维码&quot;&gt; </span>
<span class="s">        &lt;input type=submit value=&quot;二维码生成&quot; name=qr&gt;</span>
<span class="s">    &lt;/form&gt;</span>
<span class="s">    {{if .}}</span>
<span class="s">        {{.}} &lt;br&gt;</span>
<span class="s">        &lt;img src=&quot;http://chart.apis.google.com/chart?chs=256x256&amp;cht=qr&amp;choe=UTF-8&amp;chl={{.}}&quot; /&gt;</span>
<span class="s">    {{end}}</span>
<span class="s">&lt;/body&gt;</span>

<span class="s">&lt;/html&gt;</span>
<span class="s">`</span>
</code></pre></div>

<h1 id="_46">编码规范</h1>
<h2 id="_47">总体原则</h2>
<ol>
<li>清晰第一：清晰性是易于维护、易于重构的程序必需具备的特征。 </li>
<li>简洁为美：简洁就是易于理解并且易于实现。 </li>
<li>风格一致：相比个人习惯，所有人共享同一种风格带来的好处，远远超出为统一而付出的代价。</li>
</ol>
<p>注意点：</p>
<ol>
<li>正确使用Go：Go语法简洁，抽象表达能力强，降低了程序员的负担，但又隐藏了很多内部实现细节，不小心会误入陷阱。使用 Go的特性时，要注意正确使用。比如：defer，interface，array等。</li>
<li>安全高效：Go的一些特性，有助于写出安全高效的代码，包括丰富的标准库、Goroutine、Channel等。</li>
</ol>
<p>例外：</p>
<p>修改开源代码、第三方代码时，应该遵守开源代码、第三方代码已有规范，保持风格统一。</p>
<h2 id="1">1 命名</h2>
<ol>
<li>规则1.1：使用驼峰记法进行多单词名称的命名</li>
<li>规则1.2：代码中禁止使用魔鬼数</li>
<li>规则1.3：文件名必须为小写单词，允许加下划线‘_’组合方式</li>
<li>规则1.4：目录名必须为全小写单词，允许加中划线‘-’组合方式，但是头尾不能为中划线</li>
<li>规则1.5：包名<strong>必须全部为小写单词，无下划线</strong>。不要与标准库重名</li>
<li>规则1.6：方法接收名必须为大小写混排，首字母小写。方法接收者命名要能够体现接收者对象</li>
<li>建议1.1：包名尽量与所在目录名一致</li>
<li>建议1.2：函数的返回值应避免使用命名返回值</li>
</ol>
<h2 id="2">2 排版格式</h2>
<ol>
<li>规则2.1：提交代码时，必须使用 gofmt 对代码进行格式化</li>
<li>建议2.1：行宽不超过 120 个字符</li>
<li>建议2.2：相对独立的程序块或语句之间采用空行分隔</li>
</ol>
<h2 id="3">3 注释</h2>
<ol>
<li>规则3.1：注释符与注释内容间要有1空格</li>
<li>规则3.2：文件头注释必须包含版权许可</li>
<li>规则3.3：每个包(package)都必须要有包注释</li>
<li>规则3.4：代码注释放于对应代码的上方或右边</li>
<li>规则3.5：不用的代码段直接删除，不要注释掉</li>
<li>建议3.1：使用流利的中文或英文进行注释</li>
<li>建议3.2：包内所有导出符号都应有注释</li>
</ol>
<h2 id="4">4 方法和函数</h2>
<ol>
<li>规则4.1：避免方法和函数的代码块嵌套过深，不要超过4层</li>
<li>建议4.1：方法和函数的参数个数不超过5个</li>
<li>建议4.2：方法和函数返回值个数不要超过3个</li>
</ol>
<h2 id="5">5 包，接口和结构体</h2>
<ol>
<li>规则5.1：一个目录中只包含一个包（实现一个模块的功能）</li>
<li>规则5.2：禁止使用 . 来简化导入包的对象调用</li>
<li>规则5.3：禁止使用相对路径导入（./subpackage），所有导入路径必须符合 go get 标准</li>
<li>建议5.1：import 的包按照稳定度排序</li>
</ol>
<h2 id="6-go">6 Go语言特性</h2>
<ol>
<li>规则6.1：公共包内禁止使用panic，如果有panic需要内部recover并返回error</li>
<li>规则6.2：一个文件只定义一个init函数</li>
<li>规则6.3：一个包内的如果存在多个init函数，不能有任何的依赖关系</li>
<li>规则6.4：注意init函数内进行初始化的场景限制</li>
<li>规则6.5：声明channel时限定类型，保证最小权限</li>
<li>规则6.6：使用channel时确保对channel是否关闭做检查</li>
<li>规则6.7：禁止在nil和closed的channel上进行接收，发送和关闭操作</li>
<li>建议6.1：避免类型可能不为空的interface和nil直接进行比较</li>
<li>建议6.2：如果函数存在多个返回的地方，则采用defer来完成如关闭资源、解锁等清理操作</li>
<li>建议6.3：避免过度使用defer</li>
</ol>
<h2 id="7">7 编程实践</h2>
<ol>
<li>建议7.1：make申请slice/map时，根据预估大小来申请合适内存</li>
<li>建议7.2：将指针和引用成员放在结构体定义中靠前的位置</li>
<li>建议7.3：避免频繁创建对象导致GC处理性能问题</li>
<li>建议7.4：高并发时避免并发冲突</li>
<li>建议7.5：为高并发的轻量级任务处理创建goroutine池</li>
<li>建议7.6：将cgo调用限制在有限个数的goroutine中进行</li>
</ol>
<h1 id="_48">安全编码</h1>
<h2 id="1_1">1 整数安全</h2>
<ol>
<li>规则1.1：确保无符号整数运算时不会反转</li>
<li>规则1.2：确保有符号整数运算时不会出现溢出</li>
<li>规则1.3：确保整型转换时不会出现截断错误</li>
<li>规则1.4：确保整型转换时不会出现符号错误</li>
<li>规则1.5：确保参与移位的操作数的位数足够</li>
<li>规则1.6：确保整数运算不会出现除零（除法、取模、取余）</li>
</ol>
<h2 id="2_1">2 输入校验</h2>
<ol>
<li>规则2.1：确保对不可信的数据进行输入校验</li>
<li>规则2.2：禁止直接使用不可信数据拼接SQL语句</li>
<li>规则2.3：禁止调用OS命令解析器运行程序以防止命令注入攻击</li>
<li>规则2.4：确保用于数组和切片的下标不越界</li>
</ol>
<h2 id="3_1">3 资源和内存管理</h2>
<ol>
<li>规则3.1：确保能释放文件句柄、DB连接和内存资源等</li>
<li>规则3.2：确保对输入和计算后new分配的数组大小和 make slice、map、chan对象的大小进行合法性校验</li>
<li>规则3.3：确保对象在使用前被有效构建并初始化好（slice必须被make之后才可以使用，如果是nil，append会导致一个新的slice产生）</li>
<li>规则3.4：禁止SetFinalize和指针循环引用同时使用防止内存泄露</li>
<li>规则3.5：禁止重复释放资源</li>
<li>规则3.6：确保每个协程都能安全退出</li>
<li>规则3.7：除在例外中的情形禁止使用 uintptr 与 unsafe.Pointer</li>
</ol>
<h2 id="4_1">4  错误处理</h2>
<ol>
<li>规则4.1：确保正确处理函数的错误返回值</li>
<li>规则4.2：必须使用error作为函数的错误返回值类型</li>
<li>规则4.3：对非错误必须返回无类型的nil</li>
</ol>
<h2 id="5_1">5 操作检查</h2>
<ol>
<li>规则5.1：确保赋值给接口变量的对象指针有效否则应赋予无类型的nil值</li>
<li>规则5.2：确保调用方法或解除引用时接口变量封装的对象指针不为空</li>
<li>规则5.3：必须处理类型断言的失败</li>
<li>规则5.4：确保用key读取到map的元素有效</li>
<li>规则5.5：确保对channel是否关闭做检查</li>
</ol>
<h2 id="6">6 数据竞争访问</h2>
<ol>
<li>规则6.1：禁止在闭包中直接调用循环变量</li>
<li>规则6.2：确保并发安全</li>
</ol>
<h2 id="7_1">7 敏感数据安全</h2>
<ol>
<li>规则7.1：禁止将敏感信息硬编码在程序中</li>
<li>规则7.2：禁止将敏感信息保存在日志中或将其输出到控制台及串口</li>
<li>规则7.3：禁止在记录操作错误的日志中泄露安全敏感信息</li>
<li>规则7.4：禁止序列化未加密的敏感数据</li>
<li>规则7.5：确保将敏感对象发送出信任区域前必须先签名后加密</li>
</ol>
<h2 id="8">8 加解密</h2>
<ol>
<li>规则8.1：使用crypto/rand包生成安全随机数</li>
</ol>
<ul>
<li>在Unix系统 中Reader读取/dev/urandom生成随机数</li>
<li>在Linux系统中Reader使用getrandom生成随机数</li>
<li>在 Windows系统中Reader使用CryptGenRandom API生成随机数。</li>
</ul>
<ol start="2">
<li>规则8.2：禁止使用私有或者弱加密算法</li>
</ol>
<p>禁止使用私有算法或者弱加密算法（如DES、MD5、SHA1等），应该使用经过验证的、安全的、公开的加密算法。</p>
<ol start="3">
<li>规则8.3：基于哈希算法的口令安全存储必须加入盐值</li>
</ol>
<p>密文 = 哈希算法（明文 + 盐值）</p>
<p><strong>存储密码的步骤：</strong></p>
<ol>
<li>使用安全随机数生成足够长的盐值。</li>
<li>将盐值混入密码，并使用标准的密码哈希函数进行加密，如 Argon2、 bcrypt 、 scrypt 或 PBKDF2 。</li>
<li>将盐值和对应的哈希值一起存入用户数据库。</li>
</ol>
<p><strong>校验密码的步骤：</strong></p>
<ol>
<li>从数据库检索出用户的盐值和对应的哈希值。</li>
<li>将盐值混入用户输入的密码，并且使用通用的哈希函数进行加密。</li>
<li>比较上一步的结果，是否和数据库存储的哈希值相同。如果它们相同，则表明密码是正确的；否则，该密码错误。</li>
</ol>
<h2 id="9-io">9 I/O安全</h2>
<ol>
<li>规则9.1：确保临时文件使用完毕后及时删除</li>
<li>规则9.2：确保在多用户系统中创建文件时指定合适的访问权限</li>
<li>规则9.3：确保文件路径验证前对其进行标准化</li>
<li>规则9.4：避免在共享目录操作文件</li>
<li>规则9.5：确保安全地从压缩包中提取文件</li>
</ol>
<h2 id="10">10 异常与控制流</h2>
<ol>
<li>规则10.1：限制调用可导致panic的函数以确保导出函数不能向外部抛panic
   - 注意：当os.Exit()被 调用时，程序将立即结束，所有的defer语句将不会运行。
   - 注意：panic后，panic之前注册的defer还会继续执行。</li>
<li>规则10.2：循环必须有显式退出的条件</li>
<li>规则10.3：禁止循环头和循环体异向修改循环控制参数</li>
<li>建议10.1：确保发生异常时程序尝试恢复到合理状态并记录日志</li>
<li>建议10.2：不使用goto语句</li>
</ol>
<h1 id="_49">底层知识</h1>
<ol>
<li>底层编码相关知识，如：Plan9汇编，内存管理机制与GC，逃逸分析，协程调度机制，CGO</li>
<li>了解多核并发，性能优化调优，CPU架构等</li>
</ol>
<h2 id="_50">汇编</h2>
<p>plan9 中使用寄存器不需要带 r 或 e 的前缀，例如 rax，只要写 AX 就可以了。</p>
<div class="highlight"><pre><span></span><code>eax-&gt;AX
ebx-&gt;BX
ecx-&gt;CX
...
</code></pre></div>

<p>Go 汇编引入了四个伪寄存器，这四个伪寄存器非常重要：</p>
<ul>
<li>FP: Frame pointer，用来访问函数的参数</li>
<li>PC: Program counter: 用于分支和跳转</li>
<li>SB: Static base pointer: 一般用于声明函数或者全局变量</li>
<li>SP: Stack pointer：指向当前栈帧的局部变量的开始位置，一般用来引用函数的局部变量</li>
</ul>
<div class="highlight"><pre><span></span><code># 函数定义
func sub(a, b int) int {
    return a - b
}
func add(a, b int) int {
    return a + b
}

TEXT    &quot;&quot;.sub(SB), NOSPLIT|ABIInternal, $0-24    # 栈帧大小为0，24表示参数及返回值的大小（3*8）
MOVQ    &quot;&quot;.a+8(SP), AX
SUBQ    &quot;&quot;.b+16(SP), AX     # 表示将AX - b --&gt; AX 中


TEXT    &quot;&quot;.add(SB), NOSPLIT|ABIInternal, $0-24
MOVQ    &quot;&quot;.a+8(SP), AX
ADDQ    &quot;&quot;.b+16(SP), AX


func f(s []int) int {
    return s[1]
}

&quot;&quot;.f STEXT nosplit size=71 args=0x20 locals=0x18
        0x0000 00000 (D:\sync\go\main\main.go:8)        TEXT    &quot;&quot;.f(SB), NOSPLIT|ABIInternal, $24-32

        0x000e 00014 (D:\sync\go\main\main.go:8)        MOVQ    $0, &quot;&quot;.~r1+56(SP)
        0x0017 00023 (D:\sync\go\main\main.go:9)        MOVQ    &quot;&quot;.s+40(SP), CX
        0x001c 00028 (D:\sync\go\main\main.go:9)        MOVQ    &quot;&quot;.s+32(SP), DX
        0x0021 00033 (D:\sync\go\main\main.go:9)        CMPQ    CX, $1   # 判断索引1，是否越界
        0x0025 00037 (D:\sync\go\main\main.go:9)        JHI     41       # 跳转到41
        0x0027 00039 (D:\sync\go\main\main.go:9)        JMP     60       # 跳转到60，触发panic
        0x0029 00041 (D:\sync\go\main\main.go:9)        MOVQ    8(DX), AX
        0x002d 00045 (D:\sync\go\main\main.go:9)        MOVQ    AX, &quot;&quot;.~r1+56(SP)
        0x0032 00050 (D:\sync\go\main\main.go:9)        MOVQ    16(SP), BP
        0x0037 00055 (D:\sync\go\main\main.go:9)        ADDQ    $24, SP
        0x003b 00059 (D:\sync\go\main\main.go:9)        RET
        0x003c 00060 (D:\sync\go\main\main.go:9)        MOVL    $1, AX
        0x0041 00065 (D:\sync\go\main\main.go:9)        CALL    runtime.panicIndex(SB)
        0x0046 00070 (D:\sync\go\main\main.go:9)        XCHGL   AX, AX
</code></pre></div>

<h2 id="_51">调度器</h2>
<p>Go采用了用户层轻量级thread或者说是类coroutine的概念来解决这些问题，Go将之称为”goroutine“。goroutine占用的资源非常小(Go 1.4将每个goroutine stack的size默认设置为2k)，goroutine调度的切换也不用陷入(trap)操作系统内核层完成，代价很低。因此，一个Go程序中可以创建成千上万个并发的goroutine。所有的Go代码都在goroutine中执行，哪怕是go的runtime也不例外。将这些goroutines按照一定算法放到“CPU”上执行的程序就称为goroutine调度器或goroutine scheduler。</p>
<p>不过，一个Go程序对于操作系统来说只是一个用户层程序，对于操作系统而言，它的眼中只有thread，它甚至不知道有什么叫Goroutine的东西的存在。goroutine的调度全要靠Go自己完成，实现Go程序内goroutine之间“公平”的竞争“CPU”资源，这个任务就落到了Go runtime头上，要知道在一个Go程序中，除了用户代码，剩下的就是go runtime了。</p>
<p>于是Goroutine的调度问题就演变为go runtime如何将程序内的众多goroutine按照一定算法调度到“CPU”资源上运行了。</p>
<p>G-P-M模型：</p>
<p>运行时调度器将goroutine映射到操作系统线程，goroutine是轻量级的线程，启动时开销很小。每个goroutine由一个结构 G 来描述，其中包含必要的字段以跟踪其堆栈和当前状态。</p>
<p>运行时控制将G映射到逻辑处理器P，P可以被视为需要获取的抽象资源或上下文，以便OS线程（称为M或Machine）可以执行G。</p>
<p>Go 语言并发模型中的 M 是操作系统线程。调度器最多可以创建 10000 个线程，但是其中大多数的线程都不会执行用户代码（可能陷入系统调用），最多只会有 <code>GOMAXPROCS</code> 个活跃线程能够正常运行。</p>
<p>您可以通过调用 <code>runtime.GOMAXPROCS</code> 来控制运行时有多少个逻辑处理器，如果您打算调整此参数（您可能不应该这样做），则只需设置一次然后忘记它，因为它需要STW GC暂停。</p>
<p>本质上，操作系统运行线程，该线程运行您的代码。Go的诀窍是，编译器会在多个位置插入调用到Go运行时（例如，通过通道发送值，调用运行时程序包），以便Go可以通知调度程序并采取措施。</p>
<ul>
<li>G: Goroutine</li>
<li>P: Logical Processer</li>
<li>M: os thread os machine</li>
</ul>
<p>Go运行时存在两种类型的queue： 一种是一个全局的queue(在schedt结构体中，很少用到)， 一种是每个P都维护自己的G的queue。</p>
<p>为了运行goroutine, M需要持有上下文P。M会从P的queue弹出一个goroutine并执行。</p>
<p>当你创建一个新的goroutine的时候(go func()方法)，它会被放入P的queue。当然还有一个 work-stealing 调度算法，当M执行了一些G后，如果它的queue为空，它会随机的选择另外一个P，从它的queue中取走一半的G到自己的queue中执行。(work stealing算法)</p>
<p>当你的goroutine执行阻塞的系统调用的时候(syscall)，阻塞的系统调用会中断(intercepted)，如果当前有一些G在执行，运行时会把这个线程从P中摘除(detach)，然后再创建一个新的操作系统的线程(如果没有空闲的线程可用的话)来服务于这个P。</p>
<p>当系统调用继续的时候，这个goroutine被放入到本地运行queue，线程会park它自己(休眠)， 加入到空闲线程中。</p>
<p>如果一个goroutine执行网络调用，运行时会做类似的动作。调用会被中断，但是由于Go使用集成的network poller，它有自己的线程，所以还给它。</p>
<p>Go运行时会在下面的goroutine被阻塞的情况下运行另外一个goroutine：</p>
<p>－ blocking syscall (for example opening a file),
－ network input,
－ channel operations,
－ primitives in the sync package.</p>
<p>合作式抢占：在函数调用入口等地方加入特定的指令</p>
<p>非合作式抢占：非合作抢占在并发执行上下文之间切换，而无需显式抢占检查或这些上下文的帮助。所有现代桌面操作系统和服务器操作系统都使用它来切换线程。如果没有这个机制，一个表现不佳的应用程序就可以楔入整个系统，就像一个表现不佳的goroutine当前可以楔入go应用程序一样。这也是一个方便的抽象：它让我们在编程时就好像有无限数量的CPU可用，从而隐藏了操作系统在时间复用有限数量的CPU这一事实。</p>
<p><a href="https://github.com/golang/proposal/blob/master/design/24543-non-cooperative-preemption.md">https://github.com/golang/proposal/blob/master/design/24543-non-cooperative-preemption.md</a></p>
<p><a href="https://medium.com/@ankur_anand/illustrated-tales-of-go-runtime-scheduler-74809ef6d19b">https://medium.com/@ankur_anand/illustrated-tales-of-go-runtime-scheduler-74809ef6d19b</a></p>
<h2 id="_52">堆栈信息</h2>
<p>可以获得当前堆栈信息，当前函数名，当前文件名等信息。</p>
<h2 id="_53">内存分配</h2>
<p><a href="https://www.infoq.cn/article/IEhRLwmmIM7-11RYaLHR">图解 Go 内存分配器</a></p>
<p>对于append操作，如果容量不足，则会扩展容量创建新的数组。
旧的数组何时释放？由GC回收。</p>
<h2 id="_54">逃逸分析</h2>
<p>Go 有逃逸分析，在编译期，它会分析你的变量是否在函数执行完毕那一刻，程序有没有可能有别的对象引用到它（所谓逃逸），如果没有，那这个变量就可以在栈上分配，完全不经过 gc。如果它已经逃逸了，那什么时候 gc 就由不得你了。</p>
<div class="highlight"><pre><span></span><code>go build -gcflags<span class="o">=</span><span class="s1">&#39;-m&#39;</span> main.go
</code></pre></div>

<p>两个不变性：</p>
<ol>
<li>指向栈对象的指针不能存在于堆中；</li>
<li>指向栈对象的指针不能在栈对象回收后存活；</li>
</ol>
<p>常见逃逸类型：</p>
<ol>
<li>指针逃逸
   - fmt.Println(i) 传递的是接口，会发生逃逸</li>
<li>栈空间不足逃逸
   - new(int)不会逃逸
   - new([1024 * 1024]) 逃逸</li>
<li>闭包引用逃逸</li>
<li>动态类型逃逸</li>
<li>切片或map赋值</li>
</ol>
<h2 id="_55">垃圾收集</h2>
<p>GC 把 uintptr 当成普通整数对象，它⽆法阻⽌ "关联" 对象被回收。</p>
<h3 id="_56"><strong>垃圾回收算法</strong></h3>
<ol>
<li>
<p>引用计数：对每个对象维护一个引用计数，当引用该对象的对象被销毁时，引用计数减1，当引用计数器为0是回收该对象。</p>
<ul>
<li>优点：对象可以很快的被回收，不会出现内存耗尽或达到某个阀值时才回收。</li>
<li>缺点：不能很好的处理循环引用，而且实时维护引用计数，有也一定的代价。</li>
<li>语言：Python、PHP、Swift</li>
</ul>
</li>
<li>
<p>标记-清除：从根变量开始遍历所有引用的对象，引用的对象标记为”被引用”，没有被标记的进行回收。</p>
<ul>
<li>优点：解决了引用计数的缺点。</li>
<li>缺点：需要STW，即要暂时停掉程序运行。</li>
<li>语言：Golang(其采用三色标记法混合写屏障)</li>
</ul>
</li>
<li>
<p>分代回收：按照对象生命周期长短划分不同的代空间，生命周期长的放入老年代，而短的放入新生代，不同代有不能的回收算法和回收频率。</p>
<ul>
<li>优点：回收性能好</li>
<li>缺点：算法复杂</li>
<li>语言：JAVA</li>
</ul>
</li>
</ol>
<h3 id="_57">三色回收</h3>
<ol>
<li>
<p>初始状态所有对象都是白色。</p>
</li>
<li>
<p>从根出发扫描所有根对象，将他们引用的对象标记为灰色</p>
</li>
<li>
<p>分析灰色对象是否引用了其他对象。如果没有引用其它对象则将该灰色对象标记为黑色；</p>
</li>
</ol>
<p>如果有引用则将它变为黑色的同时将它引用的对象也变为灰色</p>
<ol start="4">
<li>重复步骤3，直到灰色对象队列为空。此<strong>时白色对象即为垃圾，进行回收</strong>。</li>
</ol>
<p>在回收开始前都是白色，<strong>由白变灰变黑</strong>的过程。当垃圾回收开始时，只有白色对象。随着标记过程开始进行时，灰色对象开始出现（着色），这时候波面便开始扩大。当一个对象的所有子节点均完成扫描时，会被着色为黑色。当整个堆遍历完成时，只剩下黑色和白色对象，这时的<strong>黑色对象为可达对象，即存活</strong>；而<strong>白色对象为不可达对象，即死亡</strong>。这个过程可以视为以灰色对象为波面，将黑色对象和白色对象分离，使波面不断向前推进，直到所有可达的灰色对象都变为黑色对象为止的过程。
标记完成后，只有白色和黑色，白色代表死亡，可以回收。黑色是可达对象，不能回收。</p>
<p>写屏障：</p>
<p>该屏障之前的写操作和之后的写操作相比，先被系统其它组件感知。
结合上面GC工作的完整流程就好理解了，就是在每一轮GC开始时会初始化一个叫做“屏障”的东西，然后由它记录第一次scan时各个对象的状态，以便和第二次re-scan进行比对，引用状态变化的对象被标记为灰色以防止丢失，将屏障前后状态未变化对象继续处理。</p>
<p>辅助GC：</p>
<p>从上面的GC工作的完整流程可以看出Golang GC实际上把单次暂停时间分散掉了，本来程序执⾏可能是“⽤户代码&rarr;⼤段GC&rarr;⽤户代码”，那么分散以后实际上变成了“⽤户代码&rarr;⼩段 GC&rarr;⽤户代码&rarr;⼩段GC&rarr;⽤户代码”这样。如果GC回收的速度跟不上用户代码分配对象的速度呢？ Go 语⾔如果发现扫描后回收的速度跟不上分配的速度它依然会把⽤户逻辑暂停，⽤户逻辑暂停了以后也就意味着不会有新的对象出现，同时会把⽤户线程抢过来加⼊到垃圾回收⾥⾯加快垃圾回收的速度。这样⼀来原来的并发还是变成了STW，还是得把⽤户线程暂停掉，要不然扫描和回收没完没了了停不下来，因为新分配对象⽐回收快，所以这种东⻄叫做辅助回收。</p>
<p>GC示例：</p>
<div class="highlight"><pre><span></span><code><span class="n">GODEBUG</span><span class="o">=</span><span class="n">gctrace</span><span class="o">=</span><span class="mi">1</span> <span class="p">.</span><span class="o">/</span><span class="n">app</span>

<span class="n">gc</span> <span class="mi">1405</span> <span class="err">@</span><span class="mf">6.068</span><span class="n">s</span> <span class="mi">11</span><span class="o">%:</span> <span class="mf">0.058</span><span class="o">+</span><span class="mf">1.2</span><span class="o">+</span><span class="mf">0.083</span> <span class="n">ms</span> <span class="n">clock</span><span class="p">,</span> <span class="mf">0.70</span><span class="o">+</span><span class="mf">2.5</span><span class="o">/</span><span class="mf">1.5</span><span class="o">/</span><span class="mi">0</span><span class="o">+</span><span class="mf">0.99</span> <span class="n">ms</span> <span class="n">cpu</span><span class="p">,</span> <span class="mi">7</span><span class="o">-&gt;</span><span class="mi">11</span><span class="o">-&gt;</span><span class="mi">6</span> <span class="n">MB</span><span class="p">,</span> <span class="mi">10</span> <span class="n">MB</span> <span class="n">goal</span><span class="p">,</span> <span class="mi">12</span> <span class="n">P</span>

<span class="c1">// General</span>
<span class="n">gc</span> <span class="mi">1404</span>     <span class="o">:</span> <span class="n">The</span> <span class="mi">1404</span> <span class="n">GC</span> <span class="n">run</span> <span class="n">since</span> <span class="n">the</span> <span class="n">program</span> <span class="n">started</span>
<span class="err">@</span><span class="mf">6.068</span><span class="nl">s</span>     <span class="p">:</span> <span class="n">Six</span> <span class="n">seconds</span> <span class="n">since</span> <span class="n">the</span> <span class="n">program</span> <span class="n">started</span>
<span class="mi">11</span><span class="o">%</span>         <span class="o">:</span> <span class="mi">11</span><span class="o">%</span> <span class="n">of</span> <span class="n">the</span> <span class="n">available</span> <span class="n">CPU</span> <span class="n">so</span> <span class="n">far</span> <span class="n">has</span> <span class="n">been</span> <span class="n">spent</span> <span class="n">in</span> <span class="n">GC</span>

<span class="c1">// Wall-Clock</span>
<span class="mf">0.058</span><span class="nl">ms</span>     <span class="p">:</span> <span class="nl">STW</span>        <span class="p">:</span> <span class="n">Mark</span> <span class="n">Start</span>       <span class="o">-</span> <span class="n">Write</span> <span class="n">Barrier</span> <span class="n">on</span>
<span class="mf">1.2</span><span class="nl">ms</span>       <span class="p">:</span> <span class="nl">Concurrent</span> <span class="p">:</span> <span class="n">Marking</span>
<span class="mf">0.083</span><span class="nl">ms</span>     <span class="p">:</span> <span class="nl">STW</span>        <span class="p">:</span> <span class="n">Mark</span> <span class="n">Termination</span> <span class="o">-</span> <span class="n">Write</span> <span class="n">Barrier</span> <span class="n">off</span> <span class="n">and</span> <span class="n">clean</span> <span class="n">up</span>

<span class="c1">// CPU Time</span>
<span class="mf">0.70</span><span class="nl">ms</span>      <span class="p">:</span> <span class="nl">STW</span>        <span class="p">:</span> <span class="n">Mark</span> <span class="n">Start</span>
<span class="mf">2.5</span><span class="nl">ms</span>       <span class="p">:</span> <span class="nl">Concurrent</span> <span class="p">:</span> <span class="n">Mark</span> <span class="o">-</span> <span class="n">Assist</span> <span class="n">Time</span> <span class="p">(</span><span class="n">GC</span> <span class="n">performed</span> <span class="n">in</span> <span class="n">line</span> <span class="n">with</span> <span class="n">allocation</span><span class="p">)</span>
<span class="mf">1.5</span><span class="nl">ms</span>       <span class="p">:</span> <span class="nl">Concurrent</span> <span class="p">:</span> <span class="n">Mark</span> <span class="o">-</span> <span class="n">Background</span> <span class="n">GC</span> <span class="n">time</span>
<span class="mi">0</span><span class="nl">ms</span>         <span class="p">:</span> <span class="nl">Concurrent</span> <span class="p">:</span> <span class="n">Mark</span> <span class="o">-</span> <span class="n">Idle</span> <span class="n">GC</span> <span class="n">time</span>
<span class="mf">0.99</span><span class="nl">ms</span>      <span class="p">:</span> <span class="nl">STW</span>        <span class="p">:</span> <span class="n">Mark</span> <span class="n">Term</span>

<span class="c1">// Memory</span>
<span class="mi">7</span><span class="nl">MB</span>         <span class="p">:</span> <span class="n">Heap</span> <span class="n">memory</span> <span class="n">in</span><span class="o">-</span><span class="n">use</span> <span class="n">before</span> <span class="n">the</span> <span class="n">Marking</span> <span class="n">started</span>
<span class="mi">11</span><span class="nl">MB</span>        <span class="p">:</span> <span class="n">Heap</span> <span class="n">memory</span> <span class="n">in</span><span class="o">-</span><span class="n">use</span> <span class="n">after</span> <span class="n">the</span> <span class="n">Marking</span> <span class="n">finished</span>
<span class="mi">6</span><span class="nl">MB</span>         <span class="p">:</span> <span class="n">Heap</span> <span class="n">memory</span> <span class="n">marked</span> <span class="n">as</span> <span class="n">live</span> <span class="n">after</span> <span class="n">the</span> <span class="n">Marking</span> <span class="n">finished</span>
<span class="mi">10</span><span class="nl">MB</span>        <span class="p">:</span> <span class="n">Collection</span> <span class="n">goal</span> <span class="k">for</span> <span class="n">heap</span> <span class="n">memory</span> <span class="n">in</span><span class="o">-</span><span class="n">use</span> <span class="n">after</span> <span class="n">Marking</span> <span class="n">finished</span>

<span class="c1">// Threads</span>
<span class="mi">12</span><span class="nl">P</span>         <span class="p">:</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">logical</span> <span class="n">processors</span> <span class="n">or</span> <span class="n">threads</span> <span class="n">used</span> <span class="n">to</span> <span class="n">run</span> <span class="n">Goroutines</span>
</code></pre></div>

<p><a href="https://www.ardanlabs.com/blog/2018/12/garbage-collection-in-go-part1-semantics.html">Garbage Collection In Go : Part I - Semantics</a></p>
<h2 id="cgo">cgo</h2>
<p>编译参数：CFLAGS/CPPFLAGS/CXXFLAGS
链接参数：LDFLAGS</p>
<div class="highlight"><pre><span></span><code><span class="c1">// #cgo CFLAGS: -I/opt/png</span>
<span class="c1">// #cgo LDFLAGS: -L/opt/png -lpng</span>
<span class="c1">// #include &lt;png.h&gt;</span>
<span class="kn">import</span> <span class="s">&quot;C&quot;</span>
</code></pre></div>

<p>目前，当Go需要和C/C++代码集成的时候，大家最先想到的肯定是CGO。毕竟是官方的解决方案，而且简单。</p>
<p>听说 cgo 性能不太好，是真的吗？是的，至少我的经验的结论是 cgo 性能非常差。因为每次进入一个 cgo 调用相当于进入系统调用，这时goroutine会被抢占，从而导致的结果就是可能会很久之后才被重新调度，如果此时我们需要一个密集的 cgo 调用循环，则性能会非常差。</p>
<p>但是CGO是非常慢的。因为CGO其实一个桥接器，通过自动生成代码，CGO在保留了C/C++运行时的情况下，搭建了一个桥来沟通C/C++世界和Go的世界。这就意味着，兼容性很好，但是对C的函数的调用，必须先把当前的goroutine挂起，并切换执行栈到当前的线程M的主栈（大小2MB）。如果不做这个操作，那么只能在goroutine的栈上执行C函数调用，可是，goroutine的栈一般都很小，很容易就导致了栈溢出了。</p>
<p>调用C函数的时候，必须切换当前的栈为线程的主栈，这带来了两个比较严重的问题：</p>
<ol>
<li>线程的栈在Go运行时是比较少的，受到P/M数量的限制，一般可以简单的理解成受到GOMAXPROCS限制；</li>
<li>由于需要同时保留C/C++的运行时，CGO需要在两个运行时和两个ABI（抽象二进制接口）之间做翻译和协调。这就带来了很大的开销。</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kt">long</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">long</span> <span class="n">a</span><span class="p">,</span> <span class="kt">long</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10000000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sum</span> <span class="o">+=</span> <span class="n">Add</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">c</span> <span class="n">used</span> <span class="nl">time</span><span class="p">:</span>    <span class="mi">9</span>   <span class="n">ms</span>     <span class="err">#</span> <span class="o">-</span><span class="n">O2</span> <span class="err">优化</span>
<span class="n">c</span> <span class="n">used</span> <span class="nl">time</span><span class="p">:</span>    <span class="mi">53</span>  <span class="n">ms</span>     <span class="err">#</span> <span class="o">-</span><span class="n">O0</span> <span class="err">优化</span>
<span class="n">go</span> <span class="n">used</span> <span class="nl">time</span><span class="p">:</span>   <span class="mi">11</span>  <span class="n">ms</span>
<span class="n">cgo</span> <span class="n">used</span> <span class="nl">time</span><span class="p">:</span>  <span class="mi">917</span> <span class="n">ms</span>
</code></pre></div>

<p><a href="https://dgraph.io/blog/post/badger/">https://dgraph.io/blog/post/badger/</a> 文章中大量讨论cgo的一些问题，为什么新写一个KV引擎</p>
<h1 id="_58">诊断与分析</h1>
<h2 id="_59">性能分析</h2>
<ol>
<li>设置maxprocs的问题:<a href="https://www.infoq.cn/article/bwfJi86dEx48qFupBqNU">https://www.infoq.cn/article/bwfJi86dEx48qFupBqNU</a> </li>
<li>自动设置： <a href="https://github.com/uber-go/automaxprocs">https://github.com/uber-go/automaxprocs</a> </li>
<li>pprof</li>
<li><a href="https://github.com/pkg/profile">https://github.com/pkg/profile</a></li>
<li><a href="https://dave.cheney.net/practical-go">https://dave.cheney.net/practical-go</a></li>
<li><a href="https://dave.cheney.net/high-performance-go">https://dave.cheney.net/high-performance-go</a></li>
</ol>
<ul>
<li>Benchmarking(基准测试)：专注于一段特定的代码, 允许测量时间 和/或 内存信息。</li>
<li>Profiling(分析)：在程序执行期间(或测试的时候)通过聚合采样收集的数据。分析是没有时间线的(和tracing不一样)。</li>
<li>Tracing(跟踪)：通过程序执行期间(或测试的时候)收集发生的事件数据。跟踪是有时间线的。</li>
</ul>
<h2 id="_60">测试</h2>
<p>单元测试</p>
<p>性能测试</p>
<p>覆盖率</p>
<p>Gofail 故障测试框架</p>
<p>Gomock mock测试框架</p>
<h1 id="_61">高级知识</h1>
<h2 id="_62">泛型</h2>
<p><a href="https://blog.golang.org/generics-next-step">https://blog.golang.org/generics-next-step</a>
示例求任意类型数组的最大值：
<a href="https://go2goplay.golang.org/p/REx6YOpV3pb">https://go2goplay.golang.org/p/REx6YOpV3pb</a></p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="">
        
          <a href="../go_libs/" title="Go标准库" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  上一页
                </span>
                Go标准库
              </div>
            </div>
          </a>
        
        
          <a href="../go_tools/" title="Go 语言工具" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  下一页
                </span>
                Go 语言工具
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z" /></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2016 - 2020 iswade
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.c51dfa35.min.js"></script>
      <script src="../../assets/javascripts/bundle.eaaa3931.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "", "search.config.separator": "[\\uff0c\\u3002]+", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.58d22e8e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>