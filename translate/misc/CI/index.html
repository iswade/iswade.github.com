
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://iswade.github.io/translate/misc/CI/">
      
      <link rel="icon" href="../../../themes/me.svg">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>持续集成系统 - iswade's blog</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../themes/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="iswade&#39;s blog" class="md-header__button md-logo" aria-label="iswade's blog" data-md-component="logo">
      
  <img src="../../../themes/me.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            iswade's blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              持续集成系统
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="iswade&#39;s blog" class="md-nav__button md-logo" aria-label="iswade's blog" data-md-component="logo">
      
  <img src="../../../themes/me.svg" alt="logo">

    </a>
    iswade's blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        主页
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          数据库
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="数据库" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          数据库
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/adb_nodes/00_index/" class="md-nav__link">
        高级数据库笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../articles/buffer/buffer_details/" class="md-nav__link">
        PostgreSQL缓存
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crdb/crdb_paper_cn/" class="md-nav__link">
        CockroachDB翻译
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crdb/crdb_paper/" class="md-nav__link">
        CockroachDB论文
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../taurus_paper_cn/" class="md-nav__link">
        TaurusDB翻译
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../taurus_paper/" class="md-nav__link">
        TaurusDB论文
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../articles/pebble/" class="md-nav__link">
        Pebble KV存储引擎
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../faunadb_transaction/" class="md-nav__link">
        FaunaDB分布式事务协议
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Aurora_design_cloud_native_database/" class="md-nav__link">
        Aurora云原生关系数据库
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../btree_vs_lsmtree/" class="md-nav__link">
        现代存储系统背后的算法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/db_nodes/00_database_systems_2018/" class="md-nav__link">
        数据库笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../F1_query/" class="md-nav__link">
        F1 Query
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          分布式系统
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="分布式系统" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          分布式系统
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../distsys/" class="md-nav__link">
        分布式系统大纲
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../articles/partition/" class="md-nav__link">
        数据分区
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../strong_consistency_models/" class="md-nav__link">
        强一致性模型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zookeeper/" class="md-nav__link">
        Zookeeper论文翻译
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../paxos_made_live/" class="md-nav__link">
        Paxos Made Live翻译
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          编程语言
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="编程语言" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          编程语言
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../articles/go_concurrency/" class="md-nav__link">
        Go并发编程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../go_interface/" class="md-nav__link">
        如何使用Go接口
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          软件工程
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="软件工程" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          软件工程
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/pragmatic_programmer/" class="md-nav__link">
        程序员修炼之道
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/bash_turorial/" class="md-nav__link">
        bash教程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../linux_sysadmin/" class="md-nav__link">
        linux系统管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/git/" class="md-nav__link">
        git入门教程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../to_be_manager/" class="md-nav__link">
        How to be a manager
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    什么是持续集成系统？
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    项目约束和注意项
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    介绍
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    组件
  </a>
  
    <nav class="md-nav" aria-label="组件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#repo_observerpy" class="md-nav__link">
    代码库监视器(repo_observer.py)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    错误处理
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    结论
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="_1">持续集成系统</h1>
<p>作者： Malini Das</p>
<p>翻译： 王世德</p>
<p>Malini Das 是一个软件工程师，她对快速安全的开发和解决交叉功能问题充满兴趣。她在Mozilla是一个工具工程师，现在在Twitch学习。可以通过<a href="https://twitter.com/malinidas">Twitter</a>或者<a href="http://malinidas.com/">博客</a>关注Manlini。</p>
<h2 id="_2">什么是持续集成系统？</h2>
<p>当我们开发软觉得时候，我们想要验证新的特性或者bug修改是安全的符合预期。我们通过运行测试用例验证。有时候，开发者或许没有时间在每个软件运行的系统上测试代码，进一步，当越来越多的代码添加进去的时候，运行用例的时间也会越来越长，有时候即使是局部运行，也是不切实际的。源于此，创建了持续集成系统。</p>
<p>持续集成（CI)系统适用于测试新代码的专用系统，当提交代码到代码仓库的时候，持续集成系统的职责是验证本次提交不会破坏任何用例。为了实现这种效果，系统需要获取新的变更，运行测试用例，然后输出运行结果。与其他任何系统类似， 应该能抵抗失败，这意味着如果系统的任何部分出现故障，应该从那个点恢复然后继续运行。</p>
<p>测试系统应该也可以很好地处理负载，这样我们可以在合理的实际范围内获得测试结果，防止提交比测试用例运行得更快。可以通过分布和并行测试工作来达到这样的效果。这个项目演示一个小规模的，分布式的持续集成系统，这是一个简单的系统，但设计成可以扩展的系统。</p>
<h2 id="_3">项目约束和注意项</h2>
<p>这个项目使用Git作为需要测试的代码库。仅仅标准的源代码管理调用会被使用，所以如果你不熟悉Git但对其它版本控制系统（VCS）如svn或者Mercurial熟悉，仍可以继续阅读下面的内容。</p>
<p>这个项目假设你使用POSIX系统。</p>
<p>因为对代码长度和测试用例用例的限制，简化了测试用例的发现。我们会<em>仅仅</em>运行那些在代码库中命名为<code>tests</code>目录下的测试用例。</p>
<p>持续集成系统监视主仓库，通常会放置在web服务器上，对CI的文件系统而言，并不是本地的。对于我们的例子，会使用本地仓库而不是远程库。</p>
<p>持续集成系统不需要再固定、定期运行。可以对一些提交运行，或者每个提交。对我们的例子而言，CI系统会周期运行，这意味着如果设置没5分钟检查一次变更，它会对5分钟后最近提交的代码运行测试用例。不会测试周期时间内的每次提交的代码，而仅仅是最近的一次。</p>
<p>这个Ci系统被设计成周期检查变更，在实际的CI系统中，我们可以通过仓库监视器来获得通知。例如Github提供了 "post-commit hooks"，可以发送通知给一个URL。根据这个模型，仓库监视器可以由URL所在web服务器调用来响应通知。由于这样对本地建模比较复杂，所以由仓库监视器检查变更而不是被通知的方式。</p>
<p>CI系统还需要报告信息，用例运行程序将结果报告给一个大家都能看到的组件，可能是一个web页面。为了简化，这个项目将促使结果收集起来然后以文件的形式保存在本地文件系统中给分发程序。</p>
<p>注意这个CI系统使用的架构仅仅是很多可能中的一个。选择这个架构是为了将我们的案例学习简化为三个组件。</p>
<h2 id="_4">介绍</h2>
<p>持续集成系统的基本结构是由三个组件构成的：监视器，测试任务分发器和用例运行器。监视器监视仓库的变化。当监视到提交任务时，就会通知任务分发器，任务分发器找到一个用例运行器并且给其一个提交序号用于测试。</p>
<p>有很多思路可用于构建CI系统，我们可以在单个机器的一个进程中实现监视器、分发器和运行器。这种方法非常局限，因为没有负载处理能力，所以如果更多的变更被提交，超过了CI系统的处理能力，积压的任务会增加，并且这种方法也没有容错能力，如果运行的计算机故障或者电源掉电，没有后备系统，会导致所有测试都无法运行，理想的系统是这样的：请求数量与测试任务匹配，当系统宕机时还能尽可能处理任务。</p>
<p>为了构建一个CI系统，有容错能力和负载能力，在这个项目中，每个组件有自己的进程，这样每个进程之间都是相互独立的，可以运行多个实例。当同时有多于一个的测试任务要运行时这种方式很有用。我们可以派生出多个测试运行器并行运行，这样就允许我们运行多个任务，防止在积累很多测试任务。</p>
<p>在这个项目中，不仅这些组件运行在分离的进程中，而且还通过套接字通讯，这样我们就可以在不同的用网络连接的机器上运行。唯一的host/port地址被分配给每个组件，每个进程可以通过分配的地址给其它进程发送消息。</p>
<p>这种设计允许我们以分布式架构处理硬件故障，我们可以将监视器运行在一个机器上，测试任务分发器在另一个上运行，如果其中的一个机器宕机，可以安排拎一个机器启动，这样系统就是故障安全的。</p>
<p>这个项目没有保护任务自动恢复代码，因为这依赖于分布式系统的架构，但在真实情况下，CI系统是运行在分布式环境中，所以需要故障恢复冗余（例如，如果一个进程所在的机器故障了，就可以启动备用的机器）。</p>
<p>为了实现这个项目的目标，每个进程运行在本地，并且需要各自启动，因为进程需要互相通讯，他们运行在不同的本地端口。</p>
<h2 id="_5">组件</h2>
<h3 id="repo_observerpy">代码库监视器(repo_observer.py)</h3>
<p>代码库监视器监视代码块库的变更，当有新的提交时通知分发器。为了适应所有版本控制系统（不是所有的版本控制系统都有内置的通知系统），代码库监视器通过周期性地检查代码块变更的方式检查新的提交，不是使用版本控制系统自身的通知变更系统来实现。</p>
<p>监视器会周期性地轮询代码库，有变更时，会通知分发器新的提交ID，运行测试用例。监视器通过当前的提交ID检出代码，然后更新代码库，最后再获取到最新的提交ID并对比，对这个示例而言，监视器仅仅对最新的提交分发测试。当在一个周期内检查时，有两次代码提交记录，监视器仅仅运行最后一次提交的测试用例。通常情况下，CI系统会检测自最后一次测试后的所有提交代价，然后对每次提交都运行测试，但为了简化修改了这个条件。</p>
<p>监视器必须知道需要监视哪个代码库，我们周期性地创建一个代码库克隆在<code>/path/to/test_repo_clone_obs</code>，监视器会用这个克隆来检测变更，为了让代码监视器使用这个克隆，在调用repo_observer.py文件时，将路径传给它。代码监视器会用这个克隆从主代码库中获取代码。</p>
<p>我们必须将分发器的地址发给监视器，这样监视器就可以发送消息给它，当启动代码库监视器时，我们可以使用<code>--dispatcher-server</code>命令行参数将分发器的地址传递给监视器，如果不传地址，使用默认地址<code>localhost:8888</code>。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">poll</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--dispatcher-server&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;dispatcher host:port, &quot;</span> \
                        <span class="s2">&quot;by default it uses localhost:8888&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;localhost:8888&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;repo&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;REPO&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;path to the repository this will observe&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">dispatcher_host</span><span class="p">,</span> <span class="n">dispatcher_port</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dispatcher_server</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
</code></pre></div>

<p>当当代码库监视器文件被调用时，执行<code>poll()</code>函数，这个函数会解析命令行参数，然后启动无限while循环。while循环被用来周期性地检查代码库的变更，第一件事就是调用<code>update_repo.sh</code>这个bash脚本。<sup id="fnref:bash"><a class="footnote-ref" href="#fn:bash">1</a></sup></p>
<div class="highlight"><pre><span></span><code>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># call the bash script that will update the repo and check</span>
            <span class="c1"># for changes. If there&#39;s a change, it will drop a .commit_id file</span>
            <span class="c1"># with the latest commit in the current working directory</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s2">&quot;./update_repo.sh&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">repo</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Could not update and check repository. &quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;Reason: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
</code></pre></div>

<p><code>update_repo.sh</code>文件用来确定新的提交，然后通知监视器，当观察到新的提交时，会将提交ID发送，然后就可以更新代码库，并检查最新的提交ID，如果匹配，没有新的代码变更，监视器不需要做任何事情，但如果提交ID不一样，我们会知道有新的提交发生，这种情况下，<code>update_repo.sh</code>会创建一个称之为.commit_id的文件，并将最新的提交ID存储在里面。</p>
<p><code>udpate_repo.sh</code>一步步的分解如下所示，首先，脚本<code>source</code>文件<code>run_or_fail.sh</code>，这个文件提供了<code>run_or_fail</code>方法，这个方法用来运行给定的命令，或者失败后输出给定的错误信息。</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="nb">source</span> run_or_fail.sh 
</code></pre></div>

<p>接下来，脚本尝试移除名称为<code>.commit_id</code>的文件，应为<code>update_repo.sh</code>被<code>repo_observer.py</code>无限调用，如果前面有新的提交，<code>.commit_id</code>被创建，但会保存已经运行了测试的提交，因此，移除文件，有新的提交时创建一个新的文件。</p>
<div class="highlight"><pre><span></span><code>bash rm -f .commit_id 
</code></pre></div>

<p>移除了文件之后，会检查代码库，然后将其重置为最新的提交，防止出现不同步的情况。</p>
<div class="highlight"><pre><span></span><code>run_or_fail <span class="s2">&quot;Repository folder not found!&quot;</span> <span class="nb">pushd</span> <span class="nv">$1</span> <span class="m">1</span>&gt; /dev/null
run_or_fail <span class="s2">&quot;Could not reset git&quot;</span> git reset --hard HEAD
</code></pre></div>

<p>然后，调用git log并解析输出内容，然后获取到最新的</p>
<h2 id="_6">错误处理</h2>
<h2 id="_7">结论</h2>
<div class="footnote">
<hr />
<ol>
<li id="fn:bash">
<p>Bash被用来检查文件是否存在，创建文件使用Git，shell脚本是最直接最容易的方式来实现这个功能。另外，有多平台的python库可以使用，如python的内置<code>os</code>库，可以用来访问文件系统，GitPython可以用于访问Git，当这样实现比较繁复。&#160;<a class="footnote-backref" href="#fnref:bash" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2016 - 2021 iswade
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\s\\-\uff0c\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>