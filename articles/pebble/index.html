
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://iswade.github.io/articles/pebble/">
      
      <link rel="icon" href="../../themes/me.svg">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>Pebble KV存储引擎 - iswade's blog</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../themes/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pebble" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="iswade&#39;s blog" class="md-header__button md-logo" aria-label="iswade's blog" data-md-component="logo">
      
  <img src="../../themes/me.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            iswade's blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Pebble KV存储引擎
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="iswade&#39;s blog" class="md-nav__button md-logo" aria-label="iswade's blog" data-md-component="logo">
      
  <img src="../../themes/me.svg" alt="logo">

    </a>
    iswade's blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        主页
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          数据库
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="数据库" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          数据库
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/adb_nodes/00_index/" class="md-nav__link">
        高级数据库笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../buffer/buffer_details/" class="md-nav__link">
        PostgreSQL缓存
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/crdb/crdb_paper_cn/" class="md-nav__link">
        CockroachDB翻译
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/crdb/crdb_paper/" class="md-nav__link">
        CockroachDB论文
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/taurus_paper_cn/" class="md-nav__link">
        TaurusDB翻译
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/taurus_paper/" class="md-nav__link">
        TaurusDB论文
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Pebble KV存储引擎
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Pebble KV存储引擎
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-pebble" class="md-nav__link">
    1. Pebble详解：入门介绍
  </a>
  
    <nav class="md-nav" aria-label="1. Pebble详解：入门介绍">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lsm" class="md-nav__link">
    LSM树
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    整体架构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    安装使用
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    磁盘文件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    代码目录
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pebble_1" class="md-nav__link">
    Pebble详解：读写
  </a>
  
    <nav class="md-nav" aria-label="Pebble详解：读写">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    写入
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    读取
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pebble_2" class="md-nav__link">
    Pebble详解：内存表
  </a>
  
    <nav class="md-nav" aria-label="Pebble详解：内存表">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    跳跃表
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    插入
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    无锁
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    查找
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pebblesst" class="md-nav__link">
    Pebble详解：SST
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pebble_3" class="md-nav__link">
    Pebble详解：预写日志
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pebble_4" class="md-nav__link">
    Pebble详解：压缩合并
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pebble_5" class="md-nav__link">
    Pebble详解：缓存
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pebblemanifest" class="md-nav__link">
    Pebble详解：Manifest
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pebblebloom" class="md-nav__link">
    Pebble详解：Bloom
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pebble_6" class="md-nav__link">
    Pebble详解：其它
  </a>
  
    <nav class="md-nav" aria-label="Pebble详解：其它">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    为什么不支持事务？
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    提交管道
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    测试
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pebble-scan" class="md-nav__link">
    pebble-scan
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    参考
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/faunadb_transaction/" class="md-nav__link">
        FaunaDB分布式事务协议
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/Aurora_design_cloud_native_database/" class="md-nav__link">
        Aurora云原生关系数据库
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/btree_vs_lsmtree/" class="md-nav__link">
        现代存储系统背后的算法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/db_nodes/00_database_systems_2018/" class="md-nav__link">
        数据库笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/F1_query/" class="md-nav__link">
        F1 Query
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          分布式
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="分布式" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          分布式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/distsys/" class="md-nav__link">
        分布式系统大纲
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../partition/" class="md-nav__link">
        数据分区
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/strong_consistency_models/" class="md-nav__link">
        强一致性模型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/zookeeper/" class="md-nav__link">
        Zookeeper论文翻译
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/paxos_made_live/" class="md-nav__link">
        Paxos Made Live翻译
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          编程语言
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="编程语言" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          编程语言
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../go_concurrency/" class="md-nav__link">
        Go并发编程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/go_interface/" class="md-nav__link">
        如何使用Go接口
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          软件工程
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="软件工程" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          软件工程
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/pragmatic_programmer/" class="md-nav__link">
        程序员修炼之道
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/bash_turorial/" class="md-nav__link">
        bash教程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/linux_sysadmin/" class="md-nav__link">
        linux系统管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/git/" class="md-nav__link">
        git入门教程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../translate/to_be_manager/" class="md-nav__link">
        How to be a manager
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-pebble" class="md-nav__link">
    1. Pebble详解：入门介绍
  </a>
  
    <nav class="md-nav" aria-label="1. Pebble详解：入门介绍">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lsm" class="md-nav__link">
    LSM树
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    整体架构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    安装使用
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    磁盘文件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    代码目录
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pebble_1" class="md-nav__link">
    Pebble详解：读写
  </a>
  
    <nav class="md-nav" aria-label="Pebble详解：读写">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    写入
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    读取
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pebble_2" class="md-nav__link">
    Pebble详解：内存表
  </a>
  
    <nav class="md-nav" aria-label="Pebble详解：内存表">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    跳跃表
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    插入
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    无锁
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    查找
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pebblesst" class="md-nav__link">
    Pebble详解：SST
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pebble_3" class="md-nav__link">
    Pebble详解：预写日志
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pebble_4" class="md-nav__link">
    Pebble详解：压缩合并
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pebble_5" class="md-nav__link">
    Pebble详解：缓存
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pebblemanifest" class="md-nav__link">
    Pebble详解：Manifest
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pebblebloom" class="md-nav__link">
    Pebble详解：Bloom
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pebble_6" class="md-nav__link">
    Pebble详解：其它
  </a>
  
    <nav class="md-nav" aria-label="Pebble详解：其它">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    为什么不支持事务？
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    提交管道
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    测试
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pebble-scan" class="md-nav__link">
    pebble-scan
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    参考
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="pebble">Pebble</h1>
<h2 id="1-pebble">1. Pebble详解：入门介绍</h2>
<p>Pebble是一个使用Go语言开发的KV单机存储引擎。底层数据模型是LSM树，与LSM树方式实现的其它存储引擎如LevelDB，RocksDB等有类似的特性，是一个不可变的磁盘写优化数据结构，它适用于写入比查找更频繁的系统。</p>
<p>Pebble基于goLevelDB开发，扩展了RocksDB的一些功能，但是并没有完全支持RocksDB的所有功能。其主要目的是替换CockroachDB数据库的存储引擎，目前已经作为其默认存储引擎。</p>
<h3 id="lsm">LSM树</h3>
<p>日志结构合并树（或LSM树）， 是一种分层、有序、面向磁盘的数据组织方式，其核心思想是充分了利用了磁盘顺序写比随机写性能高的特点。</p>
<p><img src="./image_pebble/lsmtree.png" alt="" style="zoom:80%;" /></p>
<p>LSM树消除了随机插入、更新和删除，LSM树在内存中写入和更新，直到其大小达到阈值，然后再写出到磁盘。查询数据时需要查找内存部分，如果内存中存在待查找的key则返回，如果不存在，则需要从磁盘文件中查找。虽然LSM树的写入简单高效，但是很明显的缺点是对读取操作，特别是随机读并不友好，对于读取操作，通常需要进行缓存、索引、磁盘文件组织方面的优化。LSM树适合写多读少的场景。</p>
<p>传统关系型数据库通常底层使用的是B+树，B+树和LSM树有什么异同呢？让我们比较一下B+树和LSM树的特性。</p>
<p>LSM树具有以下特性：</p>
<ul>
<li>Append-Only，SST只写在磁盘上一次，从不更新。</li>
<li>读取可能需要从多个SST读取数据，同一个key可能会落在不同的数据文件中，返回给客户端之前，数据必须经过合并。</li>
<li>因为写入和删除都被顺序写入到磁盘中，通常需要压缩操作来合并数据记录和垃圾收集。</li>
<li>写<span><span class="MathJax_Preview">O(1)</span><script type="math/tex">O(1)</script></span>，读取<span><span class="MathJax_Preview">O(N)</span><script type="math/tex">O(N)</script></span>，经过索引和缓存优化后可以达到<span><span class="MathJax_Preview">O(logN)</span><script type="math/tex">O(logN)</script></span> 。</li>
</ul>
<p>B+树具有以下特性：</p>
<ul>
<li>就地更新和删除。更新操作可能会触发节点分裂和合并，随机读写概率会变大。</li>
<li>是经过读取优化的，这意味着不需要从多个文件读取，读取效率较高。</li>
<li>并发访问需要读写隔离，涉及lock和latch。</li>
<li>更新导致的碎片化可能需要额外的维护和块重写。与LSM树存储相比，B树通常需要较少的维护操作。</li>
<li>写<span><span class="MathJax_Preview">O(logN)</span><script type="math/tex">O(logN)</script></span>，读取<span><span class="MathJax_Preview">O(logN)</span><script type="math/tex">O(logN)</script></span> 。</li>
</ul>
<p>从上面的对比可以看出，LSM树对写入友好，但是对读取并不友好，并且频繁触发压缩合并会消耗较多的资源，针对压缩合并也需要大量优化避免对业务造成影响，有些数据库如阿里Polar X-Engine，将压缩卸载到FPGA，以加速压缩来消减CPU瓶颈，避免对计算资源的侵占。</p>
<h3 id="_1">整体架构</h3>
<p>整体架构如下图所示：</p>
<p><img alt="" src="../image_pebble/architecture.png" /></p>
<p>在Pebble中三个主要的结构是：内存表（memtable）、SST（sstable） 以及预写日志（WAL）。内存表是内存中的结构，新的写入被插入内存表中，并且被写入到预写日志中，预写日志是在存储系统上的顺序写入文件，用于保证数据库系统中的持久性和完整性。在SST中的数据是排好序的，以方便查找。读取必须先查找内存表，再查询SST文件。一旦内存表达到阈值，就会被修改为不可变的，并创建一个新的内存表用于后续的写入。后台线程将内存表的内容刷新到SST文件，之后可以销毁内存表，然后预写日志就可以被安全地删除了。</p>
<h3 id="_2">安装使用</h3>
<div class="highlight"><pre><span></span><code>go get -d github.com/cockroachdb/pebble
</code></pre></div>

<p>Pebble以库的方式提供，提供了一个简单的命令用于测试，在 <code>cmd/pebble/</code> 目录下。如果希望使用所有接口，可以使用单元测试目录下的测试文件进行调试研究具体接口的使用方式。</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> <span class="nv">$GOPATH</span>/src/github.com/cockroachdb/pebble/cmd/pebble/
go build
./pebble bench sync ./data/ -d 60s
</code></pre></div>

<p>进入<code>./data</code> 目录，即可看到磁盘上相关的数据库文件。</p>
<p>当前版本依赖cgo，cgo依赖gcc。windows上编译时，可以安装mingw64。</p>
<h3 id="_3">磁盘文件</h3>
<p>pebble数据库的磁盘目录组织结构如下所示，后面会详细介绍具体的内容。</p>
<div class="highlight"><pre><span></span><code>000017.sst              // SST
000018.log              // 预写日志文件 
CURRENT                 // 记录当前的MANIFEST
LOCK                    // 锁文件，避免多个进程同时访问这个目录
MANIFEST-000011         // 元数据，SST的层级信息等，合并过程添加新文件并从数据库中删除现有文件
                        // 并通过将它们记录在MANIFEST文件中使这些操作持久化。
OPTIONS-000012          // 配置参数
</code></pre></div>

<h3 id="_4">代码目录</h3>
<p>pebble主要模块和文件如下所示：</p>
<div class="highlight"><pre><span></span><code>├── bloom              // 查询时用到的布隆过滤器
├── cmd                // 可执行文件，当前可以用于测试 scan/sync/ycsb 等
├── docs               // 文档
├── sstable            // sstable 模块实现
├── tool               // 用于解析 lsm/sstable/manifest 的工具集
├── vfs                // 虚拟文件系统，用于适配不同平台的文件操作接口
├── batch.go           // 用于支持原子Set/Merge/Delete/DeleteRange的批量操作
├── cache.go           // 用于支持可配置大小的缓存，实际调用内部Cache模块
├── checkpoint.go      // Checkpoint在指定目录中构造数据库实例的快照(磁盘文件)
├── commit.go          // 操作提交，支持pipeline
├── compaction.go      // compaction 相关的逻辑
├── db.go              // DB结构，相关方法实现
├── event.go           // 事件监听模块
├── get_iter.go        // 查询get接口的迭代器，内部使用
├── go.mod             // go module文件
├── ingest.go          // 将指定路径中的所有sstable摄取到当前数据库中
├── iterator.go        // 迭代器在kv对上进行遍历
├── mem_table.go       // memTable实现了LSM在内存中的层
├── merging_iter.go    // 提供LSM不同层多个迭代器的合并视图 
├── metrics.go         // 统计信息
├── open.go            // DB open入口，及相关方法
├── options.go         // 配置选项，各层配置参数
├── snapshot.go        // 快照相关操作，快照是某个时间段的只读视图
├── version_set.go     // 版本集管理不可变多个版本，管理新版本的创建
├── internal           // 内部模块
    ├── ackseq         
    ├── arenaskl       // 跳表，无锁
    ├── base
    ├── batchskl
    ├── bytealloc
    ├── cache          // 基于CLOCK-Pro算法的缓存实现
    ├── crc 
    ├── datadriven
    ├── humanize
    ├── intern
    ├── invariants
    ├── lint
    ├── manifest
    ├── manual
    ├── metamorphic
    ├── pacertoy
    ├── private
    ├── randvar
    ├── rangedel
    ├── rate           // 流控模块
    ├── rawalloc
    └── record
</code></pre></div>

<h2 id="pebble_1">Pebble详解：读写</h2>
<p>Pebble中的写操作首先写日志文件，然后再去写内存中的内存表，写日志是为了保证数据的持久性，一旦宕机，内存表中的数据还没有持久化，系统启动时可以从日志文件中读取，进行数据恢复。</p>
<p>Pebble 只允许一个进程打开。操作系统将使用文件锁定来防止多个进程的并发访问。在一个进程中，Pebble 可以由多个线程访问，如果多个线程打开同一个数据库，它将仅允许第一个写线程写入数据库，而其他写线程将被阻塞。对于读写冲突，读取可以从与写入分开的不可变数据中检索数据，更新的版本将在压缩过程中生效。 </p>
<h3 id="_5">写入</h3>
<p>我们总结下在在LSM-Tree里面如何写数据的？</p>
<ol>
<li>
<p>当收到一个写请求时，会先把该条数据记录在WAL Log里面，用作故障恢复。</p>
</li>
<li>
<p>当写完WAL Log后，会把该条数据写入内存的SSTable里面（删除是通过记录删除标记完成，更新是新生成一条数据），也称memtable。为了维持有序性在内存里面采用跳跃表相关的数据结构。</p>
</li>
<li>
<p>当Memtable超过一定的大小后，会在内存里面冻结，变成不可变的memtable，同时为了不阻塞写操作需要生成一个新的memtable继续提供服务。</p>
</li>
<li>
<p>把内存中不可变的memtable给dump到到硬盘上的SSTable层中，此步骤也称为Minor Compaction，这里需要注意在L0层的SSTable是没有进行合并的，所以这里的key range在多个SSTable中可能会出现重叠，在层数大于0层之后的SSTable，不存在重叠key。</p>
</li>
<li>
<p>当磁盘上每层的的SSTable超过一定的大小或者个数，也会周期性进行合并。此步骤也称为Major Compaction，这个阶段会真正清除掉被标记删除掉的数据以及多版本数据的合并，避免浪费空间，注意由于SSTable都是有序的，我们可以直接采用归并排序进行高效合并。</p>
</li>
</ol>
<h3 id="_6">读取</h3>
<p>1，当收到一个读请求的时候，会直接先在内存里面查询，如果查询到就返回。</p>
<p>2，如果没有查询到就会依次下沉，知道把所有的Level层查询一遍得到最终结果。</p>
<p>思考查询步骤，我们会发现如果SSTable的分层越多，那么最坏的情况下要把所有的分层扫描一遍，对于这种情况肯定是需要优化的，如何优化？在 Bigtable 论文中提出了几种方式：</p>
<h2 id="pebble_2">Pebble详解：内存表</h2>
<p>内存表（memtable）的写出到磁盘的流程的调用栈如下所示（调试时，可以将MemTableSize大小设置为 4MB，在函数<code>func (m *memTable) unref()</code>中 v == 0的分支设置断点，然后调试跟踪写出流程）：</p>
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nx">runCompaction</span>  <span class="c1">// 新建文件，然后将 memtable 内容写出到磁盘</span>
<span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nx">compact1</span><span class="p">()</span>
<span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nx">compact</span><span class="p">()</span>
<span class="k">go</span> <span class="nx">d</span><span class="p">.</span><span class="nx">compact</span><span class="p">()</span>

<span class="nx">pebble</span><span class="p">.(</span><span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nx">maybeScheduleFlush</span>
<span class="nx">pebble</span><span class="p">.(</span><span class="o">*</span><span class="nx">memTable</span><span class="p">).</span><span class="nx">unref</span>
<span class="nx">pebble</span><span class="p">.(</span><span class="o">*</span><span class="nx">DB</span><span class="p">).</span><span class="nx">makeRoomForWrite</span>
<span class="nx">pebble</span><span class="p">.(</span><span class="o">*</span><span class="nx">DB</span><span class="p">).</span><span class="nx">commitWrite</span>
<span class="nx">pebble</span><span class="p">.(</span><span class="o">*</span><span class="nx">DB</span><span class="p">).</span><span class="nx">commitWrite</span><span class="o">-</span><span class="nx">fm</span>
<span class="nx">pebble</span><span class="p">.(</span><span class="o">*</span><span class="nx">commitPipeline</span><span class="p">).</span><span class="nx">prepare</span>
<span class="nx">pebble</span><span class="p">.(</span><span class="o">*</span><span class="nx">commitPipeline</span><span class="p">).</span><span class="nx">Commit</span>
<span class="nx">pebble</span><span class="p">.(</span><span class="o">*</span><span class="nx">DB</span><span class="p">).</span><span class="nx">Apply</span>
<span class="nx">pebble</span><span class="p">.(</span><span class="o">*</span><span class="nx">Batch</span><span class="p">).</span><span class="nx">Commit</span>
</code></pre></div>

<h3 id="_7">跳跃表</h3>
<p>内存表的默认实现是跳跃表。跳跃表是一个有序集合，当工作负载既有范围扫描，又有写入操作时，这是一个必要的结构。简而言之，跳跃表是一种类似链表的结构，同时允许快速查找。</p>
<div class="highlight"><pre><span></span><code>  | 2 |  |  -------------------------------------&gt;  |
L |   |  |  &lt;-------------------------------------  |
E |   |  |                                          | 
V | 1 |  |  ---------&gt; |  ---------&gt; |  ---------&gt;  |
E |   |  |  &lt;--------- |  &lt;--------- |  &lt;---------  |
L |   |  |             |             |              | 
S | 0 |  |  --&gt; |  --&gt; |  --&gt; |  --&gt; |  --&gt; |  --&gt; NIL
  |   |  30 &lt;-- 40 &lt;-- 50 &lt;-- 60 &lt;-- 70 &lt;-- 90 &lt;-- NIL
</code></pre></div>

<p>如上图所示，跳跃表基于层构建。最底层是一个普通的有序链表，高层是底层的快车道。</p>
<p>pebble当前使用的一个跳跃表实现所在路径：<code>pebble/internal/arenaskl</code>。是一个高速、无锁、基于区域的跳跃表，用Go实现。支持双向遍历：</p>
<ul>
<li>高性能：可以随着核数量增加而线性扩展，通过从固定大小的区域分配内存，避免锁来实现。</li>
<li>可以在堆栈上分配并且可以值克隆的迭代器。</li>
<li>简单易用且低开销的模型，用于检测和处理其他线程的竞争条件。</li>
<li>支持反向遍历（例如：向前的链接）</li>
</ul>
<p>其主要优势来自于专用性，无法提供通用跳跃表的实现：</p>
<ul>
<li>区域的大小设置了跳跃表节点，键和值的组合大小的上限。 此限制包括已删除节点，键和值的大小。</li>
<li>不支持删除。相反，更高级别的代码会添加kv值和删除类型的新条目，并需要适当地处理这些条目的删除。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// 跳跃表的节点信息</span>
<span class="kd">type</span> <span class="nx">node</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// 不可变字段，所以不需要对其加锁访问</span>
    <span class="nx">keyOffset</span> <span class="kt">uint32</span>
    <span class="nx">keySize</span>   <span class="kt">uint32</span>
    <span class="nx">valueSize</span> <span class="kt">int32</span>

    <span class="c1">// 每个节点都有 maxHeight 高度个链表，用于指向每层的下一个或者上一个节点，用于加速查找</span>
    <span class="c1">// 大部分节点不需要塔的全部高度，因为每个连续层的概率指数下降。</span>
    <span class="c1">// 因为这些元素永远不会被访问，不需要被分配。</span>
    <span class="c1">// 因此，当在区域中分配节点时，其内存占用被截断，不包括不需要的塔元素。</span>
    <span class="c1">// 所有元素的访问都应该使用 CAS 操作，而不需要锁定。</span>
    <span class="nx">tower</span> <span class="p">[</span><span class="nx">maxHeight</span><span class="p">]</span><span class="nx">links</span>
<span class="p">}</span>

<span class="c1">// 链接信息</span>
<span class="kd">type</span> <span class="nx">links</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">nextOffset</span> <span class="kt">uint32</span>
    <span class="nx">prevOffset</span> <span class="kt">uint32</span>
<span class="p">}</span>

<span class="c1">// 跳跃表是一个快速，并发的实现支持向前，向后遍历。</span>
<span class="c1">// 键值一旦被加入到跳跃表中，就是不可变的，不支持删除。</span>
<span class="kd">type</span> <span class="nx">Skiplist</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">arena</span>  <span class="o">*</span><span class="nx">Arena</span>
    <span class="nx">cmp</span>    <span class="nx">db</span><span class="p">.</span><span class="nx">Compare</span>
    <span class="nx">head</span>   <span class="o">*</span><span class="nx">node</span>
    <span class="nx">tail</span>   <span class="o">*</span><span class="nx">node</span>
    <span class="nx">height</span> <span class="kt">uint32</span> <span class="c1">// 当前高度 1 &lt;= height &lt;= maxHeight. CAS.</span>
<span class="p">}</span>
</code></pre></div>

<p>值得注意的是，节点分配内存，前后指针等，都是在固定区域的内存中分配，指针都是通过偏移来实现。</p>
<h3 id="_8">插入</h3>
<ol>
<li>随机选择一个新插入节点的高度：h层的概率：<span><span class="MathJax_Preview">rand\_uint64()  &lt; max\_uint32 * 1.0/e^{h-1}</span><script type="math/tex">rand\_uint64()  < max\_uint32 * 1.0/e^{h-1}</script></span>，层数越高，概率约小，指数下降。</li>
<li>找出每层需要插入的位置，第0层到第h层的位置都找到需要找到。</li>
<li>然后生成新的节点，根据已经找到的插入位置，修改新节点中每层的前后指针，指向正确的位置。</li>
<li>然后通过无锁方法，将每层的链表中的前后指针指向新节点。处理完成。</li>
</ol>
<h3 id="_9">无锁</h3>
<p>从第0层到第h层，每一层通过双向链表的无锁CAS实现：</p>
<div class="highlight"><pre><span></span><code>+----------------+     +------------+     +----------------+
|      prev      |     |     nd     |     |      next      |
| prevNextOffset |----&gt;|            |     |                |
|                |&lt;----| prevOffset |     |                |
|                |     | nextOffset |----&gt;|                |
|                |     |            |&lt;----| nextPrevOffset |
+----------------+     +------------+     +----------------+
1. 初始化 prevOffset 和 nextOffset 指向 prev 和 next.
2. 通过 CAS 操作将 prevNextOffset 从 next 重新指向 nd.
3. 通过 CAS 操作将 nextPrevOffset 从 prev 重新指向 nd.
</code></pre></div>

<p>检查next是否有了一个更新后的连接指向prev。如果没有，意味着下面的两种情况：</p>
<ol>
<li>加入next的线程还米有计划添加prev链接（但是很短的时间之后会添加）</li>
<li>另一个线程已经在prev和next之间加了一个新连接</li>
</ol>
<p>操作过程出现冲突的情况，需要重新定位插入位置，前后指针信息，然后再次插入，如果有一个新的相同key插入了，则报错已存在，然后退出。</p>
<p>详细参考：文件 skl.go 的函数 addInternal 。</p>
<h3 id="_10">查找</h3>
<p>当前的arenaskl实现，通过迭代器的方式提供：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// memTable的get方法用于查找对应的key</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">memTable</span><span class="p">)</span> <span class="nx">get</span><span class="p">(</span><span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">value</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">it</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">skl</span><span class="p">.</span><span class="nx">NewIter</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="nx">ikey</span><span class="p">,</span> <span class="nx">val</span> <span class="o">:=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">SeekGE</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">ikey</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">db</span><span class="p">.</span><span class="nx">ErrNotFound</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">val</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// 迭代器</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Skiplist</span><span class="p">)</span> <span class="nx">NewIter</span><span class="p">(</span><span class="nx">lower</span><span class="p">,</span> <span class="nx">upper</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="o">*</span><span class="nx">Iterator</span> 

<span class="c1">// 大于或者等于查找key的kv值</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">it</span> <span class="o">*</span><span class="nx">Iterator</span><span class="p">)</span> <span class="nx">SeekGE</span><span class="p">(</span><span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">db</span><span class="p">.</span><span class="nx">InternalKey</span><span class="p">,</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> 
</code></pre></div>

<p>查找算法：</p>
<ol>
<li>从跳跃表的最大高度开始，对每层进行查找</li>
<li>如果找到，判断是否层数为0</li>
<li>如果层数为0，则查找结束</li>
<li>如果层数不为0，则找到第0层对应节点的prev节点，结束</li>
</ol>
<p>参考：</p>
<ol>
<li><a href="http://ticki.github.io/blog/skip-lists-done-right/">http://ticki.github.io/blog/skip-lists-done-right/</a></li>
<li>Redis的有序集合也通过skiplist实现</li>
<li>RocksDB默认memtable使用skiplist实现</li>
<li><a href="https://homepage.cs.uiowa.edu/~ghosh/skip.pdf">https://homepage.cs.uiowa.edu/~ghosh/skip.pdf</a></li>
<li><a href="https://en.wikipedia.org/wiki/Skip_list">https://en.wikipedia.org/wiki/Skip_list</a></li>
</ol>
<h2 id="pebblesst">Pebble详解：SST</h2>
<h2 id="pebble_3">Pebble详解：预写日志</h2>
<p>WAL 相关的内容在 <code>pebble/internal/record</code> 目录中。</p>
<p>WAL 日志写出流程：</p>
<ol>
<li>在提交写入时(commitWrite)，将 wal日志写到队列中</li>
<li>在一个 goroutine 中循环flushLoop接受数据，然后刷新到磁盘中</li>
</ol>
<h2 id="pebble_4">Pebble详解：压缩合并</h2>
<p>SSTable 是可以启用压缩功能的，并且这种压缩不是将整个 SSTable 一起压缩，而是根据 locality 将数据分组，每个组分别压缩，这样的好处当读取数据的时候，我们不需要解压缩整个文件而是解压缩部分组就可以读取。</p>
<p>这个在前面的写入流程中已经介绍过，通过定期合并瘦身， 可以有效的清除无效数据，缩短读取路径，提高磁盘利用空间。但Compaction操作是非常消耗CPU和磁盘IO的，尤其是在业务高峰期，如果发生了Major Compaction，则会降低整个系统的吞吐量，这也是一些NoSQL数据库，比如Hbase里面常常会禁用Major Compaction，并在凌晨业务低峰期进行合并的原因。</p>
<h2 id="pebble_5">Pebble详解：缓存</h2>
<p>因为SSTable在写入磁盘后，除了Compaction之外，是不会变化的，所以我可以将Scan的Block进行缓存，从而提高检索的效率</p>
<h2 id="pebblemanifest">Pebble详解：Manifest</h2>
<h2 id="pebblebloom">Pebble详解：Bloom</h2>
<p>索引。正常情况下，一个读操作是需要读取所有的 SSTable 将结果合并后返回的，但是对于某些 key 而言，有些 SSTable 是根本不包含对应数据的，因此，我们可以对每一个 SSTable 添加 Bloom Filter，因为布隆过滤器在判断一个SSTable不存在某个key的时候，那么就一定不会存在，利用这个特性可以减少不必要的磁盘扫描。</p>
<h2 id="pebble_6">Pebble详解：其它</h2>
<p>并发控制/MVCC/数据恢复</p>
<p>snapshot/checkpoint/commit_pipeline/backup/Recovery/GC/ingest/</p>
<ul>
<li>Delete</li>
<li>Batch: Get/Set/Delete/Commit/Apply</li>
<li>Flush: Flush the memtable to stable storage</li>
<li>Metrics</li>
<li>NewIter</li>
<li>NewSnapshot</li>
</ul>
<h3 id="_11">为什么不支持事务？</h3>
<p>没有冒犯。这是一个有意思的问题：您如何在非事务基础上构建事务？显然可以做到。文件系统不是事务性的，但是事务性数据库经常建立在文件系统之上。关键是寻找要建立的基础属性。对于文件系统，基本属性是fsync提供的持久性。对于Pebble/RocksDB，属性是<strong>Batch原语提供的原子性和持久性</strong>。</p>
<p>请注意，尽管RocksDB具有“事务”，但CockroachDB并未使用它们。可以在非分布式RocksDB事务的基础上构建分布式事务，但这不是必需的。而是如上所述，CockroachDB依赖于批处理的原子性和持久性，并结合了<strong>许多自定义算法来实现复制和分布式事务</strong>。</p>
<p>在Pebble/RocksDB层提供事务有不利之处吗？是。<strong>完整的事务意味着一致性和隔离性。提供一致性和隔离的机制可能很复杂，并且会导致大量开销</strong>。例如，“一致性和隔离”机制可能必须提供锁机制，锁机制意味着必须处理死锁等问题。这些单节点事务机制可能无法满足CockroachDB提供的分布式事务的需求。</p>
<p><a href="https://github.com/cockroachdb/pebble/issues/581">https://github.com/cockroachdb/pebble/issues/581</a></p>
<h3 id="_12">提交管道</h3>
<p>提交管道用于管理一系列原子提交变更（在单批中包含）到DB的阶段。主要包括</p>
<ol>
<li>将批写入到WAL，并且可选是否将WAL刷新到磁盘。</li>
<li>将变更应用到memtable。</li>
</ol>
<p>这两个步骤在期望高性能的场景下变得很复杂。在没有并发的情况下，性能被限制为一批数据写入（刷新）到WAL以及添加到memtable中的速度，这两个点都在提交管道的范围之外。提交管道主要关注并发场景的性能，同时还要维护下面的两个不变性：</p>
<ol>
<li>所有batch需要以序列号的顺序写出到WAL。</li>
<li>所有batch需要以序列号的顺序对读操作可见。这种不变性源于使用单个序列号来指示哪些变更是可见的。</li>
</ol>
<p>考虑这两种不变性，让我们重新考虑提交管道需要做的工作。将批量操作以串行化的方式写入WAL是必须的，因为只有一个WAL对象。注意，写WAL非常快，通常都是内存拷贝。将批量变更应用到内存表可以并发处理，因为底层跳跃表支持并发插入。发布可见序列是另一个串行化点，但是有一个变化：可见序列号不能被碰撞，直到早期批次的变更已经完成应用于内存表（可见序列号只是棘轮）。
最后，如果发出请求，则提交等待WAL同步。
请注意，在棘轮显示可见序列号后等待WAL同步，允许另一个goroutine在WAL同步之前读取已提交的数据。这与RocksDB的手动WAL刷新功能类似。
如有必要，应用程序代码需要对此进行保护。</p>
<p>提交管道操作的完整操作如下：</p>
<div class="highlight"><pre><span></span><code>加锁：
    分配批操作序列号
    将批写到WAL
将批刷新到WAL同步列表中（可选）
将批操作应用到memtable中（并发地）
等待更早的批应用完成
棘轮读序列号
等待WAL刷新（可选）
</code></pre></div>

<p>一旦批处理被写入WAL，就会释放提交管道的互斥锁，允许另一个批处理写入WAL。
每个提交操作单独将其批处理应用于提供并发的内存表。 WAL同步与应用内存表同时发生（请参阅commitPipeline.syncLoop）。</p>
<p>“等待早期批次应用”的工作比预期要复杂得多。显而易见的方法是保留待处理批次的队列，并为每个批次等待上一批次完成提交。
这种方法最初尝试过，结果太慢了。
问题在于它会导致过多的Go例程活动，因为每个提交的Go例程都需要唤醒，以便下一个Go例程被解除阻塞。当前代码中采用的方法在概念上是相似的，但它避免唤醒Go例程来执行另一个Go例程可以执行的工作。 
commitQueue（单生产者，多消费者队列）包含提交批次的有序列表。
在保存commitPipeline.mutex的同时完成对队列的添加，确保队列中批次的顺序与WAL中的排序相同。
当批处理完成对内存表的应用时，它会自动更新其Batch.applied字段。
通过commitPipeline.publish完成可见序列号的棘轮操作，该循环使“应用”批次出队列并使棘轮显示可见序列号。
如果我们在队列的头部遇到未应用的批处理，我们可以阻塞，因为我们知道提交该未应用的批处理最终将在队列中找到我们的（应用的）批。
请参阅commitPipeline.publish以获取其他评论。</p>
<h3 id="_13">测试</h3>
<p>如何细粒度分析Pebble的瓶颈？考虑CPU(cache miss)、内存、磁盘IO、线程切换、锁竞争等瓶颈？</p>
<p>单元测试：</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> <span class="nv">$GOPATH</span>/src/github.com/cockroachdb/pebble/
go <span class="nb">test</span>
</code></pre></div>

<p>性能测试：</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> <span class="nv">$GOPATH</span>/src/github.com/cockroachdb/pebble/cmd/pebble/
./pebble bench scan ./scan_data/
./pebble bench ycsb ./ycsb_data/
</code></pre></div>

<table>
<thead>
<tr>
<th>ycsb</th>
<th>read_95</th>
<th>update_5</th>
</tr>
</thead>
<tbody>
<tr>
<td>1-threads</td>
<td>1702</td>
<td>91</td>
</tr>
<tr>
<td>8-threads</td>
<td>8017</td>
<td>418</td>
</tr>
<tr>
<td>16-threads</td>
<td>15088</td>
<td>781</td>
</tr>
<tr>
<td>32-threads</td>
<td>28922</td>
<td>1531</td>
</tr>
<tr>
<td>64-threads</td>
<td>56284</td>
<td>2984</td>
</tr>
<tr>
<td>128-threads</td>
<td>110219</td>
<td>5822</td>
</tr>
<tr>
<td>256-threads</td>
<td>199014</td>
<td>10467</td>
</tr>
<tr>
<td>512-threads</td>
<td>391956</td>
<td>20574</td>
</tr>
<tr>
<td>1024-threads</td>
<td>636707</td>
<td>33525</td>
</tr>
<tr>
<td>2048-threads</td>
<td>798184</td>
<td>41921</td>
</tr>
<tr>
<td>4096-threads</td>
<td>800901</td>
<td>41878</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>ycsb</th>
<th>read_50</th>
<th>update_50</th>
</tr>
</thead>
<tbody>
<tr>
<td>1-threads</td>
<td>542</td>
<td>548</td>
</tr>
<tr>
<td>8-threads</td>
<td>2424</td>
<td>2424</td>
</tr>
<tr>
<td>16-threads</td>
<td>4488</td>
<td>4525</td>
</tr>
<tr>
<td>32-threads</td>
<td>8466</td>
<td>8549</td>
</tr>
<tr>
<td>64-threads</td>
<td>16556</td>
<td>16625</td>
</tr>
<tr>
<td>128-threads</td>
<td>31148</td>
<td>31006</td>
</tr>
<tr>
<td>256-threads</td>
<td>54158</td>
<td>54216</td>
</tr>
<tr>
<td>512-threads</td>
<td>57913</td>
<td>57940</td>
</tr>
<tr>
<td>1024-threads</td>
<td>58179</td>
<td>57969</td>
</tr>
</tbody>
</table>
<p>性能工具：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="s">&quot;runtime/pprof&quot;</span>

<span class="kd">func</span> <span class="nx">startCPUProfile</span><span class="p">()</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">f</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="s">&quot;cpu.prof&quot;</span><span class="p">)</span> 
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pprof</span><span class="p">.</span><span class="nx">StartCPUProfile</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">pprof</span><span class="p">.</span><span class="nx">StopCPUProfile</span><span class="p">()</span>
        <span class="nx">f</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// go tool pprof cpu.prof</span>
</code></pre></div>

<h3 id="pebble-scan">pebble-scan</h3>
<div class="highlight"><pre><span></span><code>pebble bench scan --concurrency <span class="m">4</span> --duration 30s data_dir
</code></pre></div>

<p>在这个测试中，将key编码为MVCC的格式如下：</p>
<div class="highlight"><pre><span></span><code>bytes(key) | byte(\x00) | uint64(walltime) | uint32(logical) | 1+8+4

其中walltime和logical都是可选的：
1. bytes(key) | byte(\x00) | uint64(walltime) | 1+8
2. bytes(key) | byte(\x00)
</code></pre></div>

<h2 id="_14">参考</h2>
<ol>
<li><a href="https://github.com/cockroachdb/pebble">https://github.com/cockroachdb/pebble</a></li>
<li><a href="https://github.com/facebook/rocksdb/wiki/rocksdb-basics">https://github.com/facebook/rocksdb/wiki/rocksdb-basics</a></li>
<li><a href="https://github.com/google/leveldb/blob/master/doc/impl.md">https://github.com/google/leveldb/blob/master/doc/impl.md</a> </li>
<li>Bigtable: A Distributed Storage System for Structured Data</li>
<li>The Log-Structured Merge-Tree (LSM-Tree) </li>
<li>FPGA-Accelerated Compactions for LSM-based Key-Value Store </li>
</ol>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="页脚" >
      
        
        <a href="../../translate/taurus_paper/" class="md-footer__link md-footer__link--prev" aria-label="上一页: TaurusDB论文" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              TaurusDB论文
            </div>
          </div>
        </a>
      
      
        
        <a href="../../translate/faunadb_transaction/" class="md-footer__link md-footer__link--next" aria-label="下一页: FaunaDB分布式事务协议" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              FaunaDB分布式事务协议
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2016 - 2021 iswade
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\s\\-\uff0c\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>